---
title: "2021 Q"
author: "Jake Cavaiani"
date: "12/9/2021"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ='America/Anchorage')
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(rio)
library(neonUtilities)
library(raster)
library(data.table)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(imputeTS)
library(itsmr)
library(here)

```

### 2021
Vault, French, and Moose only have data from 6/29 on due to data not being uploaded to the drive before the computer had water damage and lost the data....reminder to ALWAYS BACK UP DATA.
We can try and run a model to apply data from Poker to extrapolate missing water level points at other sites. 

2021 data comes from DoD Project-> 2021 AK sensors -> Discharge->PT->'site'

2021 data was taken using a Wading rod and salt slug dilution and an ADCP at Stuart and Moose one time during the season. 


```{r, include=FALSE, warning=FALSE}
poke.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuPTbgwOrFhhVETrN4HMpVoHrNVwLSecr0acVH7i8ePtxme0PxX1tR_SQ7Mqlg3iiCOHUFw80NFfA5/pub?output=csv"
poke.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgmuOVxwxSfNzLsb76OmrUQhYzl6prnjP17ubO4XV7x0T0bMpUX7jX5itel6oPe3HDCORnoYD25IgU/pub?output=csv"
strt.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBHVco3KO6uDX5ixIteIKLgnLUTe1GIGYK-8WBM2eXn1VWvthOjFIGvmXyVOq3l2vnxiBQQaDzbqE1/pub?output=csv"
strt.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqHls7RlLhnawrL43INl8xLeRLigkYcLhNaUtpHBCN91YmE0rCpNJqBiwvJKp9d0rDapG_UGid43fC/pub?output=csv"
vaul.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSUpdW2ARqdQmnNzpRIbIyGD24DhBSwL5CHFzAG8bwhOsttnyU2nehzfJ0gG8BZHX2VbSc3W1NikCIH/pub?output=csv"
frch.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi6_PAev36hNhtcXdBBQk3pyJqBoQEKpV8tSvtZgz_DPdqXSg93-d_FDomNSH_lkNhb7fJJVloxl1g/pub?output=csv"
frch.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0NaSrjYnUkQC42v448LFY0EZEr98R6a2gH0FpPlMBwpfEDY80rSzbDOP3OfpB-SI4QQBCOMgoQxd2/pub?output=csv"
moos.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVsPDDkXNKBU9Ux2qnvtWl-HS0hgXM2cww9_1l2Xz0Vc9C1_KA2Ss56FuS1fq8mESdgqq2Pl5Nvw6o/pub?output=csv"
moos.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCnhugeQ8EmP9P22kirbLQhPgDwFoPyMmZ4SR05jSHgleJBcUQYjNb3K2w6hGtdu4W-XJixdl8fk6-/pub?output=csv"

# Load Data#
poke.stream.one.2021 <- read.csv(url(poke.stream.2021.url), skip = 1) 
poke.stream.two.2021 <- read.csv(url(poke.stream.2021.url.two), skip = 1)
strt.stream.one.2021 <- read.csv(url(strt.stream.2021.url), skip = 1) # Deployed the 7th of May 
strt.stream.two.2021 <- read.csv(url(strt.stream.2021.url.two), skip = 1) # Deployed the 19th of May
vaul.stream.one.2021 <- read.csv(url(vaul.stream.2021.url), skip = 1)
frch.stream.one.2021 <- read.csv(url(frch.stream.2021.url), skip = 1) # Deployed the 7th of May 
frch.stream.two.2021 <- read.csv(url(frch.stream.2021.url.two), skip = 1) # Deployed the 19th of May
moos.stream.one.2021 <- read.csv(url(moos.stream.2021.url), skip = 1) # Deployed the 7th of May 
moos.stream.two.2021 <- read.csv(url(moos.stream.2021.url.two), skip = 1) # Deployed the 19th of May

# Erase columns that are unneeded
poke.stream.one.2021 <- poke.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
poke.stream.two.2021 <- poke.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

strt.stream.one.2021 <- strt.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
strt.stream.two.2021 <- strt.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

vaul.stream.one.2021 <- vaul.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

frch.stream.one.2021 <- frch.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
frch.stream.two.2021 <- frch.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

moos.stream.one.2021 <- moos.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
moos.stream.two.2021 <- moos.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

# Rename columns 
names(poke.stream.one.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")
names(poke.stream.two.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")

names(strt.stream.one.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")
names(strt.stream.two.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")

names(vaul.stream.one.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")

names(frch.stream.one.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")
names(frch.stream.two.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")

names(moos.stream.one.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")
names(moos.stream.two.2021) <- c("Site", "DateTime", "AbsolutePressure", "WaterLevel")

# Input NAs for time 
poke.stream.one.2021$DateTime[poke.stream.one.2021$DateTime == ""] <- NA
poke.stream.two.2021$DateTime[poke.stream.two.2021$DateTime == ""] <- NA

strt.stream.one.2021$DateTime[strt.stream.one.2021$DateTime == ""] <- NA
strt.stream.two.2021$DateTime[strt.stream.two.2021$DateTime == ""] <- NA

vaul.stream.one.2021$DateTime[vaul.stream.one.2021$DateTime == ""] <- NA

frch.stream.one.2021$DateTime[frch.stream.one.2021$DateTime == ""] <- NA
frch.stream.two.2021$DateTime[frch.stream.two.2021$DateTime == ""] <- NA

moos.stream.one.2021$DateTime[moos.stream.one.2021$DateTime == ""] <- NA
moos.stream.two.2021$DateTime[moos.stream.two.2021$DateTime == ""] <- NA

# Set as AK time 
poke.stream.one.2021$DateTime <- mdy_hms(poke.stream.one.2021$DateTime, tz = "America/Anchorage")
poke.stream.two.2021$DateTime <- mdy_hms(poke.stream.two.2021$DateTime, tz = "America/Anchorage")

strt.stream.one.2021$DateTime <- mdy_hms(strt.stream.one.2021$DateTime, tz = "America/Anchorage")
strt.stream.two.2021$DateTime <- mdy_hms(strt.stream.two.2021$DateTime, tz = "America/Anchorage")

vaul.stream.one.2021$DateTime <- mdy_hms(vaul.stream.one.2021$DateTime, tz = "America/Anchorage")

frch.stream.one.2021$DateTime <- mdy_hms(frch.stream.one.2021$DateTime, tz = "America/Anchorage")
frch.stream.two.2021$DateTime <- mdy_hms(frch.stream.two.2021$DateTime, tz = "America/Anchorage")

moos.stream.one.2021$DateTime <- mdy_hms(moos.stream.one.2021$DateTime, tz = "America/Anchorage") 
moos.stream.two.2021$DateTime <- mdy_hms(moos.stream.two.2021$DateTime, tz = "America/Anchorage")



# Observed discharge
# Import data from google drive #
discharge.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQopx6zhl3WLbG0qJfOtpbsVd6h6M0dOR78mmKMc35CDKnZa88dnrw_kDQg8eklmVV9548gnhJ3XNNo/pub?output=csv"
QSummary.2021 <- read_csv(url(discharge.2021.url))

QSummary.2021$Time[QSummary.2021$Time == ""] <- NA
QSummary.2021$MeasuredQ_Ls[QSummary.2021$MeasuredQ_Ls == " "] <- NA

### Format Time ###
QSummary.2021$Date <- mdy(QSummary.2021$Date)
QSummary.2021$DateTime <- as.POSIXct(paste(QSummary.2021$Date, QSummary.2021$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
QSummary.2021$DateTime <- lubridate::round_date(QSummary.2021$DateTime, "15 minutes")

```

NEON air pressure data
```{r, echo = FALSE, eval = FALSE}
#NEON_air <-loadByProduct(dpID = "DP1.00004.001", 
#                           site=c("BONA"),
#                           startdate="2021-05", 
#                           enddate="2021-11")


NEON_bp <- NEON_air$BP_1min %>% filter(staPresFinalQF != 1)
write.csv(NEON_bp, "NEON_bp_2021.csv")
NEON_bp$DateTimeGMT <- NEON_bp$startDateTime
NEON_bp$DateTime <- NEON_bp$DateTimeGMT
attributes(NEON_bp$DateTime)$tzone <- "America/Anchorage"

NEON_bp %>% ggplot(aes(DateTime, corPres)) + geom_point() # units are kilopascals

moos.stream.one.2021 %>% ggplot(aes(DateTime, AbsolutePressure)) + geom_point(size = 1) + 
  geom_point(data = NEON_bp, aes(DateTime, corPres + 8), color = "dark orange", size = 1)  + 
scale_x_datetime(limits = ymd_hm(c("2021-07-01 00:00", "2021-07-11 23:00"))) +  ylim(107.5,111) + 
  ggtitle("NEON air pressure (orange, value shifted up) compared to water pressure \n read in as AK time for Moose 2021")
```

# Moose
### Raw Moose PT1 
```{r, echo=FALSE, warning=FALSE}
moos.stream.one.2021 %>% ggplot(aes(DateTime, WaterLevel)) + geom_point()
```

Need to clean out of water points at the end of the dataframe...let the cleaning commence!

### Moose PT1 2.0
```{r, echo=FALSE, warning=FALSE}
moos.stream.one.2021 <- moos.stream.one.2021 %>% subset(moos.stream.one.2021$DateTime <= "2021-09-28 13:00") # cleaning data that is before September 28th due to decommission

# Not visited 9/23
#moos.stream.one.2021[c(29908:30000), 4] <- NA

# Shift jump when site visited on 8/11


moos.stream.one.2021 %>% filter(DateTime > "2021-08-09" & DateTime < "2021-08-12") %>% ggplot(aes(DateTime, WaterLevel)) + geom_point()

```
1) removed out of water points during decommission on 9/28/21
2) removed vertical errant points in middle of September

### Raw Moose PT2
```{r, echo=FALSE, warning=FALSE}
#plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
#     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 06:15:00"), tz="America/Anchorage"),
#     ylim = c(20,0), 
#     axes=F, xlab="", ylab="")
#par(new = T)

moos.stream.two.2021 %>% filter(DateTime > "2021-09-22") %>% ggplot(aes(DateTime, WaterLevel)) + geom_point()

```
Need to remove out of water points associated with decommission...let the cleaning commence!

### Moose PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021 <- moos.stream.two.2021 %>% subset(moos.stream.two.2021$DateTime <= "2021-09-28 13:00") # cleaning data that is before September 28th due to decommission

# Site was not visited on 9/23
#moos.stream.two.2021[c(29900:30000), 4] <- NA

plot(moos.stream.two.2021$DateTime, moos.stream.two.2021$WaterLevel, type = 'l')

```

## Export PT data to csv in DoD_Discharge->PT_data->2021
```{r, echo=FALSE, warning=FALSE}
# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-04 09:00", tz = "America/Anchorage"),ymd_hm("2021-09-28 13:00", tz = "America/Anchorage"), by = '15 mins'))
moos.stream.one.2021 <- full_join(moos.stream.one.2021, DateTimeFill)
moos.stream.one.2021 <- moos.stream.one.2021[order(moos.stream.one.2021$DateTime),]
moos.stream.one.2021 <- na_kalman(moos.stream.one.2021, maxgap = 10)

moos.stream.two.2021 <- full_join(moos.stream.two.2021, DateTimeFill)
moos.stream.two.2021 <- moos.stream.two.2021[order(moos.stream.two.2021$DateTime),]
moos.stream.two.2021 <- na_kalman(moos.stream.two.2021, maxgap = 10)

moos.pt.2021 <- rbind(moos.stream.one.2021, moos.stream.two.2021)
write.csv(moos.pt.2021, here("PT_data/2021/MOOS/moos.pt.2021.csv"), row.names = FALSE)
```


## Raw rating curve for MOOS PT1
```{r, echo=FALSE, warning=FALSE}
### Filter MOOS ###
QSummary.MO.2021 <- QSummary.2021 %>% filter(Site =="MOOS")
### Filter Stuart ###
moos.stream.one.2021$Site <- "MOOS"

Moos1comb.2021 <- full_join(moos.stream.one.2021, QSummary.MO.2021, by = "DateTime")

MOOS1.lm.2021 <- lm(Moos1comb.2021$MeasuredQ_Ls ~ Moos1comb.2021$WaterLevel)

moos.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos1 all measured Q") 
``` 

High YSI pints will have to be removed 

### MOOS PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter MOOS ###
QSummary.MO.2021.1 <- QSummary.MO.2021 %>% filter(MeasuredQ_Ls < 1200)

Moos1comb.2021 <- full_join(moos.stream.one.2021, QSummary.MO.2021.1)
MOOS1.lm.2021 <- lm(Moos1comb.2021$MeasuredQ_Ls ~ Moos1comb.2021$WaterLevel)

moos.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos1 all measured Q") 

``` 

1) removed YSI points above 1000 Ls

## Raw rating curve for MOOS PT2
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021$Site <- "MOOS"

Moos2comb.2021 <- full_join(moos.stream.two.2021, QSummary.MO.2021)
MOOS2.lm.2021 <- lm(Moos2comb.2021$MeasuredQ_Ls ~ Moos2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos2 all measured Q")

``` 
Need to remove YSI's

### MOOS PT2
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021$Site <- "MOOS"

Moos2comb.2021 <- full_join(moos.stream.two.2021, QSummary.MO.2021.1)
MOOS2.lm.2021 <- lm(Moos2comb.2021$MeasuredQ_Ls ~ Moos2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos2 all measured Q")

``` 


1) removed YSI points above 1200 Ls

### Predicted Q MOOS PT1
```{r, echo=FALSE, warning=FALSE}
Moos1comb.2021$pred.moos1.Q <- coef(MOOS1.lm.2021)[2] * Moos1comb.2021$WaterLevel+ coef(MOOS1.lm.2021)[1]

ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  #scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("Date") +
  ylab("Discharge (L/s)") 

``` 
Not too shabby

### Predicted Q MOOS PT2
```{r, echo=FALSE, warning=FALSE}
Moos2comb.2021$pred.moos2.Q <- coef(MOOS2.lm.2021)[2] * Moos2comb.2021$WaterLevel+ coef(MOOS2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.moos2.Q), data = Moos2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("") +
  ylab("Discharge(L/s)")

``` 

Not too shabby

### Average predicted Q MOOS 
```{r, echo=FALSE, warning=FALSE}
moos.final.discharge.2021 <- full_join(Moos1comb.2021, Moos2comb.2021, by = "DateTime")
moos.final.discharge.2021$MeanDischarge <- rowMeans(moos.final.discharge.2021[,c("pred.moos1.Q", 'pred.moos2.Q')], na.rm = TRUE) # taking the average of the two PTs
moos.final.discharge.2021 <- moos.final.discharge.2021 %>% dplyr::select(Site.x, DateTime, pred.moos1.Q, pred.moos2.Q, MeanDischarge) # remove unnecesary columns

# Moose1 (light blue) and Moose2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.moos2.Q), data = Moos2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = moos.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 4000) +
  ggtitle("Moose1(light) & Moose2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

``` 
Looks good and red should be exported as a csv

## Export Q data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}

moos.final.discharge.2021_final <- moos.final.discharge.2021 %>% dplyr::select(Site.x, DateTime, MeanDischarge)
moos.final.discharge.2021_final$Site.x <- "MOOS"
names(moos.final.discharge.2021_final) <- c("Site", "DateTime", "Q")

# Round Q to 15 minute interval
moos.final.discharge.2021_final$DateTime <- lubridate::round_date(moos.final.discharge.2021_final$DateTime, "15 minutes")
moos.final.discharge.2021_final <- moos.final.discharge.2021_final %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q, na.rm = TRUE))

# Fill in gaps
moos.final.discharge.2021_final <- moos.final.discharge.2021_final[order(moos.final.discharge.2021_final$DateTime),]
moos.final.discharge.2021_final <- na_kalman(moos.final.discharge.2021_final, maxgap = 10)

write.csv(moos.final.discharge.2021_final, here("Predicted_Discharge/2021/MOOS/MOOS.Q.csv"), row.names = FALSE)
```

# French
### Raw French PT1
```{r, echo=FALSE, warning=FALSE}

plot(frch.stream.one.2021$DateTime, frch.stream.one.2021$WaterLevel, type = 'l')
```

It appears that I need to shift the July data up to what it looks like to the end of July and  take the out of water points associated with decommission out of data frame


### French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.one.2021 <- frch.stream.one.2021 %>% subset(frch.stream.one.2021$DateTime <= "2021-09-28 04:00") # Some ice influence on the 28th

frch.stream.one.2021[12958, 4] - frch.stream.one.2021[12957, 4] #0.568 is the difference 

frch.stream.one.2021.before <- frch.stream.one.2021[-c(12958:31360), ]
frch.stream.one.2021.after <- frch.stream.one.2021[-c(1:12957), ]
frch.stream.one.2021.before$WaterLevel <- frch.stream.one.2021.before[, 4] + 0.568

frch.stream.one.2021.final <- rbind(frch.stream.one.2021.before, frch.stream.one.2021.after)
plot(frch.stream.one.2021.final$DateTime, frch.stream.one.2021.final$WaterLevel)

frch.stream.one.2021 <- frch.stream.one.2021.final

plot(frch.stream.one.2021$DateTime, frch.stream.one.2021$WaterLevel)

```
1) removed out of water points associated with decommission 
2) shifted July data up to the rest of the data set due with cleaning 

### Raw French PT2
```{r, echo=FALSE, warning=FALSE}

plot(frch.stream.two.2021$DateTime, frch.stream.two.2021$WaterLevel)

```

### French PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2021 <- frch.stream.two.2021 %>% subset(frch.stream.two.2021$DateTime <= "2021-09-28 04:00") #  removed on the 28th of september and it appears that there was some ice influence on the 28th 

frch.stream.two.2021[c(12948, 17535,31360,31361), 4] <- NA

frch.stream.two.2021 <- na_kalman(frch.stream.two.2021, maxgap = 10)


plot(frch.stream.two.2021$DateTime, frch.stream.two.2021$WaterLevel, type = 'l')

```

Not too shabby

## Export PT data to csv in DoD_Discharge->PT_data->2021
```{r, echo=FALSE, warning=FALSE}
# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-06-30 03:00", tz = "America/Anchorage"),ymd_hm("2021-09-28 24:00", tz = "America/Anchorage"), by = '15 mins'))
frch.stream.one.2021 <- full_join(frch.stream.one.2021, DateTimeFill)
frch.stream.one.2021 <- na_kalman(frch.stream.one.2021, maxgap = 10)

DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-04 09:00", tz = "America/Anchorage"),ymd_hm("2021-09-28 24:00", tz = "America/Anchorage"), by = '15 mins'))
frch.stream.two.2021 <- full_join(frch.stream.two.2021, DateTimeFill)
frch.stream.two.2021 <- na_kalman(frch.stream.two.2021, maxgap = 10)

frch.pt.2021 <- rbind(frch.stream.one.2021, frch.stream.two.2021) 
frch.pt.2021 <- frch.pt.2021[,-1]
frch.pt.2021$Site <- "FRCH"

write.csv(frch.pt.2021, here("PT_data/2021/FRCH/frch.pt.2021.csv"), row.names = FALSE)
```

### Raw Rating curveFrench PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
QSummary.FR.2021 <- QSummary.2021 %>% filter(Site =="FRCH") %>% filter(Date >= "2021-06-29")
setDT(QSummary.FR.2021)
frch.stream.one.2021 <- setDT(frch.stream.one.2021) %>% filter(!WaterLevel %in% NA)

Frch1comb.2021 <- frch.stream.one.2021[QSummary.FR.2021, on = "DateTime", roll = 'nearest']

### Rating curve for FRCH PT1 ###
Frch1comb.2021$Site <- "FRCH"

frch.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch1 all measured Q") 

```


Lets try averaging measurements by date and remove that medium water level, low measured Q point.
```{r}
Frch1comb.2021.1 <- Frch1comb.2021 %>% filter(MeasuredQ_Ls > 180) %>% group_by(Date) %>% summarise(MeasuredQ_Ls = mean(MeasuredQ_Ls, na.rm = TRUE),
                                                                    WaterLevel = mean(WaterLevel, na.rm = TRUE),
                                                                    DateTime = min(DateTime, na.rm = TRUE))
FRCH1.lm.2021 <- lm(Frch1comb.2021.1$MeasuredQ_Ls ~ Frch1comb.2021.1$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch1comb.2021.1) +
  geom_point( size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch1 all measured Q")
```




### Raw Rating curve French PT2
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
frch.stream.two.2021$Site <- "FRCH"

QSummary.FR.2021.2 <- QSummary.2021 %>% filter(Site =="FRCH")
setDT(QSummary.FR.2021.2)
frch.stream.two.2021 <- setDT(frch.stream.two.2021)

Frch2comb.2021 <- frch.stream.two.2021[QSummary.FR.2021.2, on = "DateTime", roll = 'nearest']




ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch2 all measured Q")


```


Lets try averaging measurements by date and remove that medium water level, low measured Q point and the 4 mid water level, high Q points.
```{r}
Frch2comb.2021.2 <- Frch2comb.2021 %>% filter(Date != "2021-09-28", MeasuredQ_Ls < 450 | WaterLevel > 184.05) %>% group_by(Date) %>% summarise(MeasuredQ_Ls = mean(MeasuredQ_Ls, na.rm = TRUE),
                                                                   WaterLevel = mean(WaterLevel, na.rm = TRUE),
                                                                   DateTime = min(DateTime, na.rm = TRUE))
FRCH2.lm.2021 <- lm(Frch2comb.2021.2$MeasuredQ_Ls ~ Frch2comb.2021.2$WaterLevel)

frch.formula = y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch2comb.2021.2) +
  geom_point( size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch1 measured Q")
```


### Predicted Q FRCH PT1
```{r, echo=FALSE, warning=FALSE}
# PT1 #
frch.stream.one.2021$pred.frch1.Q <- coef(FRCH1.lm.2021)[2] * frch.stream.one.2021$WaterLevel+ coef(FRCH1.lm.2021)[1]

frch.stream.one.2021 <- frch.stream.one.2021 %>% filter(DateTime < "2021-09-26")

ggplot(aes(x = DateTime, y = pred.frch1.Q), data = frch.stream.one.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Frch1comb.2021, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  geom_point(data = Frch1comb.2021.1, aes(x = DateTime, y = MeasuredQ_Ls), size=3, color = "red", shape = 0) +
  theme_classic() +
  ggtitle("French1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 
```

Red points are the averaged points used in the rating curve.

### Predicted Q FRCH PT2
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2021$pred.frch2.Q <- coef(FRCH2.lm.2021)[2] * frch.stream.two.2021$WaterLevel+ coef(FRCH2.lm.2021)[1]

frch.stream.two.2021 %>% 
ggplot(aes(x = DateTime, y = pred.frch2.Q)) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Frch2comb.2021.2, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3, shape = 0, color = "red") +
  geom_point(data = Frch2comb.2021, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("French 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge(L/s)")
```
Not too shabby

### Predicted Q FRCH PT2
```{r, echo=FALSE, warning=FALSE}
frch.final.discharge.2021 <- full_join(frch.stream.one.2021, frch.stream.two.2021, by = "DateTime")
frch.final.discharge.2021$MeanDischarge <- rowMeans(frch.final.discharge.2021[,c ("pred.frch1.Q", 'pred.frch2.Q')], na.rm = TRUE) # taking the average of the two PTs


# French1 (light blue) and French2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.frch1.Q), data = frch.final.discharge.2021) +
  geom_line(aes(x = DateTime, y = pred.frch1.Q), data = frch.final.discharge.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.frch2.Q), data = frch.final.discharge.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = frch.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(data =Frch2comb.2021, aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 1500) +
  ggtitle("French1(light) & French2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")
```

Red should be exported as a csv

## Export Q data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}
frch.final.discharge.2021_final <- frch.final.discharge.2021 %>% dplyr::select(DateTime, MeanDischarge)
frch.final.discharge.2021_final$Site <- "FRCH"
names(frch.final.discharge.2021_final) <- c( "DateTime", "Q", "Site")

# Round Q to 15 minute interval
frch.final.discharge.2021_final$DateTime <- lubridate::round_date(frch.final.discharge.2021_final$DateTime, "15 minutes")
frch.final.discharge.2021_final <- frch.final.discharge.2021_final %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q, na.rm = TRUE))

# Fill in gaps
frch.final.discharge.2021_final <- frch.final.discharge.2021_final[order(frch.final.discharge.2021_final$DateTime),]
frch.final.discharge.2021_final <- na_kalman(frch.final.discharge.2021_final, maxgap = 10)

write.csv(frch.final.discharge.2021_final, here("Predicted_Discharge/2021/FRCH/FRCH.Q.csv"), row.names = FALSE)
```


### Raw Poker PT1
```{r, echo=FALSE, warning=FALSE}
#plot(POKE_RainGauge_2021$inst_rainfall_mm ~ POKE_RainGauge_2021$DateTime, type="h",
#     xlim = as.POSIXct(c("2021-05-06 09:00:00","2021-09-29 06:25:00"), tz="America/Anchorage"),
#     ylim = c(20,0), 
#     axes=F, xlab="", ylab="")
#par(new = T)

poke.stream.one.2021 %>% ggplot(aes(DateTime, WaterLevel)) + geom_point() #+ geom_point(data = NEON_bp, aes(DateTime, corPres-5))
```

2 beaver dams in July and one in the beginning of september....let the cleaning commence!


### Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.one.2021[c(5957:7397, 8261:9773,17247,23665:25616), 4] <- NA

# Shift jump on August 16
216.296 - 216.118 # 0.178
poke.stream.one.2021 <- poke.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime >= "2021-08-16 06:50:00", WaterLevel - 0.178,.))) 
poke.stream.one.2021 <- poke.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime > "2021-08-16" & DateTime < "2021-08-16 06:50:00" & WaterLevel > 216.125, NA,.)))

poke.stream.one.2021 %>% #filter(DateTime < "2021-05-20") %>% 
  #filter(DateTime > "2021-08-16" & DateTime < "2021-08-17") %>%
  ggplot(aes(DateTime, WaterLevel)) + geom_point()

```


1) Removed beaver dam raise in water level in the beginning, middle of July and beginning of September
2) Shifted the middle of August


### Raw Poker PT2
```{r, echo=FALSE, warning=FALSE}

plot(poke.stream.two.2021$DateTime, poke.stream.two.2021$WaterLevel)

```

Out of water point in June, beaver dams....let the cleaning commence!

### Poker PT2 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2021[c(3725, 5957:7175,7973:9145,17247,23733:25600), 4] <- NA

poke.stream.two.2021 <- na_kalman(poke.stream.two.2021, maxgap = 10)
poke.stream.two.2021 %>% #filter(DateTime < "2021-05-20") %>% 
  filter(DateTime > "2021-06-21" & DateTime < "2021-06-25") %>%
  ggplot(aes(DateTime, WaterLevel)) + geom_point()

```


1) Removed beaver dam raise in water level in the beginning, middle of July and beginning of September
2) check the middle of August

## Export PT data to csv in DoD_Discharge->PT_data->2021
```{r, echo=FALSE, warning=FALSE}
# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-06 09:00", tz = "America/Anchorage"),ymd_hm("2021-09-29 06:30", tz = "America/Anchorage"), by = '15 mins'))
poke.stream.one.2021 <- full_join(poke.stream.one.2021, DateTimeFill)
poke.stream.one.2021 <- na_kalman(poke.stream.one.2021, maxgap = 10)

DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-06 09:00", tz = "America/Anchorage"),ymd_hm("2021-09-29 06:30", tz = "America/Anchorage"), by = '15 mins'))
poke.stream.two.2021 <- full_join(poke.stream.two.2021, DateTimeFill)
poke.stream.two.2021 <- na_kalman(poke.stream.two.2021, maxgap = 10)

poke.pt.2021 <- rbind(poke.stream.one.2021, poke.stream.two.2021)
poke.pt.2021 <- poke.pt.2021[,-1]
poke.pt.2021$Site <- "POKE"
write.csv(poke.pt.2021, here("PT_data/2021/POKE/poke.pt.2021.csv"), row.names = FALSE)
```


### Raw Rating curve Poker PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
QSummary.PO.2021 <- QSummary.2021 %>% filter(Site =="POKE")


# trying to merge by nearest date if we have an offset point 
poke.stream.one.2021.dt <- setDT(poke.stream.one.2021)
QSummary.PO.2021.dt <- setDT(QSummary.PO.2021)

Poke1comb.2021 <- poke.stream.one.2021.dt[QSummary.PO.2021.dt, on = "DateTime", roll = 'nearest']



### Rating curve for POKE PT1 ###
poke.stream.one.2021$Site <- "POKE"

Poke1comb.2021 <- full_join(poke.stream.one.2021, QSummary.PO.2021, by = "DateTime")
POKE1.lm.2021 <- lm(Poke1comb.2021$MeasuredQ_Ls ~ Poke1comb.2021$WaterLevel)


poke.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poke1 all measured Q") 

```



### Rating curve Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
QSummary.PO.2021.1 <- QSummary.PO.2021[-c(1,2,11,24), ]


Poke1comb.2021 <- full_join(poke.stream.one.2021, QSummary.PO.2021.1, by = "DateTime")
POKE1.lm.2021 <- lm(Poke1comb.2021$MeasuredQ_Ls ~ Poke1comb.2021$WaterLevel)


poke.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poke1 all measured Q") 


```

1) Removed highest YSI and 
2) Removed lowest Wading rods 

### Raw Rating curve Poker PT2
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2021$Site <- "POKE"

Poke2comb.2021 <- full_join(poke.stream.two.2021, QSummary.PO.2021)
POKE2.lm.2021 <- lm(Poke2comb.2021$MeasuredQ_Ls ~ Poke2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poker2 all measured Q")
```

I will remove highest YSI and lowest wading rods 

### Rating curve Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###

Poke2comb.2021 <- full_join(poke.stream.two.2021, QSummary.PO.2021.1)
POKE2.lm.2021 <- lm(Poke2comb.2021$MeasuredQ_Ls ~ Poke2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poker2 all measured Q")


```

1) Removed highest YSI and 
2) Removed lowest Wading rods 

### Predicted Q for POKE PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
Poke1comb.2021$pred.poke1.Q <- coef(POKE1.lm.2021)[2] * Poke1comb.2021$WaterLevel+ coef(POKE1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 

```
Not the prettiest thing I have ever seen 


### Predicted Q for POKE PT2
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
Poke2comb.2021$pred.poke2.Q <- coef(POKE2.lm.2021)[2] * Poke2comb.2021$WaterLevel+ coef(POKE2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylim(0, 1500) +
  ylab("Discharge(L/s)")

```
Looks better then PT1...snowmelt signature looks good 


### Average Q for POKE 
```{r, echo=FALSE, warning=FALSE}

poke.final.discharge.2021 <- full_join(Poke1comb.2021, Poke2comb.2021, by = "DateTime")
poke.final.discharge.2021$MeanDischarge <- rowMeans(poke.final.discharge.2021[,c ("pred.poke1.Q", 'pred.poke2.Q')], na.rm = TRUE) # taking the average of the two PTs
poke.final.discharge.2021 <- poke.final.discharge.2021 %>% dplyr::select(Site.x, DateTime, pred.poke2.Q, pred.poke1.Q, MeanDischarge)

# Poker1 (light blue) and Poker2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 1500) +
  ggtitle("Poker1(light) & Poker2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```

I think I should clip off the beginning of PT1 as the snowmelt signature makes more sense in PT2...what do you think?

Lets use PT2 before May 20th and PT1 only after September 5th.
```{r}
poke.final.discharge.2021.2 <- poke.final.discharge.2021 %>% mutate(across(c(MeanDischarge), ~ifelse(DateTime < "2021-05-20", pred.poke2.Q,.)))

poke.final.discharge.2021.2 <- poke.final.discharge.2021.2 %>% mutate(across(c(MeanDischarge), ~ifelse(DateTime > "2021-09-05", pred.poke1.Q,.)))

# Poker1 (light blue) and Poker2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2021.2, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 1500) +
  ggtitle("Poker1(light) & Poker2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")
```

## Export Q data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}
poke.final.discharge.2021_final <- poke.final.discharge.2021.2 %>% dplyr::select(DateTime, MeanDischarge)
poke.final.discharge.2021_final$Site <- "POKE"
names(poke.final.discharge.2021_final) <- c("DateTime", "Q", "Site")

# Round Q to 15 minute interval
poke.final.discharge.2021_final$DateTime <- lubridate::round_date(poke.final.discharge.2021_final$DateTime, "15 minutes")
poke.final.discharge.2021_final <- poke.final.discharge.2021_final %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q, na.rm = TRUE))

# Fill in gaps
poke.final.discharge.2021_final <- poke.final.discharge.2021_final[order(poke.final.discharge.2021_final$DateTime),]
poke.final.discharge.2021_final <- na_kalman(poke.final.discharge.2021_final, maxgap = 10)

write.csv(poke.final.discharge.2021_final, here("Predicted_Discharge/2021/POKE/POKE.Q.csv"), row.names = FALSE)
```


### Raw Vault PT1
```{r, echo=FALSE, warning=FALSE}
plot(vaul.stream.one.2021$DateTime, vaul.stream.one.2021$WaterLevel, type = 'l')

```


Need to remove vertical bars associated with out of water points such as the beginning and the end of the dataframe 

### Vault PT1 2.0 
```{r, echo=FALSE, warning=FALSE}
vaul.stream.one.2021[c(4777:4994, 16861, 30756:30759), 4] <- NA
vaul.stream.one.2021 <- na_kalman(vaul.stream.one.2021, maxgap = 10)

plot(vaul.stream.one.2021$DateTime, vaul.stream.one.2021$WaterLevel, type = 'l')

```

1) Removed vertical bars errant points in the beginning of the dataframe as well the middle of the first big storm and the end of the dataframe 

## Export PT data to csv in DoD_Discharge->PT_data->2021
```{r, echo=FALSE, warning=FALSE}
# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-06-30 05:10", tz = "America/Anchorage"),ymd_hm("2021-09-27 16:10", tz = "America/Anchorage"), by = '15 mins'))
vaul.stream.one.2021 <- full_join(vaul.stream.one.2021, DateTimeFill)
vaul.stream.one.2021 <- na_kalman(vaul.stream.one.2021, maxgap = 10)

write.csv(vaul.stream.one.2021, here("PT_data/2021/VAUL/vaul.pt.2021.csv"), row.names = FALSE)
```

### Raw VAUL rating curve 
```{r, echo=FALSE, warning=FALSE}
### Filter VAUL ###
QSummary.VA.2021 <- QSummary.2021 %>% filter(Site =="VAUL")

### Rating curve for VAUL PT1 ###
vaul.stream.one.2021$Site <- "VAUL"

Vaul1comb.2021 <- full_join(vaul.stream.one.2021, QSummary.VA.2021)
VAUL1.lm.2021 <- lm(Vaul1comb.2021$MeasuredQ_Ls ~ Vaul1comb.2021$WaterLevel)

vaul.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Vaul1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = vaul.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Vaul1 all measured Q") 

```
Best raw one yet!

### Predicted Q for VAUL
```{r, echo=FALSE, warning=FALSE}
Vaul1comb.2021$pred.vaul1.Q <- coef(VAUL1.lm.2021)[2] * Vaul1comb.2021$WaterLevel+ coef(VAUL1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.vaul1.Q), data = Vaul1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Vaul1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 

```
Not too shabby

## Export Q data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}
vaul.final.discharge.2021_final <- Vaul1comb.2021 %>% dplyr::select(Site, DateTime, pred.vaul1.Q)
names(vaul.final.discharge.2021_final) <- c("Site", "DateTime", "Q")

# Round Q to 15 minute interval
vaul.final.discharge.2021_final$DateTime <- lubridate::round_date(vaul.final.discharge.2021_final$DateTime, "15 minutes")
vaul.final.discharge.2021_final <- vaul.final.discharge.2021_final %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q, na.rm = TRUE))

# Fill in gaps
vaul.final.discharge.2021_final <- vaul.final.discharge.2021_final[order(vaul.final.discharge.2021_final$DateTime),]
vaul.final.discharge.2021_final <- na_kalman(vaul.final.discharge.2021_final, maxgap = 10)


write.csv(vaul.final.discharge.2021_final, here("Predicted_Discharge/2021/VAUL/VAUL.Q.csv"), row.names = FALSE)
```

### Raw STRT PT1
```{r, echo=FALSE, warning=FALSE}
#strt.stream.one.2021.b <- strt.stream.one.2021

strt.stream.one.2021 %>% #filter(DateTime > "2021-07-02") %>% 
  ggplot(aes(DateTime, WaterLevel)) + geom_point(data= frch.stream.one.2021.final, aes(DateTime, WaterLevel + 65.97), col = "blue") + #geom_point(data= moos.stream.one.2021, aes(DateTime, WaterLevel + 84.5), col = "green") + 
  geom_point()
```

Need to shift beginning of dataframe up and remove beaverr dam in July...remove errant vertical bars 


### STRT PT1 2.0
```{r, echo=FALSE, warning=FALSE}
#strt.stream.one.2021 <- strt.stream.one.2021.b

strt.stream.one.2021[5261, 4] - strt.stream.one.2021[5257, 4] # 0.543

strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime <= "2021-06-28 11:00:00", WaterLevel + 0.543,. )))

# First beaver damn
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime > "2021-06-28 11:00:00" & DateTime < "2021-07-16 12:40:00", NA,. )))

# Second beaver damn
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime > "2021-07-20 19:00" & DateTime < "2021-07-28 11:50", NA,. )))


# Remove beaver dam at beginning of August
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime > "2021-08-02 15:00" & DateTime < "2021-08-04" & WaterLevel > 250.67, NA, .)))
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime > "2021-08-02" & DateTime < "2021-08-10" & WaterLevel < 250.2, NA, .)))


# Small shift
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime >= "2021-08-03", WaterLevel + .05, .)))
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime >= "2021-08-03" & DateTime <= "2021-08-03 12:15", NA, .))) %>% filter(WaterLevel > 250.5)

# Fieldbook says that beaver damn was removed 8/9
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime > "2021-08-09" & DateTime < "2021-08-10" & WaterLevel > 250.77, NA, .)))
strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime > "2021-08-09 06:00" & DateTime < "2021-08-09 11:15", NA, .)))

strt.stream.one.2021 <- strt.stream.one.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(WaterLevel > 251.3, NA, .)))

strt.stream.one.2021 %>% #filter(DateTime > "2021-06-15" & DateTime < "2021-08-15") %>% 
  ggplot(aes(DateTime, WaterLevel)) + geom_point(data= frch.stream.one.2021.final, aes(DateTime, WaterLevel + 65.97), col = "blue") + geom_point() #+ scale_x_datetime(limits = ymd_h(c("2021-07-25 06", "2021-08-21 23"), tz = "America/Anchorage")) + ylim(250.5,250.8)
```

1) Removed errant vertical bar points
2)Removed beaver dam raises in Water level 
Quick snowmelt period and then not a lot of waterlevel change in June. 

### Raw STRT PT2
```{r, echo=FALSE, warning=FALSE}

strt.stream.two.2021 %>% #filter(DateTime > "2021-08-02" & DateTime < "2021-08-04") %>%
  ggplot(aes(DateTime, WaterLevel)) + geom_point()

```

### STRT PT2 2.0
```{r, echo=FALSE, warning=FALSE}
#strt.stream.two.2021.b <- strt.stream.two.2021
#strt.stream.two.2021 <- strt.stream.two.2021.b

# Shift down first section
strt.stream.two.2021 <- strt.stream.two.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime <= "2021-06-28 11:00:00", WaterLevel - 0.282,. )))

strt.stream.two.2021[5257,4] <- NA

# First beaver damn
strt.stream.two.2021 <- strt.stream.two.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime > "2021-06-28 11:00:00" & DateTime < "2021-07-16 12:40:00", NA,. )))

# Second beaver damn
strt.stream.two.2021 <- strt.stream.two.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime > "2021-07-20 19:00" & DateTime < "2021-07-28 11:50", NA,. )))


# Remove beaver dam at beginning of August
strt.stream.two.2021 <- strt.stream.two.2021 %>% mutate(across(c(WaterLevel), ~ ifelse(DateTime > "2021-08-02 17:30" & DateTime <= "2021-08-03 12:00", NA, .)))


# Shift jump on 8/9
strt.stream.two.2021 <- strt.stream.two.2021 %>% mutate(across(c(WaterLevel), ~ifelse(DateTime >= "2021-08-09 11:15:00", WaterLevel - 0.225,. )))
strt.stream.two.2021[c(17349:17355),4] <- NA

strt.stream.two.2021 %>% ggplot(aes(DateTime, WaterLevel))   + #+ geom_point(data = strt.stream.one.2021, aes(DateTime, WaterLevel), color = 2) + geom_point(data = strt.stream.two.2021.b, aes(DateTime, WaterLevel), color = "blue")
  geom_point(data= frch.stream.one.2021.final, aes(DateTime, WaterLevel + 64.95), color = 2)+
  geom_point() #+ scale_x_datetime(limits = ymd_h(c("2021-08-07 06", "2021-08-20 23"), tz = "America/Anchorage")) #+ ylim(249.5,249.8)


```

1) removed beaver dams
2) removed errant vertical bars
3) shifted middle of july to middle of August 

## Export PT data to csv in DoD_Discharge->PT_data->2021
```{r, echo=FALSE, warning=FALSE}
# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-07 17:00", tz = "America/Anchorage"),ymd_hm("	
2021-09-28 10:30", tz = "America/Anchorage"), by = '15 mins'))
strt.stream.one.2021 <- full_join(strt.stream.one.2021, DateTimeFill)
strt.stream.one.2021 <- na_kalman(strt.stream.one.2021, maxgap = 15)

# Add any missing time steps
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2021-05-19 17:00", tz = "America/Anchorage"),ymd_hm("2021-09-28 10:30", tz = "America/Anchorage"), by = '15 mins'))
strt.stream.two.2021 <- full_join(strt.stream.two.2021, DateTimeFill)
strt.stream.two.2021 <- na_kalman(strt.stream.two.2021, maxgap = 10)

strt.pt.2021 <- rbind(strt.stream.one.2021, strt.stream.two.2021)
write.csv(strt.pt.2021, here("PT_data/2021/STRT/strt.pt.2021.csv"), row.names = FALSE)
```

### Raw STRT rating curve 
```{r, echo=FALSE, warning=FALSE}
### Filter STRT ###
QSummary.ST.2021 <- QSummary.2021 %>% filter(Site =="STRT")

strt.stream.one.2021.dt <- setDT(strt.stream.one.2021) %>% filter(!WaterLevel %in% NA)
QSummary.ST.2021.dt <- setDT(QSummary.ST.2021)
Strt1comb.2021 <- strt.stream.one.2021.dt[QSummary.ST.2021.dt, on = "DateTime", roll = 'nearest'] %>% dplyr::select(DateTime, WaterLevel, MeasuredQ_Ls, Method, Date) 

### Rating curve for STRT PT1 ###
strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic()
  ggtitle("Strt1 all measured Q") 

```


I will remove some YSI points, and lowest wadinging rod and ADCP point.
### STRT rating curve 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter STRT ###
Strt1comb.2021.1 <- Strt1comb.2021[-c(1,2,3,22,8,10),]
STRT1.lm.2021 <- lm(Strt1comb.2021.1$MeasuredQ_Ls ~ Strt1comb.2021.1$WaterLevel)

strt.formula <- y ~ x
ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2021.1) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic()
  ggtitle("Strt1 all measured Q") 

```

### Raw STRT rating curve PT2
```{r, echo=FALSE, warning=FALSE}

strt.stream.two.2021.dt <- setDT(strt.stream.two.2021) %>% filter(!WaterLevel %in% NA)
Strt2comb.2021 <- strt.stream.two.2021.dt[QSummary.ST.2021.dt, on = "DateTime", roll = 'nearest'] %>% dplyr::select(DateTime, WaterLevel, MeasuredQ_Ls, Method, Date) 


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() + ylim(0,1600)
  ggtitle("Stuart2 all measured Q")

```


### STRT rating curve PT2 2.0
```{r, echo=FALSE, warning=FALSE}

Strt2comb.2021.1 <- Strt2comb.2021[-c(1,2,3,22,8,10),]
STRT2.lm.2021 <- lm(Strt2comb.2021.1$MeasuredQ_Ls ~ Strt2comb.2021.1$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2021.1) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```

### Predicted Q STRT PT1
```{r, echo=FALSE, warning=FALSE}

strt.stream.one.2021$pred.strt1.Q <- coef(STRT1.lm.2021)[2] * strt.stream.one.2021$WaterLevel+ coef(STRT1.lm.2021)[1]

strt.stream.one.2021 %>% #filter(DateTime > "2021-07-30" & DateTime < "2021-08-15") %>% 
  ggplot(aes(x = DateTime, y = pred.strt1.Q)) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Strt1comb.2021, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") #+ geom_point(data = frch.test, aes(DateTime, pred.frch1.Q))
```
Icky

### Predicted Q STRT PT2
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2021$pred.strt2.Q <- coef(STRT2.lm.2021)[2] * strt.stream.two.2021$WaterLevel+ coef(STRT2.lm.2021)[1]

ggplot(aes(x = DateTime, y = pred.strt2.Q), data = strt.stream.two.2021) +
  geom_point(color="#A6CEE3", size=1.25) +
  geom_point(data=Strt2comb.2021, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("") +
  #ylim(0, 2000) +
  ylab("Discharge(L/s)") #+ geom_point(data = frch.final.discharge.2021_final, aes(DateTime, Q))


```
Icky

### Average Q for STRT
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2021 <- full_join(strt.stream.one.2021, strt.stream.two.2021, by = "DateTime")
strt.final.discharge.2021$MeanDischarge <- rowMeans(strt.final.discharge.2021[,c ("pred.strt1.Q", 'pred.strt2.Q')], na.rm = TRUE) # taking the average of the two PTs
strt.final.discharge.2021 <- strt.final.discharge.2021 %>% dplyr::select(Site.y, DateTime, pred.strt1.Q, pred.strt2.Q, MeanDischarge) # remove unnecesary columns


# Stuart1 (light blue) and Stuart2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.strt1.Q), data = strt.final.discharge.2021) +
  geom_point(aes(x = DateTime, y = pred.strt1.Q), data = strt.final.discharge.2021, color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = pred.strt2.Q), data = strt.final.discharge.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_point(aes(x = DateTime, y = MeanDischarge), data = strt.final.discharge.2021, color = "red", size = 0.25, alpha = 0.25) +
  geom_point(data=Strt2comb.2021, aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("STRT1(light) & STRT2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")


```

ICKY
Lets only use PT1 before July.

```{r}
strt.final.discharge.2021 <- strt.final.discharge.2021 %>% mutate(across(c(MeanDischarge), ~ifelse(DateTime < "2021-07-05", pred.strt1.Q,.)))

# Stuart1 (light blue) and Stuart2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.strt1.Q), data = strt.final.discharge.2021) +
  geom_point(aes(x = DateTime, y = pred.strt1.Q), data = strt.final.discharge.2021, color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = pred.strt2.Q), data = strt.final.discharge.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_point(aes(x = DateTime, y = MeanDischarge), data = strt.final.discharge.2021, color = "red", size = 0.25, alpha = 0.25) +
  geom_point(data=Strt2comb.2021, aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("STRT1(light) & STRT2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```

## Export Q data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2021_final <- strt.final.discharge.2021 %>% dplyr::select(Site.y, DateTime, MeanDischarge)
strt.final.discharge.2021_final$Site.y <- rep("STRT", length(strt.final.discharge.2021_final$Site.y))
names(strt.final.discharge.2021_final) <- c("Site", "DateTime", "Q")

# Round Q to 15 minute interval
strt.final.discharge.2021_final$DateTime <- lubridate::round_date(strt.final.discharge.2021_final$DateTime, "15 minutes")
strt.final.discharge.2021_final <- strt.final.discharge.2021_final %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q, na.rm = TRUE))

# Fill in gaps
strt.final.discharge.2021_final <- strt.final.discharge.2021_final[order(strt.final.discharge.2021_final$DateTime),]
strt.final.discharge.2021_final <- strt.final.discharge.2021_final %>% mutate(across(c(Q), ~ifelse(Q == "NaN", NA, .)))
strt.final.discharge.2021_final$Q <- na_kalman(strt.final.discharge.2021_final$Q, maxgap = 10)

write.csv(strt.final.discharge.2021_final, here("Predicted_Discharge/2021/STRT/STRT.Q.csv"), row.names = FALSE)
```

## Export PT data to csv in DoD_Discharge->Predicted_discharge->2021
```{r, echo=FALSE, warning=FALSE}
Q_2021 <- rbind(moos.final.discharge.2021_final, frch.final.discharge.2021_final,
                poke.final.discharge.2021_final, vaul.final.discharge.2021_final,
                strt.final.discharge.2021_final)

Q_2021 <- Q_2021 %>% mutate(across(c(Q), ~ifelse(Q == "NaN", NA, .)))

write.csv(Q_2021, here("Predicted_Discharge/2021/Q_2021.csv"), row.names = FALSE)

Q_2021$Day = format(as.POSIXct(Q_2021$DateTime,format="%Y-%m-%d %H:%M:%S"),format="%Y-%m-%d")
Q_2021$Day = as.POSIXct(Q_2021$Day, "%Y-%m-%d", tz="America/Anchorage")
Q.daily.2021 <- Q_2021 %>% group_by(Day, Site) %>% summarise(Q = mean(Q))

write.csv(Q.daily.2021, here("Predicted_Discharge/2021/Q.daily.2021.csv"), row.names = FALSE)

# Plot
Q_2021 %>%  #filter(Site == "STRT") %>% 
  #filter(DateTime > "2021-09-22")%>%
  ggplot(aes(DateTime, Q, color = Site)) + geom_point(size = 0.25)

# Check time step intervals
Q_2021_check <- Q_2021 %>% group_by(Site) %>%
   summarise(diff = DateTime - lag(DateTime), DateTime = DateTime)
unique(Q_2021_check$diff)

Q_2021_check %>% ggplot(aes(DateTime, diff, color = Site)) + geom_point()# + ylim(0,60)

# Check length of consecutive NA's
Q_2021_check_NA <- Q_2021 %>% mutate(Yes_NA = ifelse(Q %in% NA, "Y", "N"))

Q_2021_check_NA %>% #filter(Site == "STRT") %>%
  ggplot(aes(DateTime, Yes_NA)) + geom_point(size = 0.5) + facet_wrap(~Site)
```













