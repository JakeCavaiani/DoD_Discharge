---
title: "2015_Q"
author: "Jake Cavaiani"
date: "9/22/2022"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ='America/Anchorage')
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(rio)
library(neonUtilities)
library(raster)
library(data.table)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(imputeTS)
library(itsmr)

```

## French and Moose 2015 Discharge

The purpose of this script is to import raw PT data from each of our sites in 2015 (Moose, French), clean (out of water points, potential beaver dams, noisy data, remove a PT if data is bad etc.) and prepare to convert to continuous predicted discharge (Q)

Important NOTES:
1) Water level data is obtained from HOBO pressure transducers (PTs) that were installed in PVC pipes in streams, with the PT sitting on top of a rebar piece at bottom of pipe. Raw pressure from PTs were processed in HOBOware to correct for atmospheric pressure to get water depth. Atmospheric pressure was obtained from a PT installed at each site in a tree. HOWEVER, water depth is absolute PT depth, NOT actual water depth. To get actual water depth, we need a reference water depth from a time point in the water depth time series that is an accurate measure of the depth of the pt from the water surface. We do not have these (depth measurements from flow meter measurements were not done sufficiently close to PT locations to use).We have waterlevel surveys from Kate Broberg in 2020 and 2021  We must therefore rely on the rating curve to convert absolute water depth to continuous Q.

2) Date/time from HOBOware data is GMT-8, which is Alaska Daylight Time, which is the correct timezone for this project in summer (AK is in GMT-9 March-November when daylight savings is not observed). Data/time therefore needs to be formatted but not timezone-converted.

Step 1: import raw data hoboware files which is site, datetime, absolute pressure and water level
Step 2: Clean errant points within the data that could be due to installation/decommission or gaps in data
Step 3: Write final output of cleaned site, datetime, absolute pressure and water level
Step 4: import Qsummary document to generate rating curves of Q and pressure
Step 5: clean errant points in regression
Step 6: apply rating curve to generate continuous predicted discharge at each site
Step 7: Output final discharge as csv.

2015 data is read from DoD->2015 AK sensors->Discharge->discharge->pressure transducer-> "PT_Site_Compiled"
2015 data was taken att 5 minute intervals

```{r, include=FALSE, warning=FALSE}
# Import processed Q data
moos.stream.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTng8WWrBVNB4uN7DHZuq1EfBn8tZ7qA71F7J-2izJUgeTU34LMbyXd_si8ezwscQ/pub?output=csv"
frch.stream.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2WNuEj8PTKLO6OkySK--koXwL6h_f3_WmctQTWkTlyB7boYmX1GmbT1HiVle6nA/pub?output=csv"

moos.stream <- read.csv(url(moos.stream.url), skip = 1)
frch.stream <- read.csv(url(frch.stream.url), skip = 1)
moos.stream <- moos.stream[,-c(3:4)] # Remove Na columns
frch.stream <- frch.stream[,-c(3:4)] # Remove Na columns

# Import summary notes from field book
discharge.2015 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQC9Bk0nS-Cx4Ec8MyLHd2xNuSv8JTobR8SSV_ODQHAvp4cUK8k3z9EmOs/pub?output=csv"
QSummary <- read.csv(url(discharge.2015))

# Import rain gauge data #
caribou.2015.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSolN8YGaUlUlcQjw9EaklcgcJu3b5L80X8Y-xX_ePg-CDOzZ07LDpl-aGBYvLwnvIhLB8Gm5Q66BWk/pub?output=csv"

caribou.2015.gauge <- read.csv(url(caribou.2015.url), skip = 4)
names(caribou.2015.gauge) <- c("DateTimeGMT", "Precip")
caribou.2015.gauge$DateTimeGMT[caribou.2015.gauge$DateTimeGMT == ""] <- NA
caribou.2015.gauge$DateTimeAK = as.POSIXct(caribou.2015.gauge$DateTimeGMT, "%m/%d/%y %H:%M", tz="America/Anchorage")

# Rename columns #
names(moos.stream) <- c("Date", "AbsolutePressure")
names(frch.stream) <- c("Date", "AbsolutePressure")

#Convert time and put in AK time 
moos.stream$DateTimeAK <- mdy_hm(moos.stream$Date, tz = "America/Anchorage")
frch.stream$DateTimeAK <- mdy_hm(frch.stream$Date, tz = "America/Anchorage")


QSummary$date <- mdy(QSummary$date)
QSummary$DateTimeAK <- as.POSIXct(paste(QSummary$date, QSummary$time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
```

### Observed Discharge at French and Moose

Slugs were the only method of discharge for 2015 

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
# ALL Sites #
all <- ggplot(QSummary) +
  geom_point(aes(x=date, y=Q..L.s., color=site), size=3) +
  scale_color_manual(values=c("#FF7F00","#A6761D")) +
  theme_classic() +
  ggtitle("ALL SITES")
all

#a <- QSummary %>% filter(site == "Moose") %>% 
#  ggplot() +
#  geom_point(aes(x=date, y=Q..L.s., color = site), size=3) +
#  scale_color_manual(values=c("#A6761D")) +
#  theme_classic() +
#  ggtitle("Moose")
#a

#b <- QSummary %>% filter(site == "French") %>% 
#  ggplot() +
#  geom_point(aes(x=date, y=Q..L.s., color = site), size=3) +
#  scale_color_manual(values=c("#FF7F00")) +
#  theme_classic() +
#  ggtitle("French")
#b

#plot_grid(all, NA,
#          a, b,
#          nrow = 2, ncol = 2)
```
This is from the DOD Q Summary csv that is DoD Project->2015 AK sensors ->Discharge

```{r}
eielson.atmo.2015.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSx5CyMTHZWjvTaYfNQcDZw7U59URY8v6PSJvH4bGwjtSkbD0picwdOJCyBqg3_BGcjwHztwT0b1sQT/pub?output=csv"

eielson.atmo.2015 <- read.csv(url(eielson.atmo.2015.url), skip = 6) 
eielson.atmo.2015 <- eielson.atmo.2015[-1,]

names(eielson.atmo.2015) <- c("Site", "DateTimeAK", "sea_level_pressure", "1_day")

eielson.atmo.2015$DateTimeAK <- mdy_hm(eielson.atmo.2015$DateTimeAK)

eielson.atmo.2015$DateTimeAK <- force_tz(eielson.atmo.2015$DateTimeAK, "America/Anchorage")

eielson.atmo.2015$DateTimeAK <- lubridate::round_date(eielson.atmo.2015$DateTimeAK, "15 minutes")


eielson.atmo.2015$AirPressure <- as.numeric(eielson.atmo.2015$sea_level_pressure)
eielson.atmo.2015$sea_level_pressure <- as.numeric(eielson.atmo.2015$sea_level_pressure)

eielson.atmo.2015$AirPressure <- eielson.atmo.2015$AirPressure*3.38639 # converting from inHG to kPa

eielson.atmo.2015 <- subset(eielson.atmo.2015, DateTimeAK > "2015-05-01" & DateTimeAK < "2015-10-31")

# correcting for elevation 
eielson.atmo.2015$mmHG <- eielson.atmo.2015$sea_level_pressure * 25.44 # converting to mmHG

# conversion to elevation at each site 
# MOOS 
eielson.atmo.2015$mmHGcorrectedMOOS <- eielson.atmo.2015$mmHG - (2.5*574/100) 

eielson.atmo.2015$AirPressureCorrectedMOOS <- eielson.atmo.2015$mmHGcorrectedMOOS * 0.133322 # converting this to kPA to compare with MOOS PT

# FRCH
eielson.atmo.2015$mmHGcorrectedFRCH <- eielson.atmo.2015$mmHG - (2.5*601/100) 

eielson.atmo.2015$AirPressureCorrectedFRCH <- eielson.atmo.2015$mmHGcorrectedFRCH * 0.133322 # converting this to kPA 



ggplot(aes(x = DateTimeAK, y = AirPressureCorrectedMOOS), data = eielson.atmo.2015) +
  geom_line(aes(x = DateTimeAK, y = AirPressureCorrectedMOOS), data = eielson.atmo.2015, color="#A6761D") +
  geom_line(aes(x = DateTimeAK, y = AirPressureCorrectedFRCH), data = eielson.atmo.2015, color="#FF7F00") +
  theme_classic() +
  ggtitle("Eielson corrected to MOOS (Brown) & Eielson corrected to FRCH (Orange)")



```

##### Checking Raw PT data 

## Raw Moose

There is a big increase in middle to end of may that doesnt seem to be real from precip , and then a lot of vertical drops in middle of June, July, August (potentially cleanning points) and then at the end of september we get a big drop, this is when the site was taken out...(PT was taken out on the 21st)... let the cleaning commence!

## Moose 1.0
```{r , echo=FALSE, warning=FALSE}
#plot(x = moos.stream$DateTimeAK, y = moos.stream$AbsolutePressure, type = "l")
#moos.stream <- moos.stream %>% subset(moos.stream$DateTimeAK < "2015-09-20 18:30:00") # PT was taken out on the 21st 

#june to july
moos.stream.1 <- moos.stream %>% subset(moos.stream$DateTimeAK < "2015-07-01 00:00:00" & moos.stream$DateTimeAK > "2015-06-01 00:00:00") 
#plot(moos.stream.1$DateTimeAK, moos.stream.1$AbsolutePressure, type = "l")
which(moos.stream.1$AbsolutePressure < 102)
moos.stream.1[c(4052, 5270:5277), 2] <- NA
#july to august
moos.stream.2 <- moos.stream %>% subset(moos.stream$DateTimeAK < "2015-08-01 00:00:00" & moos.stream$DateTimeAK > "2015-07-01 00:00:00") 
#plot(moos.stream.2$DateTimeAK, moos.stream.2$AbsolutePressure, type = "l")
which(moos.stream.2$AbsolutePressure < 102)
moos.stream.2$AbsolutePressure[moos.stream.2$AbsolutePressure == "99.188"] <- NA
moos.stream.2[2047, 2] <- NA
#august to September
moos.stream.3 <- moos.stream %>% subset(moos.stream$DateTimeAK < "2015-09-01 00:00:00" & moos.stream$DateTimeAK > "2015-08-01 00:00:00") 
#plot(moos.stream.3$DateTimeAK, moos.stream.3$AbsolutePressure, type = "l")
which(moos.stream.3$AbsolutePressure < 102)
moos.stream.3[c(2679,2680,2681,2683), 2] <- NA

#September to October
moos.stream.4 <- moos.stream %>% subset(moos.stream$DateTimeAK < "2015-10-01 00:00:00" & moos.stream$DateTimeAK > "2015-09-01 00:00:00") 
#plot(moos.stream.4$DateTimeAK, moos.stream.4$AbsolutePressure, type = "l")

moos.stream[c(9187, 10405:10412, 15822, 25382:25384, 25386), 2] <- NA
#plot(x = moos.stream$DateTimeAK, y = moos.stream$AbsolutePressure, type = "l")

#plot(as.POSIXct(moos.stream$DateTimeAK, tz= "America/Anchorage"), moos.stream$AbsolutePressure, pch=10, col="black", 
#     xlab = "", 
#     ylab = "Pressure",
#     #ylim = c(200, 250),
#     xlim = as.POSIXct(c("2015-05-15 00:00:00", "2015-05-21 00:00:00")))



moos.stream <- moos.stream %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK >= "2015-05-15" & DateTimeAK <= "2015-05-21" & AbsolutePressure < 102, NA, .)))

moos.stream <- moos.stream %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK >= "2015-06-07" & DateTimeAK <= "2015-06-09" & AbsolutePressure > 103.95, NA, .)))

moos.stream <- moos.stream %>% filter(DateTimeAK <= "2015-09-21 07:50:00") %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(AbsolutePressure < 101, NA, .)))

#moos.stream <- moos.stream %>%
#  mutate(across(c(AbsolutePressure), 
#                ~ifelse(DateTimeAK < "2015-05-25" & AbsolutePressure < 104, NA, .)))

moos.stream %>% #filter(DateTimeAK > "2015-05-01" & DateTimeAK < "2015-5-30") %>%
  ggplot(aes(x = DateTimeAK, y = AbsolutePressure)) +
  geom_point()


```
1) Clipped off the take out date (anything after 2015-09-20 18:30:00)
2) Set vertical drops in raw data to NA's


I will clean up the jumps.
```{r}
# Shift following pressure up after Jul 8 jump:
moos.stream[15821,2] - moos.stream[15823,2]
moos.stream <- moos.stream %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK >= "2015-07-08 10:40:00", AbsolutePressure + 2.182, .)))

# Shift following pressure up after May 25 jump:
moos.stream[3146,2] - moos.stream[3149,2]
moos.stream <- moos.stream %>% filter(DateTimeAK < "2015-05-25 10:15:00" | DateTimeAK > "2015-05-25 10:30:00") %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK > "2015-05-25 10:15:00", AbsolutePressure - 0.993, .)))

# Shift following pressure up after Jun 19 jump:
moos.stream[10403,2] - moos.stream[10413,2]
moos.stream <- moos.stream %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK > "2015-06-19 15:05:00", AbsolutePressure - 0.468, .)))


# Shift following pressure up after Sep 7 jump:
moos.stream[33693,2] - moos.stream[33694,2]
moos.stream <- moos.stream %>% 
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK > "2015-09-08 12:30:00", AbsolutePressure - 0.714, .)))


moos.stream %>% #filter(DateTimeAK > "2015-05-01" & DateTimeAK < "2015-5-30") %>%
  ggplot(aes(x = DateTimeAK, y = AbsolutePressure)) +
  geom_point()
```

### Impute missing observations in pressure for Moose 
```{r , echo=FALSE, warning=FALSE}
DateTimeFill <- data.frame(DateTimeAK = seq(ymd_hm("	
2015-05-20 22:15", tz = "America/Anchorage"),ymd_hm("2015-09-21 07:45", tz = "America/Anchorage"), by = '15 mins'))
moos.stream <- full_join(moos.stream, DateTimeFill)
moos.stream <- moos.stream[order(moos.stream$DateTimeAK),]
moos.stream <- na_kalman(moos.stream) %>% filter(DateTimeAK >= "2015-05-20 22:00" )

ggplot(moos.stream, aes(x = DateTimeAK, y = AbsolutePressure)) +
  geom_point() #+ geom_point(data = eielson.atmo.2015, aes(DateTimeAK, AirPressureCorrectedMOOS)) #+ scale_x_datetime(limits = ymd_h(c("2015-06-15 00", "2015-06-30 23"))) + ylim(95,107)


```

## Raw FRCH
```{r , echo=FALSE, warning=FALSE}
plot(caribou.2015.gauge$Precip~ caribou.2015.gauge$DateTimeAK, type="h",
     xlim = as.POSIXct(c("2015-05-14 04:05:00","2015-09-22 02:20:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(x = frch.stream$DateTimeAK, y = frch.stream$AbsolutePressure, type = "l")
```

Similarily to Moose There is a big increase in middle to end of may that doesnt seem to be real from precip , and then a lot of vertical drops in middle of June, July, August (potentially cleanning points) and then at the end of september we get a big drop, this is when the site was taken out...(PT was taken out on the 21st)... let the cleaning commence!

### French 1.0 
```{r, echo=FALSE, warning=FALSE}
frch.stream <- frch.stream %>%  subset(frch.stream$DateTimeAK <= "2015-09-21 12:45:00") # PT was taken out on the 21st 

#May to june
frch.stream.1 <- frch.stream %>% subset(frch.stream$DateTimeAK < "2015-06-01 00:00:00" & frch.stream$DateTimeAK > "2015-05-20 00:00:00") 
plot(frch.stream.1$DateTimeAK, frch.stream.1$AbsolutePressure, type = "l")
which(frch.stream.1$AbsolutePressure < 102)
frch.stream.1[c(1535, 2047:2060), 2] <- NA

#Juneto july
frch.stream.2 <- frch.stream %>% subset(frch.stream$DateTimeAK < "2015-07-01 00:00:00" & frch.stream$DateTimeAK > "2015-06-01 00:00:00") 
plot(frch.stream.2$DateTimeAK, frch.stream.2$AbsolutePressure, type = "l")
which(frch.stream.2$AbsolutePressure < 100)
frch.stream.2[c(49,2052,4111,5213:5241), 2] <- NA
#July to August # no cleaning necessary
frch.stream.3 <- frch.stream %>% subset(frch.stream$DateTimeAK < "2015-08-01 00:00:00" & frch.stream$DateTimeAK > "2015-07-01 00:00:00") 
plot(frch.stream.3$DateTimeAK, frch.stream.3$AbsolutePressure, type = "l")

#August to September 
frch.stream.4 <- frch.stream %>% subset(frch.stream$DateTimeAK < "2015-09-01 00:00:00" & frch.stream$DateTimeAK > "2015-08-01 00:00:00") 
plot(frch.stream.4$DateTimeAK, frch.stream.4$AbsolutePressure, type = "l")
which(frch.stream.4$AbsolutePressure < 100)
frch.stream.4[c(2641:2656, 4631:4654), 2] <- NA

#September to October # no cleaning necessary
frch.stream.5 <- frch.stream %>% subset(frch.stream$DateTimeAK < "2015-10-01 00:00:00" & frch.stream$DateTimeAK > "2015-09-01 00:00:00") 
plot(frch.stream.5$DateTimeAK, frch.stream.5$AbsolutePressure, type = "l")

frch.stream[c(3215,3727:3740,5185,7188,9247,10349:10377,25340:25355,27328:27353), 2] <- NA
plot(x = frch.stream$DateTimeAK, y = frch.stream$AbsolutePressure, type = "l")

frch.stream <- frch.stream %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK >= "2015-05-01" & DateTimeAK <= "2015-06-01" & AbsolutePressure < 102, NA, .)))

frch.stream %>% #filter(DateTimeAK > "2015-09-01" & DateTimeAK < "2015-10-01") %>%
  ggplot(aes(x = DateTimeAK, y = AbsolutePressure)) +
  geom_point()

```
1) Clipped off the take out date (anything after 2015-09-20 18:30:00)
2) Set vertical drops in raw data to NA's
3) NEED TO DO NA INTERPRET (na_kalman)

I will clean up the jumps.
```{r}
# Shift following pressure up after Jul 27 jump:
frch.stream[3726,2] - frch.stream[3741,2]
frch.stream <- frch.stream %>% filter(DateTimeAK >= "2015-05-18 15:15:00") %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK > "2015-05-27 10:30:00
", AbsolutePressure + 1.64, .)))

# Shift following pressure up after Jul 19 jump:
frch.stream[9158,2] - frch.stream[9189,2]
frch.stream <- frch.stream %>% filter(DateTimeAK != "2015-06-19 13:15:00") %>%
  mutate(across(c(AbsolutePressure), 
                ~ifelse(DateTimeAK > "2015-06-19 10:45:00
", AbsolutePressure - 0.669, .)))

```

### Impute missing observations in pressure for French 
```{r , echo=FALSE, warning=FALSE}
DateTimeFill <- data.frame(DateTimeAK = seq(ymd_hm("	
2015-05-18 15:15", tz = "America/Anchorage"),ymd_hm("2015-09-21 12:45", tz = "America/Anchorage"), by = '15 mins'))
frch.stream <- full_join(frch.stream, DateTimeFill)
frch.stream <- frch.stream[order(frch.stream$DateTimeAK),]
frch.stream <- na_kalman(frch.stream)

ggplot(frch.stream, aes(x = DateTimeAK, y = AbsolutePressure)) +
  geom_point()

```

### Raw Rating Curve with Moose 1 Pressure Transducer

```{r}
### Filter MOOS ###
QSummary.MO <- QSummary %>% filter(site =="Moose")

ggplot(QSummary.MO) +
  geom_point(aes(x = DateTimeAK, y = Q..L.s., color = site), size=3) +
  theme_classic() +
  scale_color_manual(values=c("#A6761D")) + 
  ggtitle("MOOS") 

```

```{r, echo=FALSE, warning=FALSE}
#join the atmospheric and water pressure together 
moos.stream$site <- "Moose"

MOOS.2015.one <- left_join(eielson.atmo.2015, moos.stream, by = "DateTimeAK") %>% filter(!AbsolutePressure %in% NA, !AirPressureCorrectedMOOS %in% NA)

MOOS.2015.one %>% ggplot(aes(DateTimeAK, AbsolutePressure)) + geom_point() + geom_point(aes(DateTimeAK, AirPressureCorrectedMOOS)) + ggtitle("Moose air and water pressure")
```

```{r}
# Water pressure - atmospheric pressure
MOOS.2015.one$difference <- MOOS.2015.one$AbsolutePressure - MOOS.2015.one$AirPressureCorrectedMOOS

# Remove spike at start because it doesn't match French
MOOS.2015.one <- MOOS.2015.one %>% mutate(across(c(difference), ~ifelse(DateTimeAK < "2015-06-01" & difference > 5, NA,.)))

MOOS.2015.one %>% ggplot(aes(DateTimeAK, difference)) + geom_point() + ggtitle("Moose difference")
```

```{r}

# trying to merge by nearest date if we have an offset point 
MOOS.2015.one.dt <- setDT(MOOS.2015.one) 
MOOS.2015.one.dt <- subset(MOOS.2015.one.dt, DateTimeAK < "2015-09-20 18:00:00") # removing rows that had dates corresponding to end of record that messed up the rolling nearest function 
QSummary.MO.dt <- QSummary.MO 

Moose1comb.2015 <- MOOS.2015.one.dt[QSummary.MO.dt, on = "DateTimeAK", roll = 'nearest']

MOOS1.lm.2015 <- lm(Moose1comb.2015$Q..L.s. ~ Moose1comb.2015$difference)

```


```{r}
# plot rating curve 
moos.formula = y~x

ggplot(aes(x = difference, y = Q..L.s.), data = Moose1comb.2015) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = moos.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  #xlim(216, 216.4) +
  #ylim(0,1500) +
  theme_light() +
  ggtitle("Moose all measured Q")

```

The two low points at the big difference are probably not the best

### Rating Curve with Moose 1 Pressure Transducer 2.0

```{r, echo=FALSE, warning=FALSE}
Moose1comb.2015.part.two <- Moose1comb.2015 %>%
  mutate(across(c(Q..L.s.), 
                ~ifelse(date == "2015-05-14", NA, .)))

Moose1comb.2015.part.two <- Moose1comb.2015.part.two %>%
  mutate(across(c(Q..L.s.), 
                ~ifelse(date == "2015-05-18", NA, .)))

ggplot(aes(x = difference, y = Q..L.s.), data = Moose1comb.2015.part.two) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = moos.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  #xlim(216, 216.4) +
  #ylim(0,1500) +
  theme_light() +
  ggtitle("Moose all measured Q")


```

1) I removed low Q values with high pressure difference. This looks like it is quadratic.


```{r, echo=FALSE, warning=FALSE}
moos.formula = y~poly(x, 2, raw = TRUE)

ggplot(aes(x = difference, y = Q..L.s.), data = Moose1comb.2015.part.two) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = moos.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  #xlim(216, 216.4) +
  #ylim(0,1500) +
  theme_light() +
  ggtitle("Moose measured Q")
```

Plot predicted Q.

```{r, message = FALSE, warning = FALSE}
## Predict MOOS Q
MOOS1.lm.2015 <- lm(Moose1comb.2015.part.two$Q..L.s. ~ Moose1comb.2015.part.two$difference + I(Moose1comb.2015.part.two$difference^2))

MOOS.2015.one.dt$pred.moos.Q <- coef(MOOS1.lm.2015)[2] * MOOS.2015.one.dt$difference + coef(MOOS1.lm.2015)[1] + coef(MOOS1.lm.2015)[3] * I(MOOS.2015.one.dt$difference^2)

MOOS.2015.one.dt <- MOOS.2015.one.dt %>% filter(!pred.moos.Q %in% NA)

# Fill in any missing predicted Q
MOOS.2015.one.dt <- na_kalman(MOOS.2015.one.dt)

MOOS.2015.one.dt %>% ggplot(aes(x = DateTimeAK, y = pred.moos.Q)) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Moose1comb.2015.part.two, aes(x = DateTimeAK, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("MOOS 2015 predicted and measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)")

```

### Raw Rating Curve with French 1 Pressure Transducer
```{r}
### Filter FRCH ###
QSummary.FR <- QSummary %>% filter(site =="French")

ggplot(QSummary.FR) +
  geom_point(aes(x = DateTimeAK, y = Q..L.s., color = site), size=3) +
  theme_classic() +
  scale_color_manual(values=c("#FF7F00")) + 
  ggtitle("FRCH") 

```

```{r, echo=FALSE, warning=FALSE}
#join the atmospheric and water pressure together 
frch.stream$site <- "French"

FRCH.2015.one <- left_join(eielson.atmo.2015, frch.stream, by = "DateTimeAK") %>% filter(!AirPressureCorrectedFRCH %in% NA, !AbsolutePressure %in% NA)

# Water pressure - atmospheric pressure
FRCH.2015.one$difference <- FRCH.2015.one$AbsolutePressure - FRCH.2015.one$AirPressureCorrectedFRCH

```

```{r}

# trying to merge by nearest date if we have an offset point 
FRCH.2015.one.dt <- setDT(FRCH.2015.one)
FRCH.2015.one.dt <- subset(FRCH.2015.one.dt, DateTimeAK < "2015-09-20 19:00:00") # removing rows that had dates corresponding to end of record that messed up the rolling nearest function 
QSummary.FR.dt <- QSummary.FR

French1comb.2015 <- FRCH.2015.one.dt[QSummary.FR.dt, on = "DateTimeAK", roll = 'nearest']

FRCH1.lm.2015 <- lm(French1comb.2015$Q..L.s. ~ French1comb.2015$difference)

```


```{r}
# plot rating curve 
frch.formula = y~ x + I(x^2)

French1comb.2015 %>% ggplot(aes(x = difference, y = Q..L.s.)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  theme_light() +
  ggtitle("French all measured Q")

```

We need to alter the quadratic term to make it not dip down like that.

```{r}
# plot rating curve 
frch.formula = y~ x + I(x^5/2)

French1comb.2015 %>% ggplot(aes(x = difference, y = Q..L.s.)) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula,
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  theme_light() +
  ggtitle("French all measured Q")

```


```{r, message = FALSE, warning = FALSE}
## Predict STRT Q
FRCH.lm.2015 <- lm(French1comb.2015$Q..L.s. ~ French1comb.2015$difference + I(French1comb.2015$difference^5/2))
summary(FRCH.lm.2015)

FRCH.2015.one.dt$pred.frch.Q <- coef(FRCH.lm.2015)[2] * FRCH.2015.one.dt$difference + coef(FRCH.lm.2015)[1] + coef(FRCH.lm.2015)[3] * I(FRCH.2015.one.dt$difference^5/2)

FRCH.2015.one.dt <- FRCH.2015.one.dt %>% filter(!pred.frch.Q %in% NA)

# Fill in any missing predicted Q
FRCH.2015.one.dt <- na_kalman(FRCH.2015.one.dt)

FRCH.2015.one.dt %>% ggplot(aes(x = DateTimeAK, y = pred.frch.Q)) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = French1comb.2015, aes(x = DateTimeAK, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("FRCH 2015 predicted and measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)")

```

### Export 2015 predicted Q
```{r}
FRCH.2015.one.dt <- FRCH.2015.one.dt[,c(2,15,13)]
names(FRCH.2015.one.dt) <- c("DateTimeAK", "Q", "Site")
MOOS.2015.one.dt <-  MOOS.2015.one.dt[,c(2,15,13)]
names(MOOS.2015.one.dt) <- c("DateTimeAK", "Q", "Site")

Q_2015 <- rbind(FRCH.2015.one.dt, MOOS.2015.one.dt)
Q_2015 <- na_kalman(Q_2015)

write.csv(Q_2015, here("Predicted_Discharge/2015/Predicted_Q_2015.csv"))

Q_2015$Day = format(as.POSIXct(Q_2015$DateTimeAK,format="%Y-%m-%d %H:%M:%S"),format="%Y-%m-%d")
Q_2015$Day = as.POSIXct(Q_2015$Day, "%Y-%m-%d", tz="America/Anchorage")

Q.daily.2015 <- Q_2015 %>% group_by(Site, Day) %>% summarise(Q = mean(Q))
any(is.na(Q.daily.2015))

write_csv(Q.daily.2015, here("Predicted_Discharge/2015/Q.daily.2015.csv"))


Q_2015 %>% ggplot() + geom_line(aes(DateTimeAK, Q, color = Site))+ ylab("Predicted Q")
```