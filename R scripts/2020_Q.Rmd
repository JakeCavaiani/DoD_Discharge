---
title: "2020 Q"
author: "Jake Cavaiani"
date: "11/13/2020"
output:
  html_document: default
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ='America/Anchorage')
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(rio)
library(neonUtilities)
library(raster)
library(data.table)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(imputeTS)
library(itsmr)
library(here)

```

### 2020
2020 (Moose, French, Poker, Vault, Stuart), clean out of water points, potentially erroneous points collected, beaver dams, etc. and prepare to convert to continuous predicted discharge (Q) throuhgout the year. 

2020 data is read in from DoD Project->2020 AK sensors->Discharge->Pressure Transducer->"site"

All 2020 water level data except for Poker were calculated with incorrect air pressure data! Here we have redone the rating curves using the raw stream and air pressure sensors (August 2023).

```{r, include=FALSE, warning=FALSE}
# Import processed Q data
### Import Data ###
moos.stream.one.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQrl6gZhkq2tiX-92iW4HOUCl-EGczERkj-UOTE4uh9ohgmVdyWbIdAHA-zycAbJ5lFGitMVFRYqp_p/pub?output=csv"
moos.stream.two.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRWd5nIq9AZskGn-FJyVxdXiwT48ROa9sDGDlA-z_aCqs-yNFB9fxmOAtMQ0dHN6ECf1Nnetlbniwy0/pub?output=csv"
moos.atmo.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ5eqEtVmRGngimZzfk7bNXYScBe0_Y4gnuxjKEWLEi-nndC_jC0-u43dNsiW8BJwtY3ez5ljqjtyRG/pub?output=csv"
frch.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSPXpfyIzPW7OQFonI2TkREf9NulnhOjy8ceNdwFG15UCUdt9GFw_xg_BI5sdKTmJYfeBX6WI2fx8KQ/pub?output=csv"
frch.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vS4LtTpml0XADmfPF8lN5s7WMxr3HWlG8fZwgiYwCkrNmEhoSUQS__mZX4wjaMtZePEx88fMfmBGOmz/pub?output=csv"
frch.air.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ0wLmEs3rUH2dfszdjLfhL5Wb1058wcIlck4_fUqrz7jpwOxX2-wXpR6a5tG2yCVmaXtaZ6yPGWfaL/pub?output=csv"
strt.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRINAGBo1Qe0A4yXGa0TmZZhNMCvxtlI3now6J9H83uhBsg2DT9j2z17RyoEyKBXaqWLYcwmAf_1Km_/pub?output=csv"
strt.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vThGVi9qf9gmXM6MzmbUqeodnrbxl_JAa1kkMLARTn_t3tq79z6wnC8K5JCX9Ni9XWiqpGDEjjNXWGy/pub?output=csv"
strt.atmo.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi4DoQMAiQINSEeIya0RpTgDhj-awkhseAi851_a9FunKvZqq5icVywORHU5Ku26XQm_9gX4XEIHHt/pub?output=csv"
vaul.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj4bpNEm98FV8yRI0M9fzvwjo2R-mb1FD5IOJuiPp9-N9fIZka7rUsf-_GCrGdeaIo7_sWS-f0R0MA/pub?output=csv"
vaul.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQfjSG2JfW2_gvemNbWB8hdejcCxbNwX-KeNz3spHbMWs85gOgNIbUPsXe_ElsI438RwivecSmLEVlY/pub?output=csv"
vaul.air.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRj9CmoO3NFx6hFyS6T-8l8xdmKXtJCTVFsr8hI-X_4Ryf95bBnZ5N-_G8IggAniAfK1q0XyJYyTP6z/pub?output=csv"
poke.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQpJY8w07AmWMOU4ZJGGGVBr2X-BFRzV7olOMNZ1-eIkIhAGS4FzTS6Rc7gQ8wlECuS0owkAxFHJm2/pub?output=csv"
poke.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuGeSGeAhsScsBTBF242QDrwLOPD9GBX9nVzVWx6XomYW8HT-B6x_mUevX2JJNMA96f_dXAOlNONWO/pub?output=csv"
poke.air.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxhMOctQhhOIfDMf1SH_mu_emLKvFuAmzMfEDw4gK8ixfbLb2dj0-QXU88Xd3ViYpMJzPZoYu9KrZI/pub?output=csv"

# Load Data#
moos.stream.one.2020 <- read.csv(url(moos.stream.one.2020.url), skip = 1)  
moos.stream.two.2020 <- read.csv(url(moos.stream.two.2020.url), skip = 1)
moos.air.2020 <- read.csv(url(moos.atmo.2020.url), skip = 1)


frch.stream.one.2020 <- read.csv(url(frch.stream.2020.url), skip = 1)
frch.stream.two.2020 <- read.csv(url(frch.stream.2020.url.two), skip = 1)
frch.air.2020 <- read.csv(url(frch.air.2020.url), skip = 1)

strt.stream.one.2020 <- read.csv(url(strt.stream.2020.url), skip = 1)
strt.stream.two.2020 <- read.csv(url(strt.stream.2020.url.two), skip = 1)
strt.air.2020 <- read.csv(url(strt.atmo.2020.url), skip = 1)

vaul.stream.one.2020 <- read.csv(url(vaul.stream.2020.url), skip = 1)
vaul.stream.two.2020 <- read.csv(url(vaul.stream.2020.url.two), skip = 1)
vaul.air.2020 <- read.csv(url(vaul.air.2020.url), skip = 1)

poke.stream.one.2020 <- read.csv(url(poke.stream.2020.url), skip = 1)
poke.stream.two.2020 <- read.csv(url(poke.stream.2020.url.two), skip = 1)
poke.air.2020 <- read.csv(url(poke.air.2020.url), skip = 1)


# Select pressure and datetime
moos.stream.one.2020 <- moos.stream.one.2020[,2:3]
moos.stream.two.2020 <- moos.stream.two.2020[,2:3]
moos.air.2020 <- moos.air.2020[,2:3]

frch.stream.one.2020 <- frch.stream.one.2020[,2:3]
frch.stream.two.2020 <- frch.stream.two.2020[,2:3]
frch.air.2020 <- frch.air.2020[,2:3]

strt.stream.one.2020 <- strt.stream.one.2020[,2:3]
strt.stream.two.2020 <- strt.stream.two.2020[,2:3]
strt.air.2020 <- strt.air.2020[,2:3]

vaul.stream.one.2020 <- vaul.stream.one.2020[,2:3]
vaul.stream.two.2020 <- vaul.stream.two.2020[,2:3]
vaul.air.2020 <- vaul.air.2020[,2:3]

poke.stream.one.2020 <- poke.stream.one.2020[,2:3]
poke.stream.two.2020 <- poke.stream.two.2020[,2:3]
poke.air.2020 <- poke.air.2020[,2:3]

# Rename columns #
names(moos.stream.one.2020) <- c("DateTime", "WaterPressure")
names(moos.stream.two.2020) <- c("DateTime", "WaterPressure")
names(moos.air.2020) <- c("DateTime", "AirPressure")

names(frch.stream.one.2020) <- c("DateTime", "WaterPressure")
names(frch.stream.two.2020) <- c("DateTime", "WaterPressure")
names(frch.air.2020) <- c("DateTime", "AirPressure")

names(strt.stream.one.2020) <- c("DateTime", "WaterPressure")
names(strt.stream.two.2020) <- c("DateTime", "WaterPressure")
names(strt.air.2020) <- c("DateTime", "AirPressure")

names(vaul.stream.one.2020) <- c("DateTime", "WaterPressure")
names(vaul.stream.two.2020) <- c("DateTime", "WaterPressure")
names(vaul.air.2020) <- c("DateTime", "AirPressure")

names(poke.stream.one.2020) <- c("DateTime", "WaterPressure")
names(poke.stream.two.2020) <- c("DateTime", "WaterPressure")
names(poke.air.2020) <- c("DateTime", "AirPressure")

# Input NA for missing time #
moos.stream.one.2020$DateTime[moos.stream.one.2020$DateTime == ""] <- NA
moos.stream.two.2020$DateTime[moos.stream.two.2020$DateTime == ""] <- NA
moos.air.2020$DateTime[moos.air.2020$DateTime == ""] <- NA

frch.stream.one.2020$DateTime[frch.stream.one.2020$DateTime == ""] <- NA
frch.stream.two.2020$DateTime[frch.stream.two.2020$DateTime == ""] <- NA
frch.air.2020$DateTime[frch.air.2020$DateTime == ""] <- NA

strt.stream.one.2020$DateTime[strt.stream.one.2020$DateTime == ""] <- NA
strt.stream.two.2020$DateTime[strt.stream.two.2020$DateTime == ""] <- NA
strt.air.2020$DateTime[strt.air.2020$DateTime == ""] <- NA

vaul.stream.one.2020$DateTime[vaul.stream.one.2020$DateTime == ""] <- NA
vaul.stream.two.2020$DateTime[vaul.stream.two.2020$DateTime == ""] <- NA
vaul.air.2020$DateTime[vaul.air.2020$DateTime == ""] <- NA

poke.stream.one.2020$DateTime[poke.stream.one.2020$DateTime == ""] <- NA
poke.stream.two.2020$DateTime[poke.stream.two.2020$DateTime == ""] <- NA
poke.air.2020$DateTime[poke.air.2020$DateTime == ""] <- NA


# Convert time and put in AK time #
moos.stream.one.2020$DateTime <- mdy_hms(moos.stream.one.2020$DateTime, tz = "America/Anchorage")
moos.stream.two.2020$DateTime <- mdy_hms(moos.stream.two.2020$DateTime, tz = "America/Anchorage")
moos.air.2020$DateTime <- mdy_hms(moos.air.2020$DateTime, tz = "America/Anchorage")

frch.stream.one.2020$DateTime <- mdy_hms(frch.stream.one.2020$DateTime, tz = "America/Anchorage")
frch.stream.two.2020$DateTime <- mdy_hms(frch.stream.two.2020$DateTime, tz = "America/Anchorage")
frch.air.2020$DateTime <- mdy_hms(frch.air.2020$DateTime, tz = "America/Anchorage")

strt.stream.one.2020$DateTime <- mdy_hms(strt.stream.one.2020$DateTime, tz = "America/Anchorage")
strt.stream.two.2020$DateTime <- mdy_hms(strt.stream.two.2020$DateTime, tz = "America/Anchorage")
strt.air.2020$DateTime <- mdy_hms(strt.air.2020$DateTime, tz = "America/Anchorage")

vaul.stream.one.2020$DateTime <- mdy_hms(vaul.stream.one.2020$DateTime, tz = "America/Anchorage")
vaul.stream.two.2020$DateTime <- mdy_hms(vaul.stream.two.2020$DateTime, tz = "America/Anchorage")
vaul.air.2020$DateTime <- mdy_hms(vaul.air.2020$DateTime, tz = "America/Anchorage")

poke.stream.one.2020$DateTime <- mdy_hms(poke.stream.one.2020$DateTime, tz = "America/Anchorage")
poke.stream.two.2020$DateTime <- mdy_hms(poke.stream.two.2020$DateTime, tz = "America/Anchorage")
poke.air.2020$DateTime <- mdy_hms(poke.air.2020$DateTime, tz = "America/Anchorage")


# Observed discharge
# Import data from google drive #

discharge.2020 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPrFKu3yyEDEDkxPVJW2vIWznwmSUcwuNlHInDmrD4EjOQYAkHmtnWJXRT1toDa74ptmHj4O1My3xw/pub?output=csv"
QSummary.2020 <- read.csv(url(discharge.2020))
QSummary.2020 <-  subset(QSummary.2020, select = -c(X2019, Notes, Average, X, Observations, X.1, X2020, average.as.of.8.29., X.2, observations.as.of.8.29.)) # Cleaning columns that are not important to the dataset
QSummary.2020$date <- mdy(QSummary.2020$Date)
QSummary.2020$DateTime <- as.POSIXct(paste(QSummary.2020$date, QSummary.2020$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")

```

NEON air pressure data to check time zone
```{r, echo = FALSE, include = FALSE}
NEON_air <-loadByProduct(dpID = "DP1.00004.001", site=c("BONA"), startdate="2020-05", enddate="2020-11", check.size = F)

NEON_bp <- NEON_air$BP_1min %>% filter(staPresFinalQF != 1)
attr(NEON_bp$startDateTime, "tzone") <- "America/Anchorage"
NEON_bp$DateTime <- NEON_bp$startDateTime



## Round time to 5 minutes and take average
NEON_bp$DateTime <- lubridate::round_date(NEON_bp$DateTime, "5 minutes") 
NEON_bp <- NEON_bp %>% group_by(DateTime) %>% summarise(bp_sea = mean(corPres, na.rm = TRUE))


NEON_bp %>% ggplot(aes(DateTime, bp_sea)) + geom_point()
```

## Comparing PTs

```{r, echo=FALSE, warning=FALSE}
# Combine the two PT into one #
moos.stream.one.2020$Site <- "MOOS1" #add column identifier
moos.stream.two.2020$Site <- "MOOS2"
moos.pt.2020 <- bind_rows(moos.stream.one.2020, moos.stream.two.2020)


frch.stream.one.2020$Site <- "FRCH1" #add column identifier
frch.stream.two.2020$Site <- "FRCH2"
frch.pt.2020 <- bind_rows(frch.stream.one.2020, frch.stream.two.2020)

strt.stream.one.2020$Site <- "STRT1" #add column identifier
strt.stream.two.2020$Site <- "STRT2"
strt.pt.2020 <- bind_rows(strt.stream.one.2020, strt.stream.two.2020)

vaul.stream.one.2020$Site <- "VAUL1" #add column identifier
vaul.stream.two.2020$Site <- "VAUL2"
vaul.pt.2020 <- bind_rows(vaul.stream.one.2020, vaul.stream.two.2020)

poke.stream.one.2020$Site <- "POKE1" #add column identifier
poke.stream.two.2020$Site <- "POKE2"
poke.pt.2020 <- bind_rows(poke.stream.one.2020, poke.stream.two.2020)

# Checking closeness between two PT #
moos.pt.2020 %>% pivot_wider(names_from = "Site", values_from = "WaterPressure") %>% ggplot(aes(MOOS1, MOOS2)) + geom_point()

```

Some erroneous points but not bad. a slight shift 

## Comparing FRCH

```{r, echo=FALSE, warning=FALSE}

frch.pt.2020 %>% pivot_wider(names_from = "Site", values_from = "WaterPressure") %>% ggplot(aes(FRCH1, FRCH2)) + geom_point()

```

Pretty good, have to clean some of those points 

## Comparing Stuart

```{r, echo=FALSE, warning=FALSE}
strt.pt.2020 %>% pivot_wider(names_from = "Site", values_from = "WaterPressure") %>% ggplot(aes(STRT1, STRT2)) + geom_point()
```

Same as French, some erroneous points that will need to be cleaned 

```{r, echo=FALSE, warning=FALSE}
poke.pt.2020 %>% pivot_wider(names_from = "Site", values_from = "WaterPressure") %>% ggplot(aes(POKE1, POKE2)) + geom_point()
```



## Observed Discharge at all sites for 2020

Slugs and wading rods were used for 2020 observed Q

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
# ALL Sites #
all <- ggplot(QSummary.2020) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, color=Site), size=3) +
  theme_classic() +
  scale_color_brewer(palette = "Set1") +
  ggtitle("ALL SITES")
all

a <- QSummary.2020 %>% filter(Site == "MOOS") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Moose")
a

b <- QSummary.2020 %>% filter(Site == "FRCH") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("French")
b

c <- QSummary.2020 %>% filter(Site == "POKE") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Poker")
c

d <- QSummary.2020 %>% filter(Site == "VAUL") %>%
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Vault")
d

e <- QSummary.2020 %>% filter(Site == "STRT") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart")
e

plot_grid(all, NA,
          a, b,
          c,d,
          e,
          nrow = 4, ncol = 2)
```

# Compare with NEON air pressure to verify time zone
```{r, include = FALSE, echo = FALSE}

frch.air.2020 %>% ggplot(aes(DateTime, AirPressure))  + geom_point(color = "red") + geom_point(data = NEON_bp, aes(DateTime, bp_sea -2)) + scale_x_datetime(limits = ymd_h(c("2020-07-07 00", "2020-07-30 23")))
```

## Raw Moose PT1
```{r, echo=FALSE, warning=FALSE}

moos.stream.one.2020 %>% ggplot(aes(DateTime, WaterPressure))  + geom_point()

```

Noisy on the falling limb of first storm, potentially some out of water points in August and at the end of the season. Let's only use PT2 because it is less messy.


## Raw Moose PT2
```{r, echo=FALSE, warning=FALSE}

plot(moos.stream.two.2020$DateTime, moos.stream.two.2020$WaterPressure)

```

Need to adjust middle of August on and clip off out of water points associated with install or decomission 


```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2020 <- moos.stream.two.2020 %>% subset(moos.stream.two.2020$DateTime < "2020-10-14") # cleaning data that is below 165.5 because those are errant and then before 10/14 because thats when we took the PTs out

# Shifting the back end of the data up
moos.stream.two.2020 <- moos.stream.two.2020 %>% mutate(across(WaterPressure, ~ifelse(DateTime > "2020-08-17 12:45:00", WaterPressure + 1.3, .))) %>% filter(DateTime != "2020-08-17 12:30:00")

# Shift on August 24th
moos.stream.two.2020 <- moos.stream.two.2020 %>% mutate(across(WaterPressure, ~ifelse(DateTime > "2020-08-24 12:00:00", WaterPressure + 0.5, .)))


moos.stream.two.2020.final <- na_kalman(moos.stream.two.2020)


moos.stream.two.2020.final %>% #filter(DateTime > "2020-08-16" & DateTime < "2020-09-01") %>% 
  ggplot(aes(DateTime, WaterPressure)) + geom_point()


```

1) Clipped off data after 10/14 because thats when we took the PTs out
2) clipped off errant points (vertical bars)
3) After clipping off errant points the back half of the data after August 8/17 @ 07:00 needed to be shifted up so I took the difference of the not matched points of the data and added the difference to the data following the clip 

# MOOS air pressure
```{r, echo=FALSE, warning=FALSE}
moos.air.2020 %>% ggplot(aes(DateTime, AirPressure)) + geom_point()
```

Take difference between air and water pressure.
Export PT data to csv in DoD_Discharge->PT_data->2020
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2020.final <- full_join(moos.stream.two.2020.final, moos.air.2020) %>% mutate(difference = WaterPressure - AirPressure)

moos.pt.2020 <- moos.stream.two.2020.final 

write.csv(moos.pt.2020, here("PT_data/2020/MOOS/moos.pt.2020.csv"))
```

Plot difference
```{r, echo=FALSE, warning=FALSE}
moos.pt.2020 %>% ggplot(aes(DateTime, difference)) + geom_point()
```


## Raw Rating Curve with MOOS PT2

```{r, echo=FALSE, warning=FALSE}

QSummary.MO.2020 <- QSummary.2020 %>% filter(Site =="MOOS")

# trying to merge by nearest date if we have an offset point 
MOOS2.2020.dt <- setDT(moos.stream.two.2020.final)

Moose2comb.2020 <- MOOS2.2020.dt[QSummary.MO.2020, on = "DateTime", roll = 'nearest']

moos.formula <- y~x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Moose2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moose2 all measured Q") 

```

Remove one YSI and one wading rod point.

```{r, echo=FALSE, warning=FALSE}

Moose2comb.2020.2 <- Moose2comb.2020[-c(18, 13), ]

moos.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Moose2comb.2020.2) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moose2 measured Q")

```

## Final Q for MOOS PT2
```{r, echo=FALSE, warning=FALSE}
MOOS2.lm.2020 <- lm(Moose2comb.2020.2$MeasuredQ_Ls ~ Moose2comb.2020.2$WaterPressure)


moos.stream.two.2020.final$pred.moos2.Q <- coef(MOOS2.lm.2020)[2] * moos.stream.two.2020.final$WaterPressure+ coef(MOOS2.lm.2020)[1]

ggplot(aes(x = DateTime, y = pred.moos2.Q), data = moos.stream.two.2020.final) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Moose2comb.2020, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose2 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("Date") +
  ylab("Predicted Discharge") #+ ylim(-10,500)

```



##
```{r, echo=FALSE, warning=FALSE}

moos.final.discharge.2020 <- moos.stream.two.2020.final

# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("	
2020-06-15 17:30", tz = "America/Anchorage"),ymd_hm("2020-10-13 23:45", tz = "America/Anchorage"), by = '15 mins'))
moos.final.discharge.2020 <- full_join(moos.final.discharge.2020, DateTimeFill)
moos.final.discharge.2020 <- moos.final.discharge.2020[order(moos.final.discharge.2020$DateTime),]
moos.final.discharge.2020 <- na_kalman(moos.final.discharge.2020, maxgap = 10)

ggplot(aes(x = DateTime, y = pred.moos2.Q), data = moos.final.discharge.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(data = Moose2comb.2020, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose2 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("Date") +
  ylab("Predicted Discharge") #+ ylim(-10,500)

```


## Export predicted Q to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
moos.final.discharge.2020_final <- moos.final.discharge.2020[,-c(2,3,4,5)]
names(moos.final.discharge.2020_final) <- c("DateTime", "Q")
moos.final.discharge.2020_final$Site <- "MOOS"
write.csv(moos.final.discharge.2020_final, here("Predicted_Discharge/2020/MOOS/MOOS.Q.csv"), row.names = FALSE)
```


### French
# Raw air pressure
```{r, echo=FALSE, warning=FALSE}

frch.air.2020 %>% #filter(DateTime >"2020-08-20" & DateTime < "2020-08-28") %>%
  ggplot(aes(DateTime, AirPressure)) + geom_point()
```


## Raw French PT1
```{r, echo=FALSE, warning=FALSE}

frch.stream.one.2020.b <- frch.stream.one.2020

frch.stream.one.2020 %>% #filter(DateTime >"2020-08-20" & DateTime < "2020-08-28") %>%
  ggplot(aes(DateTime, WaterPressure)) + geom_point()
```

Needs cleaning for out of water points that are associated with install and decommission. Noisy on the falling limb of these storms! Let the cleaning commence!

## French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.one.2020 <- frch.stream.one.2020  %>%  subset(frch.stream.one.2020$DateTime < "2020-10-14") %>% filter(WaterPressure > 100) #cleaning data that is before the 14th (Site was taken down the 15th)
frch.stream.one.2020[c(1,2,3,1039:3822,1699,1769), 4] <- NA # Setting NA to noisy part of the data set and errant points
frch.stream.one.2020 <- frch.stream.one.2020[,1:3]

plot(frch.stream.one.2020$DateTime, frch.stream.one.2020$WaterPressure, type = 'l')


```

1) Removed points after October 14th (when we took out PTs) and out of water points in the beginning of the dataset
2) Removed noisy points on receding limb of big storm events in the beginning of the dataframe 

## Raw French PT2
```{r, echo=FALSE, warning=FALSE}

plot(frch.stream.two.2020$DateTime, frch.stream.two.2020$WaterPressure, type = 'l')

```
Receding limb of first initial storm is noisy on this one too 

## French PT2 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2020 <- frch.stream.two.2020  %>%  subset(frch.stream.two.2020$DateTime < "2020-10-14") %>% filter(WaterPressure > 100) #cleaning data that is before the 14th (Site was taken down the 15th)

plot(frch.stream.two.2020$DateTime, frch.stream.two.2020$WaterPressure, type = 'l')

```

1) removed out of water points from taking out on the 14th of October 

PT2 is cleaner than PT1 so lets only use PT2 moving forward.

## Calculate difference between air and water pressure
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2020 <- full_join(frch.stream.two.2020, frch.air.2020, by = "DateTime")
frch.stream.two.2020$difference <- frch.stream.two.2020$WaterPressure - frch.stream.two.2020$AirPressure

frch.stream.two.2020 %>% ggplot(aes(DateTime, difference)) + geom_point()
```

## Export PT data to csv in DoD_Discharge->PT_data->2020
```{r, echo=FALSE, warning=FALSE}
frch.pt.2020 <- frch.stream.two.2020
write.csv(frch.pt.2020, here("PT_data/2020/FRCH/frch.pt.2020.csv"))
```

## Raw Rating curve FRCH PT2
```{r, echo=FALSE, warning=FALSE}
QSummary.FR.2020 <- QSummary.2020 %>% filter(Site =="FRCH")


frch.stream.two.2020$Site <- "FRCH"

French2comb.2020 <- full_join(frch.stream.two.2020, QSummary.FR.2020)
French2.lm.2020 <- lm(French2comb.2020$MeasuredQ_Ls ~ French2comb.2020$difference)

frch.formula <- y ~ x
ggplot(aes(x= difference, y = MeasuredQ_Ls), data = French2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French2 all measured Q") 

```



Lets try averaging the YSI and wading rod points.

```{r, echo=FALSE, warning=FALSE}
QSummary.FR.2020.2 <- QSummary.FR.2020 %>% group_by(Date) %>% summarise(MeasuredQ_Ls = mean(MeasuredQ_Ls, na.rm = T),
          DateTime = DateTime)


French2comb.2020.2 <- full_join(QSummary.FR.2020.2, frch.stream.two.2020)

French2.lm.2020.2 <- lm(French2comb.2020.2$MeasuredQ_Ls ~ French2comb.2020.2$difference + I(French2comb.2020.2$difference^2))

frch.formula = y~ poly(x,2)
ggplot(aes(x= difference, y = MeasuredQ_Ls), data = French2comb.2020.2) +
  geom_point( size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French2 all measured Q") 

```

Maybe it is more accurate because it incorporates both the YSI and wading rod data.

## Final Q for FRCH PT2
```{r, echo=FALSE, warning=FALSE}
French2comb.2020.2$pred.french2.Q <- coef(French2.lm.2020.2)[2] * French2comb.2020.2$difference + coef(French2.lm.2020.2)[1] + coef(French2.lm.2020.2)[3] * I(French2comb.2020.2$difference^2)

ggplot(aes(x = DateTime, y = pred.french2.Q), data=French2comb.2020.2) +
  geom_line(color="#A6CEE3", size=1.25) +
  
  geom_point(data = French2comb.2020, aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=3, color = "red") +
  theme_classic() +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  ggtitle("French") +
  xlab("") +
  ylab("Discharge (L/s)") 

```
Looks pretty good. 

## Export PT data to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
frch.final.discharge.2020 <- French2comb.2020.2[,c(3,5,8)]
names(frch.final.discharge.2020) <- c("DateTime", "Site", "Q")

# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("	
2020-06-11 13:30", tz = "America/Anchorage"),ymd_hm("	
2020-10-13 23:45", tz = "America/Anchorage"), by = '15 mins'))
frch.final.discharge.2020 <- full_join(frch.final.discharge.2020, DateTimeFill)
frch.final.discharge.2020 <- frch.final.discharge.2020[order(frch.final.discharge.2020$DateTime),]
frch.final.discharge.2020 <- na_kalman(frch.final.discharge.2020, maxgap = 10)

write.csv(frch.final.discharge.2020, here("Predicted_Discharge/2020/FRCH/FRCH.Q.csv"), row.names = FALSE)

frch.final.discharge.2020 %>% ggplot(aes(DateTime, Q)) + geom_point()
```

# Poker
## Raw Poker PT1
```{r, echo=FALSE, warning=FALSE}

plot(poke.stream.one.2020$DateTime, poke.stream.one.2020$WaterPressure, type = 'l')

```
It looks like I need to remove out of water points at the end of the year and potentially shift middle of september-on up....let the cleaning commence!

Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.one.2020 <- poke.stream.one.2020 %>% subset(poke.stream.one.2020$DateTime < "2020-10-10") # Cleaning data that is before October 10th due to ice (Site was taken down Oct 14th)


plot(poke.stream.one.2020$DateTime, poke.stream.one.2020$WaterPressure)

```

1) removed data after 10/10/20 due to decommission
2) shifted mid september-on up due to dip 

## Raw Poker PT2
```{r, echo=FALSE, warning=FALSE}

poke.stream.one.2020 %>% ggplot(aes(DateTime, WaterPressure)) + geom_point() + geom_point(data = poke.stream.two.2020, aes(DateTime, WaterPressure+2), color = "red", size = 0.5)

```

Because the two PTs are very close maybe we should not do any shifting.

Poker PT2 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2020 <- poke.stream.two.2020 %>% subset(poke.stream.two.2020$DateTime < "2020-10-10") # Cleaning data that is before October 10th due to ice (Site was taken down Oct 14th)

plot(poke.stream.two.2020$DateTime, poke.stream.two.2020$WaterPressure, type = 'l')

```
Air Pressure
```{r, echo=FALSE, warning=FALSE}
poke.air.2020 <- poke.air.2020 %>% subset(poke.air.2020$DateTime < "2020-10-10")
plot(poke.air.2020$DateTime, poke.air.2020$AirPressure, type = 'l')

```

## Export PT data to csv in DoD_Discharge->PT_data->2020
# Take difference
```{r, echo=FALSE, warning=FALSE}
# Take difference
poke.stream.one.2020 <- full_join(poke.stream.one.2020, poke.air.2020)
poke.stream.one.2020$difference <- poke.stream.one.2020$WaterPressure - poke.stream.one.2020$AirPressure

poke.stream.two.2020 <- full_join(poke.stream.two.2020, poke.air.2020)
poke.stream.two.2020$difference <- poke.stream.two.2020$WaterPressure - poke.stream.two.2020$AirPressure

poke.pt.2020 <- rbind(poke.stream.one.2020, poke.stream.two.2020)
write.csv(poke.pt.2020, here("PT_data/2020/POKE/poke.pt.2020.csv"), row.names = FALSE)
```

## Raw Rating curve POKE PT1
```{r, echo=FALSE, warning=FALSE}

QSummary.PO.2020 <- QSummary.2020 %>% filter(Site =="POKE")

### Rating curve for POKE PT1 ###
poke.stream.one.2020$Site <- "POKE"

Poke1comb.2020 <- full_join(poke.stream.one.2020, QSummary.PO.2020)
POKE1.lm.2020 <- lm(Poke1comb.2020$MeasuredQ_Ls ~ Poke1comb.2020$difference)

poke.formula <- y ~ x


ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Poke1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poke1 all measured Q") 


```

Top YSI point has got to go. 

Rating curve POKE PT1 2.0
```{r, echo=FALSE, warning=FALSE}

QSummary.PO.2020.1 <- QSummary.PO.2020[-4, ]

### Rating curve for POKE PT1 ###
poke.stream.one.2020$Site <- "POKE"

Poke1comb.2020 <- full_join(poke.stream.one.2020, QSummary.PO.2020.1)
POKE1.lm.2020 <- lm(Poke1comb.2020$MeasuredQ_Ls ~ Poke1comb.2020$difference)

poke.formula <- y ~ x


ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Poke1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poke1 all measured Q") 


```

1) removed the top YSI point

## Raw Rating curve POKE PT2
```{r, echo=FALSE, warning=FALSE}

poke.stream.two.2020$Site <- "POKE"

Poke2comb.2020 <- full_join(poke.stream.two.2020, QSummary.PO.2020)
POKE2.lm.2020 <- lm(Poke2comb.2020$MeasuredQ_Ls ~ Poke2comb.2020$difference)


ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Poke2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poker2 all measured Q")  

```


Need to remove the top YSI point and lowest water level YSI point.

## Raw Rating curve POKE PT2
```{r, echo=FALSE, warning=FALSE}
Poke2comb.2020 <- full_join(poke.stream.two.2020, QSummary.PO.2020.1[-c(16),])
POKE2.lm.2020 <- lm(Poke2comb.2020$MeasuredQ_Ls ~ Poke2comb.2020$difference)

poke.formula <- y ~ x
ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Poke2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formulat = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poker2 all measured Q")  

```

1) removed the top YSI point 
2) Quadratic is a slightly better fit.

## Final Q for POKE PT1
```{r, echo=FALSE, warning=FALSE}
Poke1comb.2020$pred.poke1.Q <- coef(POKE1.lm.2020)[2] * Poke1comb.2020$difference+ coef(POKE1.lm.2020)[1]
Poke1comb.2020 <- Poke1comb.2020 %>% subset(Poke1comb.2020$DateTime < "2020-10-09")
  
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020) +
  geom_point(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

```

Seems like the predicted overshoots our discrete measurements

## Final Q for POKE PT2
```{r, echo=FALSE, warning=FALSE}
Poke2comb.2020$pred.poke2.Q <- coef(POKE2.lm.2020)[2] * Poke2comb.2020$difference+ coef(POKE2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2020) +
  geom_point(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylim(0, 2500) +
  ylab("Discharge(L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-10")))

```


## Final Q POKE average
```{r, echo=FALSE, warning=FALSE}

poke.final.discharge.2020 <- left_join(Poke1comb.2020, Poke2comb.2020, by = "DateTime")
poke.final.discharge.2020$MeanDischarge <- rowMeans(poke.final.discharge.2020[,c('pred.poke1.Q', 'pred.poke2.Q')], na.rm = TRUE) 

poke.final.discharge.2020 <- poke.final.discharge.2020[,c(1,13,25,26)]


ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2020,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2020, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("Poker1(light) & Poker2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```


## Export PT data to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
Poke1comb.2020_final <- poke.final.discharge.2020[,c(1,4)]
Poke1comb.2020_final$Site <- "POKE"
names(Poke1comb.2020_final) <- c("DateTime", "Q", "Site")

# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("	
2020-06-04 13:00", tz = "America/Anchorage"),ymd_hm("	
2020-10-08 23:45", tz = "America/Anchorage"), by = '15 mins'))
Poke1comb.2020_final <- full_join(Poke1comb.2020_final, DateTimeFill)
Poke1comb.2020_final <- Poke1comb.2020_final[order(Poke1comb.2020_final$DateTime),]
Poke1comb.2020_final <- na_kalman(Poke1comb.2020_final, maxgap = 10)

write.csv(Poke1comb.2020_final, here("Predicted_Discharge/2020/POKE/POKE.Q.csv"), row.names = FALSE)

Poke1comb.2020_final %>% ggplot(aes(DateTime, Q)) + geom_point()
```

### Vault
## Raw Vault PT2
There is only one good Vault PT
```{r, echo=FALSE, warning=FALSE}
vaul.stream.2020 <- vaul.stream.two.2020
plot(vaul.stream.two.2020$DateTime, vaul.stream.two.2020$WaterPressure, type = 'l')

```

Hard to see what else we need to clean besides the end of the year out of water points....let the cleaning commence!

## Vault PT2 2.0
```{r, echo=FALSE, warning=FALSE}
vaul.stream.2020 <- vaul.stream.2020 %>% subset(vaul.stream.2020$DateTime < "2020-10-05") # Cleaning data that is before October 5th due to ice in channel (Site was taken down Oct 14th)

vaul.stream.2020 %>% #filter(DateTime < "2020-06-20") %>% 
  ggplot(aes(DateTime, WaterPressure)) + geom_point()


```

1) removed data after 10/5/20 due to out of water points 

Vault air pressure
```{r, echo=FALSE, warning=FALSE}
plot(vaul.air.2020$DateTime, vaul.air.2020$AirPressure, type = 'l')

```

## Take difference and export PT data to csv in DoD_Discharge->PT_data->2020
```{r, echo=FALSE, warning=FALSE}
vaul.stream.2020 <- full_join(vaul.stream.2020, vaul.air.2020)
vaul.stream.2020$difference <- vaul.stream.2020$WaterPressure - vaul.stream.2020$AirPressure

write.csv(vaul.stream.2020, here("PT_data/2020/VAUL/vaul.pt.2020.csv"), row.names = FALSE)
```

## Raw rating curve for VAUL PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Vault ### 
QSummary.VA.2020 <- QSummary.2020 %>% filter(Site =="VAUL")

### Rating curve for VAUL PT2 ###
vaul.stream.2020$Site <- "VAUL"

Vaul2comb.2020 <- full_join(vaul.stream.2020, QSummary.VA.2020)
VAUL2.lm.2020 <- lm(Vaul2comb.2020$MeasuredQ_Ls ~ Vaul2comb.2020$difference + I(Vaul2comb.2020$difference^2))

vaul.formula <- y ~ poly(x,2)

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Vaul2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = vaul.formula) +
  stat_poly_eq(formula = vaul.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Vault2 all measured Q")  

```

This gives many negative values for predicted Q, so lets only use one high point.
```{r, echo=FALSE, warning=FALSE}
### Filter Vault ### 
QSummary.VA.2020 <- QSummary.2020 %>% filter(Site =="VAUL") %>% filter(MeasuredQ_Ls < 500 | MeasuredQ_Ls > 900)

### Rating curve for VAUL PT2 ###
vaul.stream.2020$Site <- "VAUL"

Vaul2comb.2020 <- full_join(vaul.stream.2020, QSummary.VA.2020)
VAUL2.lm.2020 <- lm(Vaul2comb.2020$MeasuredQ_Ls ~ Vaul2comb.2020$difference + I(Vaul2comb.2020$difference^2))

vaul.formula <- y ~ poly(x,2)

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Vaul2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = vaul.formula) +
  stat_poly_eq(formula = vaul.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Vault2 all measured Q")  

```


## Predicted Q for VAUL
```{r, echo=FALSE, warning=FALSE}
Vaul2comb.2020$pred.vaul2.Q <- coef(VAUL2.lm.2020)[2] * Vaul2comb.2020$difference+ coef(VAUL2.lm.2020)[1] + coef(VAUL2.lm.2020)[3] * I(Vaul2comb.2020$difference^2)

ggplot(aes(x = DateTime, y = pred.vaul2.Q), data = Vaul2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Vault") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-10")))


```

Not too shabby!

## Export PT data to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
Vaul2comb.2020_final <- Vaul2comb.2020[,-c(2,4:12)] %>% filter(DateTime <= "2020-10-04 23:45:00")
names(Vaul2comb.2020_final) <- c("DateTime", "Site", "Q")
Vaul2comb.2020_final$Q <- as.numeric(Vaul2comb.2020_final$Q)

# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("	
2020-06-05 15:00", tz = "America/Anchorage"),ymd_hm("	
2020-10-04 23:45", tz = "America/Anchorage"), by = '15 mins'))
Vaul2comb.2020_final <- full_join(Vaul2comb.2020_final, DateTimeFill)
Vaul2comb.2020_final <- Vaul2comb.2020_final[order(Vaul2comb.2020_final$DateTime),]
Vaul2comb.2020_final <- na_kalman(Vaul2comb.2020_final, maxgap = 10)

write.csv(Vaul2comb.2020_final, here("Predicted_Discharge/2020/VAUL/VAUL.Q.csv"), row.names = FALSE)

Vaul2comb.2020_final %>% ggplot(aes(DateTime, Q)) + geom_point()
```

# Stuart
## Raw STRT PT1
```{r, echo=FALSE, warning=FALSE}

plot(strt.stream.one.2020$DateTime, strt.stream.one.2020$WaterPressure, type = 'l')

```


Needs end of season out of water points to be removed....let the cleaning commence!

STRT PT1 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.one.2020 <- strt.stream.one.2020 %>% subset(strt.stream.one.2020$DateTime < "2020-10-8") # cleaning data that is before October 8th due to ice in channel (Site was taken down Oct 13th)


plot(strt.stream.one.2020$DateTime, strt.stream.one.2020$WaterPressure)

```

1) Removed data after 10/8/20 due to ice on the channel...PT was taken out on the 13th
2) removed vertical bar errant point in middle of August

## Raw STRT PT2
```{r, echo=FALSE, warning=FALSE}

plot(strt.stream.two.2020$DateTime, strt.stream.two.2020$WaterPressure)

```

Same procedure as previous PT....let the cleaning commence!

STRT PT2 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2020 <- strt.stream.two.2020 %>% subset(strt.stream.two.2020$DateTime < "2020-10-08") # cleaning data that is before October 8th due to ice in channel (Site was taken down Oct 13th)

# Remove high point
strt.stream.two.2020 <- strt.stream.two.2020 %>% filter(WaterPressure < 114)

plot(strt.stream.two.2020$DateTime, strt.stream.two.2020$WaterPressure, type = 'l')


```
Air Pressure
```{r, echo=FALSE, warning=FALSE}

plot(strt.air.2020$DateTime, strt.air.2020$AirPressure, type = 'l')


```
Well that isn't at all helpful. Lets use air pressure from French.


## Export PT data to csv in DoD_Discharge->PT_data->2020
# Calculate difference
```{r, echo=FALSE, warning=FALSE}
# Calculate difference
strt.stream.one.2020 <- full_join(strt.stream.one.2020, frch.air.2020, by = "DateTime")
strt.stream.one.2020$difference <- strt.stream.one.2020$WaterPressure - strt.stream.one.2020$AirPressure

strt.stream.two.2020 <- full_join(strt.stream.two.2020, frch.air.2020, by = "DateTime")
strt.stream.two.2020$difference <- strt.stream.two.2020$WaterPressure - strt.stream.two.2020$AirPressure



# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("	
2020-06-17 16:30", tz = "America/Anchorage"),ymd_hm("	
2020-10-07 23:45", tz = "America/Anchorage"), by = '15 mins'))
strt.stream.one.2020 <- full_join(strt.stream.one.2020, DateTimeFill)
strt.stream.one.2020 <- strt.stream.one.2020[order(strt.stream.one.2020$DateTime),]
strt.stream.one.2020 <- na_kalman(strt.stream.one.2020, maxgap = 10)

strt.stream.two.2020 <- full_join(strt.stream.two.2020, DateTimeFill)
strt.stream.two.2020 <- strt.stream.two.2020[order(strt.stream.two.2020$DateTime),]
strt.stream.two.2020 <- na_kalman(strt.stream.two.2020, maxgap = 10)


strt.pt.2020 <- rbind(strt.stream.one.2020, strt.stream.two.2020)
write.csv(strt.pt.2020, here("PT_data/2020/STRT/strt.pt.2020.csv"), row.names = FALSE)

strt.stream.one.2020 %>% ggplot(aes(DateTime, difference)) + geom_point() + geom_point(data = strt.stream.two.2020, aes(DateTime, difference), color = "red")
```

## Raw rating curve for STRT PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020 <- QSummary.2020 %>% filter(Site =="STRT")

### Rating curve for STRT PT1 ### 

strt.stream.one.2020$Site <- "STRT"

Strt1comb.2020 <- full_join(strt.stream.one.2020, QSummary.ST.2020)
STRT1.lm.2020 <- lm(Strt1comb.2020$MeasuredQ_Ls ~ Strt1comb.2020$difference)

strt.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Strt1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q")

```


```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020.1 <- QSummary.2020 %>% filter(Site =="STRT", Method != "YSI" | MeasuredQ_Ls > 2000)

### Rating curve for STRT PT1 ### 

strt.stream.one.2020$Site <- "STRT"

Strt1comb.2020 <- full_join(strt.stream.one.2020, QSummary.ST.2020.1)
STRT1.lm.2020 <- lm(Strt1comb.2020$MeasuredQ_Ls ~ Strt1comb.2020$difference)

strt.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Strt1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q")

```

Does not look pretty. 

## Rating curve for STRT PT1 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020.1 <- QSummary.ST.2020[-c(8,14,7), ]
QSummary.ST.2020.2 <- QSummary.ST.2020.1 %>% group_by(DateTime) %>% summarise(MeasuredQ_Ls = mean(MeasuredQ_Ls))
Strt1comb.2020 <- full_join(strt.stream.one.2020, QSummary.ST.2020.2)
STRT1.lm.2020 <- lm(Strt1comb.2020$MeasuredQ_Ls ~ Strt1comb.2020$difference)

summary(STRT1.lm.2020)

strt.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Strt1comb.2020) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 measured Q") 


``` 

1) removed the lowest YSI and YSI's over 1000Ls, and the low measured Q, high water level wading rod point.


## Raw rating curve for STRT PT2
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
strt.stream.two.2020$Site <- "STRT"

Strt2comb.2020 <- full_join(strt.stream.two.2020, QSummary.ST.2020)
STRT2.lm.2020 <- lm(Strt2comb.2020$MeasuredQ_Ls ~ Strt2comb.2020$difference)

strt.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Strt2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt2 all measured Q") 

```


No good.

Rating curve for STRT PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020.2 <- QSummary.ST.2020[-c(8,14,7), ]# %>% filter(Method != "YSI" | MeasuredQ_Ls > 1500)   #[-c(8,14,7,6,16), ]

Strt2comb.2020 <- full_join(strt.stream.two.2020, QSummary.ST.2020.2)
STRT2.lm.2020 <- lm(Strt2comb.2020$MeasuredQ_Ls ~ Strt2comb.2020$difference)

strt.formula <- y ~ x

ggplot(aes(x = difference, y = MeasuredQ_Ls), data = Strt2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt2 all measured Q") 

``` 

Yikes.

## Predicted Q for STRT PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
Strt1comb.2020$pred.strt1.Q <- coef(STRT1.lm.2020)[2] * Strt1comb.2020$difference+ coef(STRT1.lm.2020)[1]

ggplot(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=3) +
  theme_classic() +
  ggtitle("Stuart") +
  #scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-09")))

``` 



## Predicted Q for STRT PT2
```{r, echo=FALSE, warning=FALSE}
Strt2comb.2020$pred.strt2.Q <- coef(STRT2.lm.2020)[2] * Strt2comb.2020$difference+ coef(STRT2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.strt2.Q), data = Strt2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart2 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("Date") +
  ylab("Predicted Discharge") 

``` 

Not as good as PT1, way too high. Lets only use PT1.

## Predicted Q for STRT
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2020 <- full_join(Strt2comb.2020, Strt1comb.2020, by = "DateTime")

strt.final.discharge.2020 <- strt.final.discharge.2020 %>% subset(strt.stream.one.2020$DateTime > "2020-06-16")

strt.final.discharge.2020$MeanDischarge <- rowMeans(strt.final.discharge.2020[,c('pred.strt1.Q', 'pred.strt2.Q')], na.rm = TRUE) 

strt.final.discharge.2020 <- strt.final.discharge.2020[, c(1,5,13, 19, 20)]

### Stuart1 (light blue), Stuart2 (dark blue), and Stuart1 (red) because STRT2 seems bad with observed Q.

strt.final.discharge.2020 %>% ggplot()+
  geom_line(aes(x = DateTime, y = pred.strt1.Q), color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.strt2.Q),color="#1F78B4", size=1.25, alpha = 0.75) +
   geom_line(aes(x = DateTime, y = MeanDischarge), data = strt.final.discharge.2020, color = "red", size = 1) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), data = Strt1comb.2020, size=2) +
  theme_classic() +
  ggtitle("Stuart1(light) & Stuart2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")


``` 



## Export PT data to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2020_final <- strt.final.discharge.2020 %>% dplyr::select(DateTime, MeanDischarge)
names(strt.final.discharge.2020_final) <- c("DateTime", "Q")
strt.final.discharge.2020_final$Site <- "STRT"
write.csv(strt.final.discharge.2020_final, here("Predicted_Discharge/2020/STRT/STRT.Q.csv"), row.names = FALSE)
```

## Export PT data to csv in DoD_Discharge->Predicted_Discharge->2020
```{r, echo=FALSE, warning=FALSE}
frch.final.discharge.2020$Q <- as.numeric(frch.final.discharge.2020$Q)

Q_2020 <- rbind(moos.final.discharge.2020_final,frch.final.discharge.2020,
                Poke1comb.2020_final,Vaul2comb.2020_final,
                strt.final.discharge.2020_final)

# Round all sites to 15 minute intervals
Q_2020$DateTime <- lubridate::round_date(Q_2020$DateTime, "15 minutes")
Q_2020 <- Q_2020 %>% group_by(Site, DateTime) %>% summarise(Q = mean(Q))

# Fill gaps in data
DateTimeFill <- data.frame(DateTime = seq(ymd_hm("2020-06-04 00:00", tz = "America/Anchorage"),ymd_hm("2020-10-16 00:00", tz = "America/Anchorage"), by = '15 mins'))
DateTimeFill_all <- data.frame(Site = c(rep("FRCH", length(DateTimeFill$DateTime)),rep("MOOS", length(DateTimeFill$DateTime)),rep("POKE", length(DateTimeFill$DateTime)),rep("STRT", length(DateTimeFill$DateTime)),rep("VAUL", length(DateTimeFill$DateTime))), DateTime = rep(DateTimeFill$DateTime, 5))
Q_2020 <- full_join(Q_2020, DateTimeFill_all)
Q_2020 <- Q_2020[order(Q_2020$DateTime),]

# Fill in gaps up to 15 x 10 minutes
Q_2020 <- Q_2020 %>% group_by(Site) %>% dplyr::summarise(  Q = na_kalman(Q, maxgap = 10),
                                                  DateTime = DateTime) %>% filter(DateTime < "2020-10-15")

write.csv(Q_2020, here("Predicted_Discharge/2020/Q_2020.csv"), row.names = FALSE)

Q_2020$Day = format(as.POSIXct(Q_2020$DateTime, format = "%Y-%m-%d %H:%M:%S"), format = "%Y-%m-%d")
Q_2020$Day = as.POSIXct(Q_2020$Day, "%Y-%m-%d", tz = "America/Anchorage")

Q.daily.2020 <- Q_2020 %>% group_by(Site, Day) %>% summarise(Q = mean(Q))


write.csv(Q.daily.2020, here("Predicted_Discharge/2020/Q.daily.2020.csv"), row.names = FALSE)


Q_2020 %>% ggplot(aes(DateTime, Q, color = Site)) + geom_point()

# Check time step intervals
Q_2020_check <- Q_2020 %>% group_by(Site) %>% summarise(diff = DateTime - lag(DateTime),
                                                      DateTime = DateTime)
unique(Q_2020_check$diff)

Q_2020_check %>% ggplot(aes(DateTime, diff, color = Site)) + geom_point()# + ylim(0,60)

# Check length of consecutive NA's
Q_2020_check_NA <- Q_2020 %>% mutate(Yes_NA = ifelse(Q %in% NA, "Y", "N"))

Q_2020_check_NA %>% 
  ggplot(aes(DateTime, Yes_NA)) + geom_point(size = 0.5) + facet_wrap(~Site)

```



