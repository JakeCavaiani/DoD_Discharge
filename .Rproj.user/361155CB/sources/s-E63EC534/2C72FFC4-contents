---
title: "FrenchMooseQ2018"
author: "Rachel Voight"
date: "2/5/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ='America/Anchorage')
setwd("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing")

library(readr)
library(ggplot2)
library(dplyr)
library(lubridate)
library(RColorBrewer)
library(gridExtra)
```

# French and Moose 2018 Discharge



```{r, include=FALSE, warning=FALSE}
# Import processed Q data
French1 <- read_csv("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing/French_stream_PT_may-oct2018_20005933.csv")
French2 <- read_csv("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing/French_stream2_PT_may-oct2018_20005935.csv")
Moose1 <- read_csv("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing/Moose_stream_PT_may-oct2018_10766894.csv")
Moose2 <- read_csv("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing/Moose_stream2_PT_may-oct2018_20005938.csv")
# Import summary notes from field book
Qsummary <- read_csv("~/Google Drive/All sensors/2018 sensors French Moose/Q/Qprocessing/FrenchMooseSummaryQ.csv", 
                     col_types = cols(Notes = col_skip()))
# Convert time and put in AK time 
French1$DateTime <- mdy_hm(French1$DateTimeGMT, tz="GMT") #convert date format.
attributes(French1$DateTime)$tzone <-'America/Anchorage'
French2$DateTime <- mdy_hm(French2$DateTimeGMT, tz="GMT") #convert date format.
attributes(French2$DateTime)$tzone <-'America/Anchorage'
Moose1$DateTime <- mdy_hm(Moose1$DateTimeGMT, tz="GMT") #convert date format.
attributes(Moose1$DateTime)$tzone <-'America/Anchorage'
Moose2$DateTime <- mdy_hm(Moose2$DateTimeGMT, tz="GMT") #convert date format.
attributes(Moose2$DateTime)$tzone <-'America/Anchorage'
Qsummary$Date <- mdy(Qsummary$Date)
Qsummary$DateTime <- with(Qsummary, ymd(Date) + hms(Time)) # Make combined date/time column
Qsummary$DateTime <- ymd_hms(Qsummary$DateTime)

# format data, combine all french, combine all moose, combine french and moose
French2 <- French2[1:nrow(French1),] # French 2 has a few extra rows on it from when stopping logger. Stripping them.
French1$name <- "French1" #add column identifier
French2$name <- "French2"
allfrench <- bind_rows(French1, French2) # combine 1&2 into one dataframe French
Moose1$name <- "Moose1" #add column indentifier
Moose2$name <- "Moose2"
allmoose <- bind_rows(Moose1, Moose2) # combine 1&2 into one dataframe Moose
frenchmoose <- bind_rows(allfrench, allmoose) # combine all french and all moose
```

##### Checking closeness between the two Pressure Transducers

1:1 line in green
```{r , echo=FALSE, warning=FALSE}
par(mfrow=c(1,2))
plot(x= French1$WaterLevelmeters[100:nrow(French1)], y=French2$WaterLevelmeters[100:nrow(French2)], 
     main = "French PT comparison", xlab = "French1 PT", ylab = "French2 PT", xlim = c(184, 185.7), ylim = c(184,187))
abline(1,1, col= "#33A02C")
plot(x= Moose1$WaterLevelmeters[100:nrow(Moose1)-15], y=Moose2$WaterLevelmeters[100:nrow(Moose2)-15], 
     main = "Moose PT comparison", xlab = "Moose1 PT", ylab = "Moose2 PT", xlim=c(166,168), ylim = c(166, 168) )
abline(1,1, col = "#33A02C")
par(mfrow=c(1,1))
```




### French
There looks like an error when we calculated depth. Tom says that we can adjust the difference of the wrong one to make them agree, then remeasure them next year. French 2 also looks "noisier"

```{r, echo=FALSE, warning=FALSE}
allfrench %>% 
  filter(WaterLevelmeters > 184) %>% 
  ggplot() + 
  geom_line(aes(x=DateTime, y=WaterLevelmeters, color=name), size=1.25) +
  theme_classic() +
  ggtitle("French") +
  scale_color_brewer(palette = "Paired")
```

### Moose

Moose2 looks a little weird during mid July, where it doens't agree w/ Moose 1. Moose 2 seems a lot noisier.   

```{r, echo=FALSE, warning=FALSE}
allmoose %>% 
  filter(WaterLevelmeters > 166) %>% 
  ggplot() + 
  geom_line(aes(x=DateTime, y=WaterLevelmeters, color=name), size=1.25) +
  theme_classic() +
  ggtitle("Moose") +
  scale_color_brewer(palette = "Paired")
```

### Observed Discharge at French and Moose

For the days we used the HOBO, there are two "measurements" since I did not know which slug solution was used, so I calculated it with the two likely slug batches. We changed where we were measuring Q at Moose; the first two times we measured Q, we did it  downstream of the sensors near the actual pressure transducer. We likely underestimated Q for those few measurements at the old spot downstream of the sensors. 

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
ggplot(Qsummary) +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Site, shape=Method), size=3) +
 theme_classic() +
  scale_color_brewer(palette = "Set1")

a <- Qsummary %>% filter(Site == "Moose") %>% 
  ggplot() +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Method), size=3) +
  theme_classic() +
  ggtitle("Moose")

b <- Qsummary %>% filter(Site == "French") %>% 
  ggplot() +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Method), size=3) +
  theme_classic() +
  ggtitle("French")
```

```{r, echo=FALSE, fig.width=10, fig.height=4, warning=FALSE}
grid.arrange(a,b, ncol=2)
```

### Rating Curve with Moose 1 Pressure Transducer

While we only had 4 measurements from the flow meter, they agree well with our trendline and slug Q.

```{r, echo=FALSE, warning=FALSE}
Qsummary.MO <- Qsummary  %>% 
  filter(Site == "Moose") 
moose1comb <- full_join(Moose1, Qsummary.MO) %>% 
  filter(WaterLevelmeters > 166)
ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 
Moose1.lm <- lm(moose1comb$MeasuredQ_Ls ~ moose1comb$WaterLevelmeters)
summary(Moose1.lm)
```



## Estimated Q from Moose 1 PT. 
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
moose1comb$pred.moose1.Q <- coef(Moose1.lm)[2] * moose1comb$WaterLevelmeters + coef(Moose1.lm)[1]
ggplot(aes(x=DateTime, y=pred.moose1.Q), data=moose1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
 geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=2) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  scale_y_continuous(name = "Predicted Discharge L/s") +
  scale_x_datetime(name = "Time")
moose1comb <- moose1comb %>% 
  mutate(Q_Ls = pred.moose1.Q)
```

not too shabby! For the most part, our measured Q agrees with the predicted Q based off the PT.  

Let's look at the second pressure transducer at Moose.  

### Rating Curve with Moose 2 Pressure Transducer  
```{r, echo=FALSE, warning=FALSE}

moose2comb <- full_join(Moose2, Qsummary.MO) %>% 
 filter(WaterLevelmeters > 166)
ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose2comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose2 all measured Q") 
Moose2.lm <- lm(moose2comb$MeasuredQ_Ls ~ moose2comb$WaterLevelmeters)
summary(Moose2.lm)
```

### Rating curves for Moose 1 and Moose 2 side-by-side
```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4}
c <- ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 
d <- ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose2comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose2 all measured Q") 
grid.arrange(c,d, ncol=2)
```

The Moose 1 Pressure Transducer has a stronger relationship compared to Moose 2. 


## Moose 2 Calculated Q (L/s)
#### Black points are observed Q

This doesn't look good. Rising and falling limbs are not what we would expect to see in these streams

```{r, echo=FALSE, warning=FALSE}
moose2comb$pred.moose2.Q <- coef(Moose2.lm)[2] * moose2comb$WaterLevelmeters + coef(Moose2.lm)[1]
ggplot(aes(x=DateTime, y=pred.moose2.Q), data=moose2comb) +
  geom_line(color="#1F78B4", size=1.25) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=3) +
  theme_classic() +
  ggtitle("Moose2 predicted all measured Q") +
  scale_y_continuous(name = "Predicted Discharge (L/s)") +
  scale_x_datetime(name = "Time")

```


### Moose1 (light blue) and Moose2 (dark blue) with observed Q.

Moose 1 (light blue) has the better PT v measured relationship and more characteristic hydrograph.

```{r, echo=FALSE, warning=FALSE}
ggplot(aes(x=DateTime, y=pred.moose1.Q), data=moose1comb) +
  geom_line(aes(x=DateTime, y=pred.moose1.Q), data=moose1comb, color="#A6CEE3", size=1.25) +
  geom_line(aes(x=DateTime, y=pred.moose2.Q), data=moose2comb,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls), size=2) +
  theme_classic() +
  ggtitle("Moose1(light) & Moose2(dark) predicted all measured Q") +
  scale_y_continuous(name="Predicted discharge L/s") +
  scale_x_datetime(name = "Time")
```

## French Creek

### Rating Curve French 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
Qsummary.FR <- Qsummary  %>% #filter out measured Q at just french
  filter(Site == "French") 

French1comb <- full_join(French1, Qsummary.FR) %>% 
  filter(WaterLevelmeters > 184)
ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(184.2,184.9)) +
  theme_classic() +
  ggtitle("French1 all measured Q") 
French1.lm <- lm(French1comb$MeasuredQ_Ls ~ French1comb$WaterLevelmeters)
summary(French1.lm)
```

## French 1 Calculated Q (L/s)
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
French1comb$pred.french1.Q <- coef(French1.lm)[2] * French1comb$WaterLevelmeters + coef(French1.lm)[1]
ggplot(aes(x=DateTime, y=pred.french1.Q), data=French1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=3) +
  theme_classic() +
  ggtitle("French1 predicted all measured Q") +
  scale_y_continuous(name = "Discharge L/s") +
  scale_x_datetime(name = "Time")
French1comb <- French1comb %>% 
  mutate(Q_Ls = pred.french1.Q)

```

### Rating Curve French 2 Pressure Transducer
This doesn't look as good as French 1  

```{r, echo=FALSE, warning=FALSE}
French2comb <- full_join(French2, Qsummary.FR) %>% 
  filter(WaterLevelmeters > 185)
ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French2comb) +
  geom_point(aes(color = Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(185.4,186.3)) +
  theme_classic() +
  ggtitle("French2 all measured Q") 
French2.lm <- lm(French2comb$MeasuredQ_Ls ~ French2comb$WaterLevelmeters)
summary(French2.lm)
```

## Rating curves for Moose 1 and Moose 2 side-by-side

```{r, echo=FALSE, warning=FALSE, fig.width=10, fig.height=4}
e <- ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(184.2,184.9)) +
  theme_classic() +
  ggtitle("French1 all measured Q") 
f <- ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French2comb) +
  geom_point(aes(color = Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(185.4,186.3)) +
  theme_classic() +
  ggtitle("French2 all measured Q") 

grid.arrange(e,f, ncol=2)
```

## French 2 Calculated Q (L/s)
#### Black points are observed Q

The rising and falling limbs don't look good. There is a clear mismatch between the measured/observed Q and the predicted Q from the pressure trandsucer.

```{r, echo=FALSE, warning=FALSE}
French2comb$pred.french2.Q <- coef(French2.lm)[2] * French2comb$WaterLevelmeters + coef(French2.lm)[1]
ggplot(aes(x=DateTime, y=pred.french2.Q), data=French2comb) +
  geom_line(color="#1F78B4", size = 1.25) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=3) +
  theme_classic() +
  ggtitle("French2 predicted all measured Q") +
  scale_y_continuous(name = "Predicted Discharge (L/s)") +
  scale_x_datetime(name = "Time")
```


Moose 1 and French 1 Pressure transducers provided the better rating curves.

## French and Moose Discharge 2018

```{r, echo=FALSE, warning=FALSE}
cols <- c("DateTime", "name", "Q_Ls") #select columns to join
moose1comb <- moose1comb %>% 
  select(cols)
French1comb <- French1comb %>% 
  select(cols)
allQ <- bind_rows(French1comb, moose1comb) #binding rows together to retain column structure

ggplot() +
  geom_line(aes(x=DateTime, y=Q_Ls, color = name), data=allQ, size=1.25) + 
  theme_classic() +
  ggtitle("French and Moose Q 2018") +
  scale_color_brewer(palette = "Set1", labels = c("French", "Moose")) +
  scale_y_continuous(name = "Discharge (L/s)") +
  scale_x_datetime(name = "Time") +
  theme(legend.title = element_blank())

```

We rock at discharge!!!

![IMG_1691](IMG_1691.jpg)
