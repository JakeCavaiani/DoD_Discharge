---
title: "Final Q"
author: "Jake Cavaiani"
date: "12/9/2021"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(TZ='America/Anchorage')
library(tidyverse)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(rio)
library(neonUtilities)
library(raster)
library(data.table)
library(scales)
library(psych)
library(here)
library(googledrive)
library(readxl)
library(cowplot)
library(zoo)
library(RColorBrewer)
library(gridExtra)
library(ggpmisc)
library(imputeTS)
library(itsmr)

```

## French and Moose 2015 Discharge

The purpose of this script is to import raw PT data from each of our sites in 2015 (Moose, French), clean (out of water points, potential beaver dams, noisy data, remove a PT if data is bad etc.) and prepare to convert to continuous predicted discharge (Q)

Important NOTES:
1) Water level data is obtained from HOBO pressure transducers (PTs) that were installed in PVC pipes in streams, with the PT sitting on top of a rebar piece at bottom of pipe. Raw pressure from PTs were processed in HOBOware to correct for atmospheric pressure to get water depth. Atmospheric pressure was obtained from a PT installed at each site in a tree. HOWEVER, water depth is absolute PT depth, NOT actual water depth. To get actual water depth, we need a reference water depth from a time point in the water depth time series that is an accurate measure of the depth of the pt from the water surface. We do not have these (depth measurements from flow meter measurements were not done sufficiently close to PT locations to use).We have waterlevel surveys from Kate Broberg in 2020 and 2021  We must therefore rely on the rating curve to convert absolute water depth to continuous Q.

2) Date/time from HOBOware data is GMT-8, which is Alaska Daylight Time, which is the correct timezone for this project in summer (AK is in GMT-9 March-November when daylight savings is not observed). Data/time therefore needs to be formatted but not timezone-converted.

Step 1: import raw data hoboware files which is site, datetime, absolute pressure and water level
Step 2: Clean errant points within the data that could be due to installation/decommission or gaps in data
Step 3: Write final output of cleaned site, datetime, absolute pressure and water level
Step 4: import Qsummary document to generate rating curves of Q and pressure
Step 5: clean errant points in regression
Step 6: apply rating curve to generate continuous predicted discharge at each site
Step 7: Output final discharge as csv.

2015 data is read from DoD->2015 AK sensors->Discharge->discharge->pressure transducer-> "PT_Site_Compiled"
2015 data was taken att 5 minute intervals

```{r, include=FALSE, warning=FALSE}
# Import processed Q data
moos.stream.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTng8WWrBVNB4uN7DHZuq1EfBn8tZ7qA71F7J-2izJUgeTU34LMbyXd_si8ezwscQ/pub?output=csv"
frch.stream.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vT2WNuEj8PTKLO6OkySK--koXwL6h_f3_WmctQTWkTlyB7boYmX1GmbT1HiVle6nA/pub?output=csv"

moos.stream <- read.csv(url(moos.stream.url), skip = 1)
frch.stream <- read.csv(url(frch.stream.url), skip = 1)
moos.stream <- moos.stream[,-c(3:4)] # Remove Na columns
frch.stream <- frch.stream[,-c(3:4)] # Remove Na columns


# Import summary notes from field book
discharge.2015 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQC9Bk0nS-Cx4Ec8MyLHd2xNuSv8JTobR8SSV_ODQHAvp4cUK8k3z9EmOs/pub?output=csv"
QSummary <- read.csv(url(discharge.2015))

# Import rain gauge data #
caribou.2015.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSolN8YGaUlUlcQjw9EaklcgcJu3b5L80X8Y-xX_ePg-CDOzZ07LDpl-aGBYvLwnvIhLB8Gm5Q66BWk/pub?output=csv"

caribou.2015.gauge <- read.csv(url(caribou.2015.url), skip = 4)
names(caribou.2015.gauge) <- c("DateTimeGMT", "Precip")
caribou.2015.gauge$DateTimeGMT[caribou.2015.gauge$DateTimeGMT == ""] <- NA
caribou.2015.gauge$DateTime = as.POSIXct(caribou.2015.gauge$DateTimeGMT, "%m/%d/%y %H:%M", tz="America/Anchorage")

# Rename columns #
names(moos.stream) <- c("Date", "AbsolutePressure")
names(frch.stream) <- c("Date", "AbsolutePressure")

#Convert time and put in AK time 
moos.stream$DateTime <- mdy_hm(moos.stream$Date)
utes(moos.stream$DateTime)$tzone <-'America/Anchorage'
frch.stream$DateTime <- mdy_hm(frch.stream$Date)
utes(frch.stream$DateTime)$tzone <-'America/Anchorage'

QSummary$date <- mdy(QSummary$date)
QSummary$DateTime <- as.POSIXct(paste(QSummary$date, QSummary$time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
```

##### Checking Raw PT data 

## Raw Moose
```{r , echo=FALSE, warning=FALSE}
plot(caribou.2015.gauge$Precip~ caribou.2015.gauge$DateTime, type="h",
     xlim = as.POSIXct(c("2015-05-14 04:05:00","2015-09-22 02:20:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(x = moos.stream$DateTime, y = moos.stream$AbsolutePressure, type = "l")
```
There is a big increase in middle to end of may that doesnt seem to be real from precip , and then a lot of vertical drops in middle of June, July, August (potentially cleanning points) and then at the end of september we get a big drop, this is when the site was taken out...(PT was taken out on the 21st)... let the cleaning commence!

## Moose 1.0
```{r , echo=FALSE, warning=FALSE}
plot(x = moos.stream$DateTime, y = moos.stream$AbsolutePressure, type = "l")
moos.stream <- moos.stream %>% subset(moos.stream$DateTime < "2015-09-20 18:30:00") # PT was taken out on the 21st 

#june to july
moos.stream.1 <- moos.stream %>% subset(moos.stream$DateTime < "2015-07-01 00:00:00" & moos.stream$DateTime > "2015-06-01 00:00:00") 
plot(moos.stream.1$DateTime, moos.stream.1$AbsolutePressure, type = "l")
which(moos.stream.1$AbsolutePressure < 102)
moos.stream.1[c(4052, 5270:5277), 2] <- NA
#july to august
moos.stream.2 <- moos.stream %>% subset(moos.stream$DateTime < "2015-08-01 00:00:00" & moos.stream$DateTime > "2015-07-01 00:00:00") 
plot(moos.stream.2$DateTime, moos.stream.2$AbsolutePressure, type = "l")
which(moos.stream.2$AbsolutePressure < 102)
moos.stream.2$AbsolutePressure[moos.stream.2$AbsolutePressure == "99.188"] <- NA
moos.stream.2[2047, 2] <- NA
#august to September
moos.stream.3 <- moos.stream %>% subset(moos.stream$DateTime < "2015-09-01 00:00:00" & moos.stream$DateTime > "2015-08-01 00:00:00") 
plot(moos.stream.3$DateTime, moos.stream.3$AbsolutePressure, type = "l")
which(moos.stream.3$AbsolutePressure < 102)
moos.stream.3[c(2679,2680,2681,2683), 2] <- NA

#September to October
moos.stream.4 <- moos.stream %>% subset(moos.stream$DateTime < "2015-10-01 00:00:00" & moos.stream$DateTime > "2015-09-01 00:00:00") 
plot(moos.stream.4$DateTime, moos.stream.4$AbsolutePressure, type = "l")

moos.stream[c(9187, 10405:10412, 15822, 25382:25384, 25386), 2] <- NA
plot(x = moos.stream$DateTime, y = moos.stream$AbsolutePressure, type = "l")


```
1) Clipped off the take out date (anything after 2015-09-20 18:30:00)
2) Set vertical drops in raw data to NA's
3) NEED TO DO NA INTERPRET


### Impute missing observations in pressure for Moose 
```{r , echo=FALSE, warning=FALSE}

# Apply a moving average smoother to Pressure 
## smooth.ma from itsmr library: averaging by 2q+1, with q = 3 here
moos.stream.test <- moos.stream
moos.stream.test <- moos.stream.test[,-1]
moos.stream.fill <- lapply(moos.stream.test, function(x) {
                        mutate(x, AP.ma = smooth.ma(moos.stream.test$AbsolutePressure, 3))
})

## Plot to compare smoothed to raw Turbidity
# to dataframe for compatibility with ggplot
EXO.cl.df <- bind_rows(EXO.cl, .id = "Site")

Turb.ma.pl <- EXO.cl.df %>% 
  ggplot(aes(x = datetimeAK, y = Turbidity.FNU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "red") +
  facet_wrap(~Site, scales = "free_y")

fDOM.pl <- EXO.cl.df %>% 
  ggplot(aes(x = datetimeAK, y = fDOM.QSU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "red") +
  facet_wrap(~Site, scales = "free_y")


### Fill gaps in Turbidity ###
anyNA(moos.stream, recursive = TRUE)
lapply(moos.stream, summary)

# Make univariate time series, covert to zoo, then to ts #
pressure.only <- lapply(moos.stream, '[', (c("DateTime", "AbsolutePressure")))

pressure.ts <- lapply(pressure.only, function(x) {read.zoo(x, index.column=1, format="%Y-%m-%d %H:%M:%S", tz="America/Anchorage")
})

pressure.xts <- lapply(pressure.ts, function(x) {as.xts(x)
})

# Apply auto.arima (default model in call to na_kalman) and kalman filter (default = smooth) to impute missing values using na.kalman from imputeTS #
pressure.int <- lapply(pressure.xts, function(x) {na_kalman(x)
  })

anyNA(pressure.int, recursive = TRUE)

# revert xts to dataframe
pressure.ma.int = lapply(pressure.int, function(x) {data.frame(DateTime=time(x), pressure.ma.int=as.matrix(x))
})

pressure.ma.int <- lapply(pressure.ma.int, setNames, c("DateTime", "AbsolutePressure"))

# Rejoin to instrument record (EXO.cl)
moos.stream.cl.int <- map2(moos.stream, pressure.ma.int, ~merge(.x, .y, by = "DateTime"))

## Compare instrument record and with imputed turbidity time series
# to dataframe for compatibility with ggplot
EXO.cl.int.df <- bind_rows(EXO.cl.int, .id = "Site")

Turb.ma.int.pl <- EXO.cl.int.df %>% 
  ggplot(aes(x = datetimeAK, y = Turbidity.FNU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.FNU.ma.int), color = "red") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "green") +
  facet_wrap(~Site, scales = "free_y")

ggsave(Turb.ma.int.pl, file = "Turb_ma_int_2019.pdf", path = here("plots"), width = 11, height = 8, units = "in")

## Raw French

```{r, echo=FALSE, warning=FALSE}
plot(caribou.2015.gauge$Precip~ caribou.2015.gauge$DateTime, type="h",
     xlim = as.POSIXct(c("2015-05-14 04:05:00","2015-09-22 02:20:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(x = frch.stream$DateTime, y = frch.stream$AbsolutePressure, type = "l")
```

Similarily to Moose There is a big increase in middle to end of may that doesnt seem to be real from precip , and then a lot of vertical drops in middle of June, July, August (potentially cleanning points) and then at the end of september we get a big drop, this is when the site was taken out...(PT was taken out on the 21st)... let the cleaning commence!

### French 1.0 
```{r, echo=FALSE, warning=FALSE}
frch.stream <- frch.stream %>%  subset(frch.stream$DateTime < "2015-09-20 18:30:00") # PT was taken out on the 21st 

#May to june
frch.stream.1 <- frch.stream %>% subset(frch.stream$DateTime < "2015-06-01 00:00:00" & frch.stream$DateTime > "2015-05-20 00:00:00") 
plot(frch.stream.1$DateTime, frch.stream.1$AbsolutePressure, type = "l")
which(frch.stream.1$AbsolutePressure < 102)
frch.stream.1[c(1535, 2047:2060), 2] <- NA

#Juneto july
frch.stream.2 <- frch.stream %>% subset(frch.stream$DateTime < "2015-07-01 00:00:00" & frch.stream$DateTime > "2015-06-01 00:00:00") 
plot(frch.stream.2$DateTime, frch.stream.2$AbsolutePressure, type = "l")
which(frch.stream.2$AbsolutePressure < 100)
frch.stream.2[c(49,2052,4111,5213:5241), 2] <- NA
#July to August # no cleaning necessary
frch.stream.3 <- frch.stream %>% subset(frch.stream$DateTime < "2015-08-01 00:00:00" & frch.stream$DateTime > "2015-07-01 00:00:00") 
plot(frch.stream.3$DateTime, frch.stream.3$AbsolutePressure, type = "l")

#August to September 
frch.stream.4 <- frch.stream %>% subset(frch.stream$DateTime < "2015-09-01 00:00:00" & frch.stream$DateTime > "2015-08-01 00:00:00") 
plot(frch.stream.4$DateTime, frch.stream.4$AbsolutePressure, type = "l")
which(frch.stream.4$AbsolutePressure < 100)
frch.stream.4[c(2641:2656, 4631:4654), 2] <- NA

#September to October # no cleaning necessary
frch.stream.5 <- frch.stream %>% subset(frch.stream$DateTime < "2015-10-01 00:00:00" & frch.stream$DateTime > "2015-09-01 00:00:00") 
plot(frch.stream.5$DateTime, frch.stream.5$AbsolutePressure, type = "l")

frch.stream[c(3215,3727:3740,5185,7188,9247,10349:10377,25340:25355,27328:27353), 2] <- NA
plot(x = frch.stream$DateTime, y = frch.stream$AbsolutePressure, type = "l")
```
1) Clipped off the take out date (anything after 2015-09-20 18:30:00)
2) Set vertical drops in raw data to NA's
3) NEED TO DO NA INTERPRET (na_kalman)

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
### Fill gaps in pressure ###
frch.stream <- lapply(EXO.cl, function(x) {
                        mutate(x, AbsolutePressure = smooth.ma(AbsolutePressure, 3))
})

## Plot to compare smoothed to raw Turbidity
# to dataframe for compatibility with ggplot
EXO.cl.df <- bind_rows(EXO.cl, .id = "Site")

Turb.ma.pl <- EXO.cl.df %>% 
  ggplot(aes(x = datetimeAK, y = Turbidity.FNU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "red") +
  facet_wrap(~Site, scales = "free_y")

fDOM.pl <- EXO.cl.df %>% 
  ggplot(aes(x = datetimeAK, y = fDOM.QSU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "red") +
  facet_wrap(~Site, scales = "free_y")
anyNA(french.stream, recursive = TRUE)
lapply(EXO.cl, summary)

# Make univariate time series, covert to zoo, then to ts #
turb.only <- lapply(EXO.cl, '[', (c("datetimeAK", "Turb.ma")))

turb.ts <- lapply(turb.only, function(x) {read.zoo(x, index.column=1, format="%Y-%m-%d %H:%M:%S", tz="America/Anchorage")
})

turb.xts <- lapply(turb.ts, function(x) {as.xts(x)
})

# Apply auto.arima (default model in call to na_kalman) and kalman filter (default = smooth) to impute missing values using na.kalman from imputeTS #
turb.int <- lapply(turb.xts, function(x) {na_kalman(x)
  })

anyNA(turb.int, recursive = TRUE)

# revert xts to dataframe
turb.ma.int = lapply(turb.int, function(x) {data.frame(datetimeAK=time(x), turb.ma.int=as.matrix(x))
})

turb.ma.int <- lapply(turb.ma.int, setNames, c("datetimeAK", "Turb.FNU.ma.int"))

# Rejoin to instrument record (EXO.cl)
EXO.cl.int <- map2(EXO.cl, turb.ma.int, ~merge(.x, .y, by = "datetimeAK"))

## Compare instrument record and with imputed turbidity time series
# to dataframe for compatibility with ggplot
EXO.cl.int.df <- bind_rows(EXO.cl.int, .id = "Site")

Turb.ma.int.pl <- EXO.cl.int.df %>% 
  ggplot(aes(x = datetimeAK, y = Turbidity.FNU.mn)) +
  geom_point(color = "blue") +
  #geom_line(color = "blue") +
  geom_line(aes(x = datetimeAK, y = Turb.FNU.ma.int), color = "red") +
  geom_line(aes(x = datetimeAK, y = Turb.ma), color = "green") +
  facet_wrap(~Site, scales = "free_y"))
```

### Observed Discharge at French and Moose

Slugs were the only method of discharge for 2015 

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
# ALL Sites #
all <- ggplot(QSummary) +
  geom_point(aes(x=date, y=Q..L.s., color=site), size=3) +
  theme_classic() +
  scale_color_brewer(palette = "Set1") +
  ggtitle("ALL SITES")
all

a <- QSummary %>% filter(site == "Moose") %>% 
  ggplot() +
  geom_point(aes(x=date, y=Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("Moose")
a

b <- QSummary %>% filter(site == "French") %>% 
  ggplot() +
  geom_point(aes(x=date, y=Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("Moose")
b

plot_grid(all, NA,
          a, b,
          nrow = 2, ncol = 2)
```
This is from the DOD Q Summary csv that is DoD Project->2015 AK sensors ->Discharge

### Raw Rating Curve with Moose 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
QSummary.MO <- QSummary %>% filter(site =="Moose")

# Rating curve for MOOS PT1 # 
moos.stream$site <- "Moose"

Moose1comb <- full_join(moos.stream, QSummary.MO)
MOOS1.lm <- lm(Moose1comb$Q..L.s. ~ Moose1comb$AbsolutePressure)

moos.formula <- y ~ x

mrc.1 <- ggplot(aes(x = AbsolutePressure, y = Q..L.s.), data = Moose1comb) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

mrc.1

```
The most upper measurement is probably bad. I am going to take it out

### Rating Curve with Moose 1 Pressure Transducer 2.0

```{r, echo=FALSE, warning=FALSE}
QSummary.MO <- QSummary %>% filter(site =="Moose")
QSummary.MO <- QSummary.MO %>% filter(Q..L.s. < 2500)
# Rating curve for MOOS PT1 # 
moos.stream$site <- "Moose"

Moose2comb <- full_join(moos.stream, QSummary.MO)
MOOS2.lm <- lm(Moose2comb$Q..L.s. ~ Moose2comb$AbsolutePressure)

moos.formula <- y ~ x

mrc.2 <- ggplot(aes(x = AbsolutePressure, y = Q..L.s.), data = Moose2comb) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

mrc.2

QSummary.MO <- QSummary.MO %>% filter(Q..L.s. < 1300)
# Rating curve for MOOS PT1 # 
moos.stream$site <- "Moose"

Moose3comb <- full_join(moos.stream, QSummary.MO)
MOOS3.lm <- lm(Moose3comb$Q..L.s. ~ Moose3comb$AbsolutePressure)

moos.formula <- y ~ x

mrc.3 <- ggplot(aes(x = AbsolutePressure, y = Q..L.s.), data = Moose3comb) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

mrc.3
plot_grid(mrc.1, mrc.2,
          mrc.3, NA,
          ncol = 2, nrow = 2)
```
1) Removed the point that had a Q > 3000 L/s - This R^2 value is actually lower
2) Removed the point that had a Q > 1300 L/s - best R^2 value 


### Moose1 (light blue) and Moose2 and Moose3 (brown) with observed Q. 
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Moose1comb$pred.moos1.Q <- coef(MOOS1.lm)[2] * Moose1comb$AbsolutePressure+ coef(MOOS1.lm)[1]
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moose1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

Moose1comb$pred.moos2.Q <- coef(MOOS2.lm)[2] * Moose1comb$AbsolutePressure+ coef(MOOS2.lm)[1]
ggplot(aes(x = DateTime, y = pred.moos2.Q), data = Moose1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

Moose1comb$pred.moos3.Q <- coef(MOOS3.lm)[2] * Moose1comb$AbsolutePressure+ coef(MOOS3.lm)[1]
ggplot(aes(x = DateTime, y = pred.moos3.Q), data = Moose1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

ggplot(aes(x=DateTime, y=pred.moos1.Q), data=Moose1comb) +
  geom_line(aes(x=DateTime, y=pred.moos1.Q), data=Moose1comb, color="#A6CEE3", size=1.25) +
  geom_line(aes(x=DateTime, y=pred.moos2.Q), data=Moose1comb,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x=DateTime, y=pred.moos3.Q), data=Moose1comb,color="brown", size=1.25, alpha = 0.75) +
  geom_point(aes(x=DateTime, y=Q..L.s.), size=2) +
  theme_classic() +
  ggtitle("Moose1(light) & Moose2(dark) predicted all measured Q") +
  scale_y_continuous(name="Predicted discharge L/s") +
  scale_x_datetime(name = "Time")

```
This is only from PT rather than waterlevel, is that going to be a problem? Moose1 is from the first RC and Moose2 is from the second RC and Moose3 is from the third RC. It appears that it gets worse to predict the higher discharges as we go through our iteration of RC's.

### Raw Rating Curve with French 1 Pressure Transducer 
```{r, echo=FALSE, warning=FALSE}
QSummary.FR <- QSummary %>% filter(site =="French")

### Rating curve for FRCH PT1 ###
frch.stream$site <- "French" # Add a column identifier 

French1comb <- full_join(frch.stream, QSummary.FR) # Join PT data with Discharge
French1.lm <- lm(French1comb$Q..L.s. ~ French1comb$AbsolutePressure) # linear model with discharge and water level

frch.formula <- y ~ x

frc.1 <- ggplot(aes(x = AbsolutePressure, y = Q..L.s.), data = French1comb) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French1 all measured Q") 

frc.1

```
The most upper measurement is probably bad. I am going to take it out

### Rating Curve French PT 2.0
```{r, echo=FALSE, warning=FALSE}
QSummary.FR <- QSummary %>% filter(site =="French")
QSummary.FR <- QSummary.FR %>% filter(Q..L.s. < 2500)
### Rating curve for FRCH PT1 ###
frch.stream$site <- "French" # Add a column identifier 

French2comb <- full_join(frch.stream, QSummary.FR) # Join PT data with Discharge
French2.lm <- lm(French2comb$Q..L.s. ~ French2comb$AbsolutePressure) # linear model with discharge and water level

frch.formula <- y ~ x

frc.2 <- ggplot(aes(x = AbsolutePressure, y = Q..L.s.), data = French2comb) +
  geom_point(size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French1 all measured Q") 

frc.2

```
R^2 value goes down 

## French 1 Calculated Q (L/s)
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
French1comb$pred.french1.Q <- coef(French1.lm)[2] * French1comb$AbsolutePressure+ coef(French1.lm)[1]
ggplot(aes(x = DateTime, y = pred.french1.Q), data=French1comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q..L.s.), size=3) +
  theme_classic() +
  ggtitle("French1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 
```
This is not great considering there are negative values 


################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

# French and Moose 2018 Discharge

2018 data is read from DoD->2018 sesors French Moose->Q->Qprocessing->"French_stream_PT_may-oct2018_20005933.csv" 
Wading rods and slugs were used to measure discrete Q during site visit


```{r, include=FALSE, warning=FALSE}
# Import processed Q data
# Import Data #
French1.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeBCz7Rq59AjhTnjeJH_H9ot8gtiujyv9-W7KOAKYacPFizjOp4KqxGbhMWmsT756KEGzBYQjeRpgz/pub?output=csv"
French2.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCm-lCZI01xF1g4ytFCMECZJoUhjjEd11_cQTLDGzyv_4GHeLVEwX5alAVyO8hiDLzJOwWVYQui7E_/pub?output=csv"
Moose1.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAzlkTb2-hfKPTXP1ZWp1vYCqK1irV4Gy2UMcjF7HSDdUq1WZCRNBfJs07VDrB7dGeHgIalOzrsKPG/pub?output=csv"
Moose2.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTGobrtIaYMa8-jDTYvO2s9OBsnQyksLPLRXPycD0pLi3_Asd786dK0XGnYowobM0p7NLZM5qpxmk9S/pub?output=csv"

# read in data #
French1 <- read.csv(url(French1.url))
French2 <- read.csv(url(French2.url))
Moose1 <- read.csv(url(Moose1.url))
Moose2 <- read.csv(url(Moose2.url))

# Convert time and put in AK time 
French1$DateTime <- mdy_hm(French1$DateTimeGMT, tz="GMT") #convert date format.
attributes(French1$DateTime)$tzone <-'America/Anchorage'
French2$DateTime <- mdy_hm(French2$DateTimeGMT, tz="GMT") #convert date format.
attributes(French2$DateTime)$tzone <-'America/Anchorage'
Moose1$DateTime <- mdy_hm(Moose1$DateTimeGMT, tz="GMT") #convert date format.
attributes(Moose1$DateTime)$tzone <-'America/Anchorage'
Moose2$DateTime <- mdy_hm(Moose2$DateTimeGMT, tz="GMT") #convert date format.
attributes(Moose2$DateTime)$tzone <-'America/Anchorage'

# format data, combine all french, combine all moose, combine french and moose
French2 <- French2[1:nrow(French1),] # French 2 has a few extra rows on it from when stopping logger. Stripping them.
French1$name <- "French1" #add column identifier
French2$name <- "French2"
allfrench <- bind_rows(French1, French2) # combine 1&2 into one dataframe French
Moose1$name <- "Moose1" #add column indentifier
Moose2$name <- "Moose2"
allmoose <- bind_rows(Moose1, Moose2) # combine 1&2 into one dataframe Moose
frenchmoose <- bind_rows(allfrench, allmoose) # combine all french and all moose

# Load in Q summary
Qsummary.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vT0R955lmRu0iaZFc-CxoVhwApmJuWaiHCYxhqICnY4oFH1sDI-VhRESmLFeuss01SYz0krWRktJ3oF/pub?output=csv" 
Qsummary <- read.csv(url(Qsummary.url))

Qsummary$Date <- mdy(Qsummary$Date)
Qsummary$DateTime <- as.POSIXct(paste(Qsummary$Date, Qsummary$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
Qsummary$DateTime <- lubridate::round_date(Qsummary$DateTime, "15 minutes")

```

##### Checking closeness between the two Pressure Transducers

1:1 line in green
```{r , echo=FALSE, warning=FALSE}

plot(x= French1$WaterLevelmeters[100:nrow(French1)], y=French2$WaterLevelmeters[100:nrow(French2)], 
     main = "French PT comparison", xlab = "French1 PT", ylab = "French2 PT")

plot(x= Moose1$WaterLevelmeters[100:nrow(Moose1)-15], y=Moose2$WaterLevelmeters[100:nrow(Moose2)-15], 
     main = "Moose PT comparison", xlab = "Moose1 PT", ylab = "Moose2 PT")

```

### French

```{r, echo=FALSE, warning=FALSE}
allfrench %>% 
  filter(WaterLevelmeters > 184) %>% 
  ggplot() + 
  geom_line(aes(x=DateTime, y=WaterLevelmeters, color=name), size=1.25) +
  theme_classic() +
  ggtitle("French") +
  scale_color_brewer(palette = "Paired")
```
There looks like an error when we calculated depth. Tom says that we can adjust the difference of the wrong one to make them agree, then remeasure them next year. French 2 also looks "noisier"
1) dumping French 2 

### Raw French 1
```{r, echo=FALSE, warning=FALSE}
plot(French1$DateTime, French1$WaterLevelmeters, type = "l")
```
The beginning is probably when this was installed, I will remove that. the spije in October is confirmed with French 2 so that is real. let the cleaning commence!
### French PT 1 2.0
```{r, echo=FALSE, warning=FALSE}
French1[c(1:47), 3] <- NA
plot(French1$DateTime, French1$WaterLevelmeters, type = "l")
```
1) set the beginning of the dataframe where PT was taking out of water points to NA
2) we are dumping French PT2 due to it being too "noisy"

### Raw Moose
```{r, echo=FALSE, warning=FALSE}

ggplot(data = allmoose, aes(x = DateTime, y = WaterLevelmeters, color = name))+
  geom_line()

```
Moose2 looks a little weird during mid July, where it doens't agree w/ Moose 1. Moose 2 seems a lot noisier....we are dumping moose 2

### Moose PT 1 2.0
```{r, echo=FALSE, warning=FALSE}
Moose1[c(1:38, 7191:7199), 3] <- NA
plot(Moose1$DateTime, Moose1$WaterLevelmeters, type = "l")

# removing the noise on the receding limb of the storm in september
Moose1.pre <- Moose1[-c(4639:7202), ] # clipping off the pre storm part
moos.stream.3 <- Moose2 %>% subset(Moose2$DateTime < "2018-09-08 00:00:00" & DateTime > "2018-09-02 21:30:00") # finding the receding limb in the PT2 dataset
Moose1.pre.middle <- rbind(Moose1.pre, moos.stream.3) # jpining the pre and new receding limb
Moose1.post <- Moose1[-c(1:4882), ] # clipping off through the storm
Moose1.pre.middle.post <- rbind(Moose1.pre.middle, Moose1.post) # joining the new dataframe

# cleaning vertical drop in the middle of september 
Moose1.pre.middle.post[c(5642:5662), 3] <- NA
plot(Moose1.pre.middle.post$DateTime, Moose1.pre.middle.post$WaterLevelmeters, type = "l")

```
1) Removed the beginning and end of the dataframe where the PT was out of water
2) Cleaned the receding limb of the september storm and replaced it with the receding limb from the second PT however now we get a steep drop for the end of the timeseries. Should I shift the back half of the dataframe up?
3) set middle of Setember vertical drop to NAs
4) still need to do NA INTERPRET!

### Observed Discharge at French and Moose

* from Rachel Voight For the days we used the HOBO, there are two "measurements" since I did not know which slug solution was used, so I calculated it with the two likely slug batches. We changed where we were measuring Q at Moose; the first two times we measured Q, we did it  downstream of the sensors near the actual pressure transducer. We likely underestimated Q for those few measurements at the old spot downstream of the sensors. 

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
ggplot(Qsummary) +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Site, shape=Method), size=3) +
 theme_classic() +
  scale_color_brewer(palette = "Set1")

a <- Qsummary %>% filter(Site == "Moose") %>% 
  ggplot() +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Method), size=3) +
  theme_classic() +
  ggtitle("Moose")

b <- Qsummary %>% filter(Site == "French") %>% 
  ggplot() +
  geom_point(aes(x=Date, y=MeasuredQ_Ls, color=Method), size=3) +
  theme_classic() +
  ggtitle("French")
```

```{r, echo=FALSE, fig.width=10, fig.height=4, warning=FALSE}
grid.arrange(a,b, ncol=2)
```

###  Raw Rating Curve with Moose 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
Qsummary.MO <- Qsummary  %>% 
  filter(Site == "Moose") 
moose1comb <- full_join(Moose1.pre.middle.post, Qsummary.MO) 

ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 
Moose1.lm <- lm(moose1comb$MeasuredQ_Ls ~ moose1comb$WaterLevelmeters)
summary(Moose1.lm)
```
* Rachel -While we only had 4 measurements from the flow meter, they agree well with our trendline and slug Q.
*Jake - I will remove the Hobo points in this regression 

```{r, echo=FALSE, warning=FALSE}
Qsummary.MO <- Qsummary  %>% 
  filter(Site == "Moose") 
Qsummary.MO.1 <- Qsummary.MO[-c(9:10), ] # removing HOBO points
moose2comb <- full_join(Moose1.pre.middle.post, Qsummary.MO.1) 

ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=moose2comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = y ~ x, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  scale_x_continuous(limits = c(166.2,167)) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 
Moose2.lm <- lm(moose2comb$MeasuredQ_Ls ~ moose2comb$WaterLevelmeters)
summary(Moose2.lm)
```
1) removed the HOBO ware points 

## Estimated Q from Moose 1 PT. 
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
moose2comb$pred.moose1.Q <- coef(Moose2.lm)[2] * moose2comb$WaterLevelmeters + coef(Moose2.lm)[1]
ggplot(aes(x=DateTime, y=pred.moose1.Q), data=moose2comb) +
  geom_line(color="#A6CEE3", size=1.25) +
 geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=2) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  scale_y_continuous(name = "Predicted Discharge L/s") +
  scale_x_datetime(name = "Time")

```

This is the final discharge plot from the RC without the HOBO ware points  

## French Creek

### Raw Rating Curve French 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
Qsummary.FR <- Qsummary  %>% #filter out measured Q at just french
  filter(Site == "French") 

French1comb <- full_join(French1, Qsummary.FR) 
ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French1comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = y ~ x, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  scale_x_continuous(limits = c(184.2,184.9)) +
  theme_classic() +
  ggtitle("French1 all measured Q") 
French1.lm <- lm(French1comb$MeasuredQ_Ls ~ French1comb$WaterLevelmeters)
summary(French1.lm)
```
Will remove the two HOBOware points

```{r, echo=FALSE, warning=FALSE}
Qsummary.FR.1 <- Qsummary.FR[-c(8:9), ] # removing the HOBOWare points 

French2comb <- full_join(French1, Qsummary.FR.1) 

ggplot(aes(x=WaterLevelmeters, y=MeasuredQ_Ls), data=French2comb) +
  geom_point(aes( color=Method), size=3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = y ~ x, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  scale_x_continuous(limits = c(184.2,184.9)) +
  theme_classic() +
  ggtitle("French1 all measured Q") 

French2.lm <- lm(French2comb$MeasuredQ_Ls ~ French2comb$WaterLevelmeters)
summary(French1.lm)
```
1) Removed the HOBOware points

## French 1 Calculated Q (L/s)
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
French2comb$pred.french1.Q <- coef(French2.lm)[2] * French2comb$WaterLevelmeters + coef(French2.lm)[1]
ggplot(aes(x=DateTime, y=pred.french1.Q), data=French2comb) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, shape=Method), size=3) +
  theme_classic() +
  ggtitle("French1 predicted all measured Q") +
  scale_y_continuous(name = "Discharge L/s") +
  scale_x_datetime(name = "Time")


```
This doesnt look too shabby!

* We rock at discharge!!!

################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

2019 data is read from DoD->2019 AK sensors->2019 Sensor data ->PT->DoD 2019 PT depth corrected for atm  
Wading rods and slugs were used to measure discrete Q during site visit
Includes all sites (Moose, French, Poker, Vault, Stuart)

#2019 data is read in from DoD->2019 ak sensors->2019 sensor data->Q -> Pressure Transducer Data->Depth->'site'
```{r, include=FALSE, warning=FALSE}
# Import processed Q data
### Import Data ###
frch.stream.2019.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vStPTLYv7j4tC3hGRHQ3rW8oCTx9_I0bekcLBjCl4jKQT8GLImI_hXp9qq6UsmdVAaPd7vr4r3BsLZJ/pub?output=csv"
frch.stream.2019.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQmHJ-1aQ_8UWAPq-v_us3gz-JTv7vsdVVKNnnMUloJwJNK7TTgvU8kLeUOCbIYU_mHz8v1k1CFz2Vl/pub?output=csv"
vaul.stream.2019.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSo7CfzMCKXdPmdVZ2c8tJQ-_NzKkje0QWYIseiLxH82hJeJZZ1wtiuL6ZleDoEaPPJMzuWdqB3NaAQ/pub?output=csv"
poke.stream.2019.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5CEMDu-NFH49FcPmbf_QglRqVaEV-0xgcGJWz3kWuuGP8pwI-OhXtSZCwN4uwBlOq0CuuQ9tMYLXX/pub?output=csv"
poke.stream.2019.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTInrTbsXhYZ0Hcn0YZIBF7LWimNdO0V1e_06hKNaIriwxszvphODlUDfRnT_5_Xgi63k2WFW4q8EKm/pub?output=csv"
strt.stream.2019.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgVqJmbVgtXVDGQL_SiQqHphyUBuXG-w0bCk8mLn-IksFrqg3PMvRveGizqHM9lhq_rhqozKseAD_7/pub?output=csv"
strt.stream.2019.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRNwL17hN8tMuyzDCDKCTeXGjQ1eN7j881D0-pyi46PhTK7LwoqQ_jrwZWQrSypd3icId9KFpqsuatj/pub?output=csv"
moos.stream.2019.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQMF0fbfNRwgU-9DfsCJ7LpPd_LoAL01gcSdHzNIFXJ5sSnXwH8Vvsqyj_nZAeWVcXGDWhyJP2TbjZq/pub?output=csv"

FRCH_RainGauge_2019 <- read.csv("~/Documents/DoD_2019/RainGauge/FRCH.RainGauge.2019.csv")
FRCH_RainGauge_2019$Datetime <-  ymd_hms(FRCH_RainGauge_2019$Datetime)
attributes(FRCH_RainGauge_2019$Datetime)$tzone <-'America/Anchorage'

POKE_RainGauge_2019 <- read.csv("~/Documents/DoD_2019/RainGauge/POKE.RainGauge.2019.csv")
POKE_RainGauge_2019$DateTime <- ymd_hms(POKE_RainGauge_2019$DateTime)
attributes(POKE_RainGauge_2019$DateTime)$tzone <- 'America/Anchorage'

VAUL_RainGauge_2019 <- read.csv("~/Documents/DoD_2019/RainGauge/VAUL.RainGauge.2019.csv")
VAUL_RainGauge_2019$DateTime <- ymd_hms(VAUL_RainGauge_2019$DateTime)
attributes(VAUL_RainGauge_2019$DateTime)$tzone <- 'America/Anchorage'

### read in data ###
frch.stream.one.2019 <- read.csv(url(frch.stream.2019.url))
frch.stream.two.2019 <- read.csv(url(frch.stream.2019.url.two))
vaul.stream.one.2019 <- read.csv(url(vaul.stream.2019.url))
poke.stream.one.2019 <- read.csv(url(poke.stream.2019.url))
poke.stream.two.2019 <- read.csv(url(poke.stream.2019.url.two))
strt.stream.one.2019 <- read.csv(url(strt.stream.2019.url)) # only goes to august
strt.stream.two.2019 <- read.csv(url(strt.stream.2019.url.two)) # goes all the way to october.
moos.stream.one.2019 <- read.csv(url(moos.stream.2019.url))

# Rename column headers # 
names(frch.stream.one.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(frch.stream.two.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(vaul.stream.one.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(poke.stream.one.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(poke.stream.two.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(strt.stream.one.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(strt.stream.two.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")
names(moos.stream.one.2019) <- c("Site", "DateTimeGMT", "Temp", "AbsPTDepth")

# Input NA for missing time #
frch.stream.one.2019$DateTimeGMT[frch.stream.one.2019$DateTimeGMT == ""] <- NA
frch.stream.two.2019$DateTimeGMT[frch.stream.two.2019$DateTimeGMT == ""] <- NA

vaul.stream.one.2019$DateTimeGMT[vaul.stream.one.2019$DateTimeGMT == ""] <- NA

poke.stream.one.2019$DateTimeGMT[poke.stream.one.2019$DateTimeGMT == ""] <- NA
poke.stream.two.2019$DateTimeGMT[poke.stream.two.2019$DateTimeGMT == ""] <- NA

strt.stream.one.2019$DateTimeGMT[strt.stream.one.2019$DateTimeGMT == ""] <- NA
strt.stream.two.2019$DateTimeGMT[strt.stream.two.2019$DateTimeGMT == ""] <- NA

moos.stream.one.2019$DateTimeGMT[moos.stream.one.2019$DateTimeGMT == ""] <- NA

# Convert time and put in AK time #
frch.stream.one.2019$DateTime <- as.POSIXct(paste(frch.stream.one.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
frch.stream.one.2019$DateTime <- lubridate::round_date(frch.stream.one.2019$DateTime, "15 minutes")
frch.stream.two.2019$DateTime <- as.POSIXct(paste(frch.stream.two.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
vaul.stream.one.2019$DateTime <- as.POSIXct(paste(vaul.stream.one.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
poke.stream.one.2019$DateTime <- as.POSIXct(paste(poke.stream.one.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
poke.stream.one.2019$DateTime <- lubridate::round_date(poke.stream.one.2019$DateTime, "15 minutes")
poke.stream.two.2019$DateTime <- as.POSIXct(paste(poke.stream.two.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
strt.stream.one.2019$DateTime <- as.POSIXct(paste(strt.stream.one.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
strt.stream.two.2019$DateTime <- as.POSIXct(paste(strt.stream.two.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
moos.stream.one.2019$DateTime <- as.POSIXct(paste(moos.stream.one.2019$DateTimeGMT), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")

# Observed discharge
myurl <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUMy2yDlF5WQRDGgbuNHeVNp7diusfPJuKgikGY2ZQ8ewbG4Tyxm5TeN0shtDkxMmeL9M0AzhaL8l7/pub?output=csv"
QSummary.2019 <- read.csv(url(myurl))

QSummary.2019$Time[QSummary.2019$Time == ""] <- NA
QSummary.2019$Q_Ls[QSummary.2019$Q_Ls == ""] <- NA

### Format Time ###
QSummary.2019$Date <- mdy(QSummary.2019$Date)
QSummary.2019$DateTime <- as.POSIXct(paste(QSummary.2019$Date, QSummary.2019$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
QSummary.2019$DateTime <- lubridate::round_date(QSummary.2019$DateTime, "15 minutes")

```


##### Checking closeness between the two Pressure Transducers
```{r , echo=FALSE, warning=FALSE}
frch.stream.two.2019 <- frch.stream.two.2019[1:nrow(frch.stream.one.2019),]
frch.stream.one.2019$Site <- "FRCH1" #add column identifier
frch.stream.two.2019$Site <- "FRCH2"
frch.pt.2019 <- bind_rows(frch.stream.one.2019, frch.stream.two.2019)

vaul.pt.2019 <- vaul.stream.one.2019
vaul.pt.2019$Site <- "VAUL1"

poke.stream.two.2019 <- poke.stream.two.2019[1:nrow(poke.stream.one.2019),]
poke.stream.one.2019$Site <- "POKE1" #add column identifier
poke.stream.two.2019$Site <- "POKE2"
poke.pt.2019 <- bind_rows(poke.stream.one.2019, poke.stream.two.2019)

moos.pt.2019 <- moos.stream.one.2019
moos.pt.2019$Site <- "MOOS1"

# Checking closeness between two PT #
plot(x = frch.stream.one.2019$AbsPTDepth, y = frch.stream.two.2019$AbsPTDepth, main = "French PT comparison",
     xlab = "French1 PT", 
     ylab = "French2 PT")
abline(1,1) 

```
Looks pretty good

##### Checking Raw PT data 

## Raw Moose
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-05-31 15:45:00","2019-10-22 09:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.one.2019$DateTime, moos.stream.one.2019$AbsPTDepth, type = 'l')
```
let the cleaning commence!
## Moose 2.0 ##
```{r, echo=FALSE, warning=FALSE}
moos.stream.one.2019 <- moos.stream.one.2019[-c(3715, 5179,5342), ]
plot(moos.stream.one.2019$DateTime, moos.stream.one.2019$AbsPTDepth, type = 'l')
```
1)removed vertical bars in dataframe
? Spike in early Julyish does have rainfall close to it....is it real?
Middle of October? Ice on? Should I clip middle of October, French was removed on October 10th according to the field notebook 

### Observed Discharge at all sites 

Slugs and wading rods were used for 2019 observed Q

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
# ALL Sites #
all <- ggplot(QSummary.2019) +
  geom_point(aes(x=DateTime, y=Q_Ls, color=Site), size=3) +
  theme_classic() +
  scale_color_brewer(palette = "Set1") +
  ggtitle("ALL SITES")
all

a <- QSummary.2019 %>% filter(Site == "Moose") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = Q_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Moose")
a

b <- QSummary.2019 %>% filter(Site == "French") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = Q_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("French")
b

c <- QSummary.2019 %>% filter(Site == "Poker") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = Q_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Poker")
c

d <- QSummary.2019 %>% filter(Site == "Vault") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = Q_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Vault")
d

e <- QSummary.2019 %>% filter(Site == "Stuart") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = Q_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart")
e

plot_grid(all, NA,
          a, b,
          c,d,
          e,
          nrow = 4, ncol = 2)
```
### Raw Rating Curve with Moose 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
QSummary.MO.2019 <- QSummary.2019 %>% filter(Site =="Moose")

QSummary.MO.2019$Site <- "MOOS"
moos.stream.one.2019$Site <- "MOOS"

Moose1comb.2019 <- full_join(moos.stream.one.2019, QSummary.MO.2019) 

Moose1.lm.2019 <- lm(Moose1comb.2019$Q_Ls ~ Moose1comb.2019$AbsPTDepth)
summary(Moose1.lm.2019) # I think this worked

moos.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Moose1comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.9, 1.8) + 
  theme_classic() +
  ggtitle("Moose1 all measured Q")  # I think this worked


```
Not too shabby, im going to remove the top YSI point

### Raw Rating Curve with Moose 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
QSummary.MO.2019.1 <- QSummary.MO.2019[-16, ]


Moose2comb.2019 <- full_join(moos.stream.one.2019, QSummary.MO.2019.1) 

Moose2.lm.2019 <- lm(Moose2comb.2019$Q_Ls ~ Moose2comb.2019$AbsPTDepth)
summary(Moose2.lm.2019) # I think this worked

moos.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Moose2comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.9, 1.8) + 
  theme_classic() +
  ggtitle("Moose1 all measured Q")  # I think this worked


```
That's better, I will use this for the predicted discharge 

### Predicted Q MOOS PT1
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Moose2comb.2019$pred.moos1.Q <- coef(Moose2.lm.2019)[2] * Moose2comb.2019$AbsPTDepth+ coef(Moose2.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moose2comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 
```
Not too shabby

## Raw French PT1
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-04-29 14:15:00","2019-10-10 09:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.one.2019$DateTime, frch.stream.one.2019$AbsPTDepth, type = 'l')
```
Looks good. I am going to replace the noisy-ness of the receding limb in the big august storm with FRCH PT2 as it is less noisy let the cleaning commence!

# FRCH PT1 2.0 #
```{r, echo=FALSE, warning=FALSE}
which(frch.stream.one.2019$AbsPTDepth > 2.40) 
frch.stream.one.2019.1 <- frch.stream.one.2019 %>% subset(frch.stream.one.2019$DateTime < "2019-08-24 00:00:00" & frch.stream.one.2019$DateTime > "2019-08-17 00:00:00") 

frch.stream.one.2019.before <- frch.stream.one.2019[-c(10549:15724), ]  # clipping off to have beginning of dataframe

frch.stream.two.middle <- frch.stream.two.2019[-c(1:10549, 11162:15724), ]

frch.stream.one.2019.after <- frch.stream.one.2019[-c(1:11162), ]  # clipping off to have beginning of dataframe

frch.stream.one.all <- rbind(frch.stream.one.2019.before, frch.stream.two.middle, frch.stream.one.2019.after)
plot(frch.stream.one.all$DateTime, frch.stream.one.all$AbsPTDepth, type = "l")
frch.stream.one.2019 <- frch.stream.one.all
plot(frch.stream.one.2019$DateTime, frch.stream.one.2019$AbsPTDepth, type = 'l')
```
1) replaced the noisy receding limb in the big end of August storm of PT1 with the more constant data of PT2

## Raw French PT2
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-04-29 14:15:00","2019-10-10 09:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2019$DateTime, frch.stream.two.2019$AbsPTDepth, type = 'l')

```
Going to clean some of the vertical bars in may but other than that this looks pretty good!
let the cleaning commence 
## FRCH PT2 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2019 <- frch.stream.two.2019[-c(107,108,389,610,964),] 
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-04-29 14:15:00","2019-10-10 09:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2019$DateTime, frch.stream.two.2019$AbsPTDepth, type = 'l')

```
1) removed vertical bars early on in season 

### Raw Rating Curve with French 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
QSummary.FR.2019 <- QSummary.2019 %>% filter(Site =="French") %>% drop_na(Q_Ls)
QSummary.FR.2019$Site <- "FRCH"
frch.stream.one.2019$Site <- "FRCH"

French1comb.2019 <- full_join(frch.stream.one.2019, QSummary.FR.2019) 
French1.lm.2019 <- lm(French1comb.2019$Q_Ls ~ French1comb.2019$AbsPTDepth)
summary(French1.lm.2019)  # Worked

frch.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = French1comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French1 all measured Q")


```
Lots of points that are clustered at the bottom. I will remove the 3 large YSI points 

```{r, echo=FALSE, warning=FALSE}
QSummary.FR.2019.1 <- QSummary.FR.2019[-c(11:13), ]

French2comb.2019 <- full_join(frch.stream.one.2019, QSummary.FR.2019.1) 
French2.lm.2019 <- lm(French2comb.2019$Q_Ls ~ French2comb.2019$AbsPTDepth)
summary(French2.lm.2019)  # Worked

frch.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = French2comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.55, 0.70) +
  ylim(0, 300) +
  theme_classic() +
  ggtitle("French1 all measured Q")


```
Not as good of an R^2 

### Raw Rating Curve with French 2 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2019$Site<- "FRCH"

French3comb.2019 <- full_join(frch.stream.two.2019, QSummary.FR.2019) 
French3.lm.2019 <- lm(French3comb.2019$Q_Ls ~ French3comb.2019$AbsPTDepth)
summary(French3.lm.2019) # worked


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = French3comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French2 all measured Q")


```
Same thing as FRCH 1. Next plot will be without the 3 high YSI points

```{r, echo=FALSE, warning=FALSE}

French4comb.2019 <- full_join(frch.stream.two.2019, QSummary.FR.2019.1) 
French4.lm.2019 <- lm(French4comb.2019$Q_Ls ~ French4comb.2019$AbsPTDepth)
summary(French2.lm.2019)  # Worked

frch.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = French4comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.4, 0.5) +
  theme_classic() +
  ggtitle("French2 all measured Q")


```
I will remove the low flowmeter point for the next plot

```{r, echo=FALSE, warning=FALSE}
QSummary.FR.2019.2 <- QSummary.FR.2019[-10, ]

French5comb.2019 <- full_join(frch.stream.two.2019, QSummary.FR.2019.2) 
French5.lm.2019 <- lm(French5comb.2019$Q_Ls ~ French5comb.2019$AbsPTDepth)
summary(French5.lm.2019)  # Worked

frch.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = French5comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.4, 0.5) +
  ylim(0,500) +
  theme_classic() +
  ggtitle("French2 all measured Q")


```
This is the RC I will use for predicted Q

### Predicted Q FRCH PT1
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
French2comb.2019$pred.french1.Q <- coef(French2.lm.2019)[2] * French2comb.2019$AbsPTDepth+ coef(French2.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.french1.Q), data=French2comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("French") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  ylim(0, 1000) +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))
```
Without a big range in observed Q this is the best we can do 

### Predicted Q FRCH PT2
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
French5comb.2019$pred.french1.Q <- coef(French5.lm.2019)[2] * French5comb.2019$AbsPTDepth+ coef(French5.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.french1.Q), data=French5comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("French") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  ylim(0, 4000) +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))

```
This gives us much higher Q

### Compare FRCH PT1 and PT2
```{r, echo=FALSE, warning=FALSE}

French2comb.2019$DateTime <- lubridate::round_date(French2comb.2019$DateTime, "15 minutes")
French2comb.2019 <- French2comb.2019[-c(15721:15723), ]

frch.final.discharge.2019 <- data.frame(French5comb.2019$Site, French5comb.2019$DateTime, French2comb.2019$pred.french1.Q, French5comb.2019$pred.french1.Q)

frch.final.discharge.2019$MeanDischarge <- rowMeans(frch.final.discharge.2019[,c(3:4)], na.rm = TRUE)
names(frch.final.discharge.2019) <- c("Site", "DateTime", "PT1Q", "PT2Q", "MeanDischarge")

ggplot(aes(x = DateTime, y = pred.french1.Q), data = French2comb.2019) +
  geom_line(aes(x = DateTime, y = pred.french1.Q), data = French2comb.2019, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.french1.Q), data = French5comb.2019,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = frch.final.discharge.2019, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = Q_Ls), size=2) +
  theme_classic() +
  ylim(0, 5000) +
  ggtitle("Frecnh1(light) French2(dark) & MeanDischarge (red) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```
When it comes to the higher Q they are way off. 

## Raw Poker PT1
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2019$inst_rainfall_mm ~ POKE_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-05-10 14:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.one.2019$DateTime, poke.stream.one.2019$AbsPTDepth, type = 'l')

```
THe beginning increase appears to be real with the precip on top. I need to remove some of the "vertical bars within the data frame and check take out date. I am also going to take out the beaver dam tha is there from late august to middle of september  Let the cleaning commence!

```{r, echo=FALSE, warning=FALSE}
poke.stream.one.2019 <- poke.stream.one.2019[-c(15015:15439), ] # remove out of water points - PT removed on the 14th
poke.stream.one.2019[c(3359:3365, 5959:5967, 6517:6530, 7296:7300), 4] <- NA  # remove vertical bars...set to NA

poke.stream.one.2019 <- poke.stream.one.2019[-c(10406:11611), ] # remove beaver dam 

plot(POKE_RainGauge_2019$inst_rainfall_mm ~ POKE_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-05-10 14:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.one.2019$DateTime, poke.stream.one.2019$AbsPTDepth, type = 'l')

```
1) Removed vertical bars early on in dataset
2) Removed beaver dam related data entirely
3) removed end of season out of water points

## Raw Poker PT2
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2019$inst_rainfall_mm ~ POKE_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-05-10 14:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2019$DateTime, poke.stream.two.2019$AbsPTDepth, type = 'l')
```
Same procedure as PT1....let the cleaning commence!

```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2019 <- poke.stream.two.2019[-c(9738:11227, 14634:15058), ] # remove out of water points - PT removed on the 14th and the beaver dam
poke.stream.two.2019[c(4, 2978:2983, 5578:5587,6137:6150, 6913:6920), 4] <- NA  # remove vertical bars...set to NA

plot(POKE_RainGauge_2019$inst_rainfall_mm ~ POKE_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-05-10 14:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2019$DateTime, poke.stream.two.2019$AbsPTDepth, type = 'l')

# 
```
1) Removed vertical bars early on in dataset
2) Removed beaver dam related data entirely
3) removed end of season out of water points

### Raw Rating Curve with Poker 1 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
QSummary.PO.2019 <- QSummary.2019 %>% filter(Site =="Poker") %>% drop_na(Q_Ls)
QSummary.PO.2019$Site <- "POKE"
poke.stream.one.2019$Site <- "POKE"

Poker1comb.2019 <- full_join(poke.stream.one.2019, QSummary.PO.2019)
Poker1.lm.2019 <- lm(Poker1comb.2019$Q_Ls ~ Poker1comb.2019$AbsPTDepth)
summary(Poker1.lm.2019) 

poke.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Poker1comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0, 0.6) +
  theme_classic() +
  ggtitle("Poker1 all measured Q")

```
I will remove the highest flowmeter point

```{r, echo=FALSE, warning=FALSE}
QSummary.PO.2019.1 <- QSummary.PO.2019[-9, ]
Poker2comb.2019 <- full_join(poke.stream.one.2019, QSummary.PO.2019.1)
Poker2.lm.2019 <- lm(Poker2comb.2019$Q_Ls ~ Poker2comb.2019$AbsPTDepth)
summary(Poker2.lm.2019) 

poke.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Poker2comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0, 0.6) +
  theme_classic() +
  ggtitle("Poker1 all measured Q")
```
Worse R^2, Ill use the raw one

### Predicted Q POKE PT1
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Poker1comb.2019$pred.poke1.Q <- coef(Poker1.lm.2019)[2] * Poker1comb.2019$AbsPTDepth+ coef(Poker1.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.poke1.Q), data=Poker1comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  ylim(0, 1500) +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))
```

Not the worst thing I've seen in the world 

### Raw Rating Curve with Poker 2 Pressure Transducer

```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2019$Site <- "POKE"

Poker2comb.2019 <- full_join(poke.stream.two.2019, QSummary.PO.2019)
Poker2.lm.2019 <- lm(Poker2comb.2019$Q_Ls ~ Poker2comb.2019$AbsPTDepth)
summary(Poker2.lm.2019)

ggplot(aes(x= AbsPTDepth, y = Q_Ls), data = Poker2comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(0.3,0.6) +
  theme_classic() +
  ggtitle("Poker2 all measured Q") 

```
### Predicted Q POKE PT2
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Poker2comb.2019$pred.poke2.Q <- coef(Poker2.lm.2019)[2] * Poker2comb.2019$AbsPTDepth+ coef(Poker2.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.poke2.Q), data=Poker2comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker2 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") +
  ylim(0, 2000)

```

### Average POKE Q ###
```{r, echo=FALSE, warning=FALSE}
poke.final.discharge.2019 <- left_join(Poker1comb.2019, Poker2comb.2019, by = c("DateTime"))
poke.final.discharge.2019$MeanDischarge <- rowMeans(poke.final.discharge.2019[,c(13,25)], na.rm = TRUE)
poke.final.discharge.2019 <- poke.final.discharge.2019[,-c(3:12, 14:24)] # cleaning empty columns
names(poke.final.discharge.2019) <- c("Site", "DateTime", "PT1", "PT2", "MeanDischarge")
poke.final.discharge.2019$DateTime <- as.POSIXct(paste(poke.final.discharge.2019$DateTime), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
poke.final.discharge.2019$DateTime <- lubridate::round_date(poke.final.discharge.2019$DateTime, "15 minutes")
poke.final.discharge.2019 <- poke.final.discharge.2019 %>% subset(poke.final.discharge.2019$DateTime < "2019-10-10") # removed on 10/18

ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poker1comb.2019) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poker1comb.2019, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poker2comb.2019,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2019, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = Q_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("Poker1(light) Poker2(dark) & MeanDischarge (red) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```

## Raw Vault PT1
```{r, echo=FALSE, warning=FALSE}
plot(VAUL_RainGauge_2019$inst_rainfall_mm ~ VAUL_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-06-07 17:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.one.2019$DateTime, vaul.stream.one.2019$AbsPTDepth, type = 'l')

```
Out of water at the end of the year? Let the cleaning commence!

```{r, echo=FALSE, warning=FALSE}
vaul.stream.one.2019.1 <- vaul.stream.one.2019 %>% subset(vaul.stream.one.2019$DateTime > "2019-06-07" & vaul.stream.one.2019$DateTime < "2019-10-09") # removed on 10/18


plot(VAUL_RainGauge_2019$inst_rainfall_mm ~ VAUL_RainGauge_2019$DateTime, type="h",
     xlim = as.POSIXct(c("2019-06-07 17:45:00","2019-10-18 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.one.2019.1$DateTime, vaul.stream.one.2019.1$AbsPTDepth, type = 'l')

# 
```
1) Removed end of record as there were erroneous points that might have been from ice on and then also out of water points 

### Raw Rating Curve with VAUL PT1

```{r, echo=FALSE, warning=FALSE}
QSummary.VA.2019 <- QSummary.2019 %>% filter(Site =="Vault") %>% drop_na(Q_Ls)
vaul.stream.one.2019$Site <- "VAUL"
QSummary.VA.2019$Site <- "VAUL"

Vaultcomb.2019 <- full_join(vaul.stream.one.2019, QSummary.VA.2019)

Vault.lm.2019<- lm(Vaultcomb.2019$Q_Ls ~ 0 + Vaultcomb.2019$AbsPTDepth)
summary(Vault.lm.2019)

vaul.formula <- y ~ x

ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Vaultcomb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = vaul.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),
               parse = TRUE) +
  xlim(0.4, 0.65) +
  theme_classic() +
  ggtitle("Vault all measured Q")  # I think this worked

```
 Maybe I can take the high points about the line but i am going to keep it for right now
 
 ### Predicted Q VAULPT1
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Vaultcomb.2019$pred.vault.Q <- coef(Vault.lm.2019)[1] * Vaultcomb.2019$AbsPTDepth
ggplot(aes(x = DateTime, y = pred.vault.Q), data = Vaultcomb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Vault") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))

```
Not great.....

## Raw Stuart PT1
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-05-21 14:45:00","2019-08-23 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.one.2019$DateTime, strt.stream.one.2019$AbsPTDepth, type = 'l')

```
Stuart PT1 only has record until 8/23... Looks pretty clean though

## Raw Stuart PT2
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-05-21 14:45:00","2019-10-16 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2019$DateTime, strt.stream.two.2019$AbsPTDepth, type = 'l')

```
Just looks like I need to clip out the end of the season points there...Let the cleaning commence!

### STRT PT2 2.0 ###
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2019 <- strt.stream.two.2019 %>% subset(strt.stream.two.2019$DateTime > "2019-05-21" & strt.stream.two.2019$DateTime < "2019-10-13") # removed on 10/16 but erroneous values starting after the 14th....maybe ice...maybe beaver dam?

plot(FRCH_RainGauge_2019$inst_rainfall_mm ~ FRCH_RainGauge_2019$Datetime, type="h",
     xlim = as.POSIXct(c("2019-05-21 14:45:00","2019-10-16 10:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2019$DateTime, strt.stream.two.2019$AbsPTDepth, type = 'l')

# 
```
1) removed out of water points at the end of the season

### Raw Rating Curve with STRT PT1

```{r, echo=FALSE, warning=FALSE}
QSummary.ST.2019 <- QSummary.2019 %>% filter(Site =="Stuart") %>% drop_na(Q_Ls)
QSummary.ST.2019$Site<- "STRT"
strt.stream.one.2019$Site<- "STRT"

Stuart1comb.2019 <- full_join(strt.stream.one.2019, QSummary.ST.2019)
Stuart1.lm.2019 <- lm(Stuart1comb.2019$Q_Ls ~ Stuart1comb.2019$AbsPTDepth)
summary(Stuart1.lm.2019) 


strt.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Stuart1comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart1 all measured Q")

```
I think the first time I did this RC we ook out the two large Flowmeter calculations but then that gives us a negative relationship which makes the predicted Q really bad 

### Raw Rating Curve with STRT PT2

```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2019$Site<- "STRT"

Stuart2comb.2019 <- full_join(strt.stream.two.2019, QSummary.ST.2019)
Stuart2.lm.2019 <- lm(Stuart2comb.2019$Q_Ls ~ Stuart2comb.2019$AbsPTDepth)
summary(Stuart2.lm.2019) 


strt.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Stuart2comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```
I am going to remove the high YSI pointt

### Rating Curve with STRT PT2 2.0

```{r, echo=FALSE, warning=FALSE}

QSummary.ST.2019.1 <- QSummary.ST.2019[-10, ]

Stuart3comb.2019 <- full_join(strt.stream.two.2019, QSummary.ST.2019.1)
Stuart3.lm.2019 <- lm(Stuart3comb.2019$Q_Ls ~ Stuart3comb.2019$AbsPTDepth)
summary(Stuart3.lm.2019) 


strt.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Stuart3comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```
Ill remove the high flowmeter 

### Rating Curve with STRT PT2 2.0

```{r, echo=FALSE, warning=FALSE}

QSummary.ST.2019.2 <- QSummary.ST.2019[-c(10,11), ]

Stuart4comb.2019 <- full_join(strt.stream.two.2019, QSummary.ST.2019.2)
Stuart4.lm.2019 <- lm(Stuart4comb.2019$Q_Ls ~ Stuart4comb.2019$AbsPTDepth)
summary(Stuart4.lm.2019) 


strt.formula <- y ~ x


ggplot(aes(x = AbsPTDepth, y = Q_Ls), data = Stuart4comb.2019) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```
1)Removed top flowmeter and YSI point

### Predicted Q STRT PT1
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Stuart1comb.2019$pred.stuart1.Q <- coef(Stuart1.lm.2019)[2] * Stuart1comb.2019$AbsPTDepth+ coef(Stuart1.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.stuart1.Q), data=Stuart1comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  ylim(0, 10000) +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))

```

### Predicted Q STRT PT2
#### Black points are observed Q

```{r, echo=FALSE, warning=FALSE}
Stuart4comb.2019$pred.stuart2.Q <- coef(Stuart4.lm.2019)[2] * Stuart4comb.2019$AbsPTDepth+ coef(Stuart4.lm.2019)[1]
ggplot(aes(x = DateTime, y = pred.stuart2.Q), data=Stuart4comb.2019) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = Q_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  ylim(0, 8000) +
  scale_x_datetime(limits = as_datetime(c("2019-05-15", "2019-10-10")))


```

### Average STRT Q ###

```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2019 <- left_join(Stuart1comb.2019, Stuart4comb.2019, by = c("DateTime"))
strt.final.discharge.2019$MeanDischarge <- rowMeans(strt.final.discharge.2019[,c(13,25)], na.rm = TRUE)
strt.final.discharge.2019 <- strt.final.discharge.2019[,-c(3:12, 14:24)] # cleaning empty columns
strt.final.discharge.2019 <- na.omit(strt.final.discharge.2019) # Remove data points that after removal
names(strt.final.discharge.2019) <- c("Site", "DateTime", "PT1", "PT2", "MeanDischarge")

strt.final.discharge.2019$DateTime <- as.POSIXct(paste(strt.final.discharge.2019$DateTime), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
strt.final.discharge.2019$DateTime <- lubridate::round_date(strt.final.discharge.2019$DateTime, "15 minutes")


ggplot(aes(x = DateTime, y = pred.stuart2.Q), data = Stuart2comb.2019) +
  geom_line(aes(x = DateTime, y = pred.stuart1.Q), data = Stuart1comb.2019, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.stuart2.Q), data = Stuart4comb.2019,color="red", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = strt.final.discharge.2019, color = "#1F78B4", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = Q_Ls), size=2) +
  theme_classic() +
  ylim(0, 10000) +
  ggtitle("Stuart1(light) Stuart2(dark) & MeanDischarge (red) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")


```


################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

2020 (Moose, French, Poker, Vault, Stuart), and 2021 (Moose, French, Poker, Vault, Stuart), clean out of water points, potentially erroneous points collected, beaver dams, etc. and prepare to convert to continuous predicted discharge (Q) throuhgout the year. 

2020 data is read in from DoD Project->2020 AK sensors->Discharge->Pressure Transducer->Water Level->"site"

```{r, include=FALSE, warning=FALSE}
# Import processed Q data
### Import Data ###
moos.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_IoyPoUK6tDeBoPsTibXES49eORxi6SUzt5Df3iSmMmIXncaIAQWlsmzKwjecJelrcKDL3rryyKjS/pub?output=csv"
moos.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRb88DUzb4g2wJjmw0wfBatqS6Hg90epELO1sMlnQfzuI0t7aTWuqXYIY18r-T8mt0koTH4gc041PxL/pub?output=csv"
frch.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQQ0F4a3e4MTwKTChJmS3GTwC_ENETsM_CoJNq6awdnXzXnl1nQKizm63JjFg3WUbXZusXBLt_DNcMX/pub?output=csv"
frch.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRtJhzv4dunVMRCmolhShz29XDicFk2wFafUUC4ZDWaOs7z-5Q--vEJWCcYJsVEikjXYql6fc3TZV63/pub?output=csv"
strt.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSE57c7ol5XBElx6nIOm4fl4UFB5qgffo49nSw2RuJ_kIZAC43vLusqtjQy5h2h3bNikmJwDvIBEO7X/pub?output=csv"
strt.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSPRQxqqKl_N36uEzbMC1_T5v8k67aUyJhhMYZvsmwJKafU2NmL1NtbmOW8BvtqWqxSTY3ndYnjzy_f/pub?output=csv"
vaul.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRVA4AxNNaYJY6hJCD7c7Y4jloR68x1Zols2Grg7xiKx-gVQlqh5yb3e3L5XkFUXyRn0GnD1nRi_XXJ/pub?output=csv"
poke.stream.2020.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQwtaiz8D9c4QelUMsM5BwCMu4lu_Eqlo6IwTC0s-MXE-a075hQ4xgEvMovGrrMuv9_qX7cCYJvISrN/pub?output=csv"
poke.stream.2020.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuyeltwK25QUepwlUKTSL9SAFCwgTtxs6YscILt_npSKjFV1mY5DVrs-RxGivvpg7ZCKfGuej0DOJO/pub?output=csv"

# Load Data#
moos.stream.one.2020 <- read.csv(url(moos.stream.2020.url), skip = 491) # started in lab it looks like 
moos.stream.two.2020 <- read.csv(url(moos.stream.2020.url.two), skip = 1)

frch.stream.one.2020 <- read.csv(url(frch.stream.2020.url), skip = 1)
frch.stream.two.2020 <- read.csv(url(frch.stream.2020.url.two), skip = 4)


strt.stream.one.2020 <- read.csv(url(strt.stream.2020.url), skip = 1)
strt.stream.two.2020 <- read.csv(url(strt.stream.2020.url.two), skip = 1)

vaul.stream.2020 <- read.csv(url(vaul.stream.2020.url), skip = 1)

poke.stream.one.2020 <- read.csv(url(poke.stream.2020.url), skip = 1)
poke.stream.two.2020 <- read.csv(url(poke.stream.2020.url.two), skip = 1)

# Rename columns #
names(moos.stream.one.2020) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(moos.stream.two.2020) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

names(frch.stream.one.2020) <- c("Site", "DateTimeGMT", "Absolute Pressure", "WaterLevel")
names(frch.stream.two.2020) <- c("Site", "DateTimeGMT", "Absolute Pressure", "WaterLevel")

names(strt.stream.one.2020) <- c("Site", "DateTimeGMT", "Absolute Pressure", "WaterLevel")
names(strt.stream.two.2020) <- c("Site", "DateTimeGMT", "Absolute Pressure", "WaterLevel")

names(vaul.stream.2020) <- c("Site", "DateTimeGMT", "Absolute Pressure", "WaterLevel")

names(poke.stream.one.2020) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(poke.stream.two.2020) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

# Input NA for missing time #
moos.stream.one.2020$DateTimeGMT[moos.stream.one.2020$DateTimeGMT == ""] <- NA
moos.stream.two.2020$DateTimeGMT[moos.stream.two.2020$DateTimeGMT == ""] <- NA

frch.stream.one.2020$DateTimeGMT[frch.stream.one.2020$DateTimeGMT == ""] <- NA
frch.stream.two.2020$DateTimeGMT[frch.stream.two.2020$DateTimeGMT == ""] <- NA

strt.stream.one.2020$DateTimeGMT[strt.stream.one.2020$DateTimeGMT == ""] <- NA
strt.stream.two.2020$DateTimeGMT[strt.stream.two.2020$DateTimeGMT == ""] <- NA

vaul.stream.2020$DateTimeGMT[vaul.stream.2020$DateTimeGMT == ""] <- NA

poke.stream.one.2020$DateTimeGMT[poke.stream.one.2020$DateTimeGMT == ""] <- NA
poke.stream.two.2020$DateTimeGMT[poke.stream.two.2020$DateTimeGMT == ""] <- NA


# Convert time and put in AK time #
moos.stream.one.2020$DateTime <- mdy_hms(moos.stream.one.2020$DateTimeGMT, tz = "GMT")
attributes(moos.stream.one.2020$DateTime)$tzone <- 'America/Anchorage'
moos.stream.two.2020$DateTime <- mdy_hms(moos.stream.two.2020$DateTimeGMT, tz = "GMT")
attributes(moos.stream.two.2020$DateTime)$tzone <- 'America/Anchorage'

frch.stream.one.2020$DateTime <- mdy_hms(frch.stream.one.2020$DateTimeGMT, tz = "GMT")
attributes(frch.stream.one.2020$DateTime)$tzone <- 'America/Anchorage'
frch.stream.two.2020$DateTime <- mdy_hms(frch.stream.two.2020$DateTimeGMT, tz = "GMT")
attributes(frch.stream.two.2020$DateTime)$tzone <- 'America/Anchorage'

strt.stream.one.2020$DateTime <- mdy_hms(strt.stream.one.2020$DateTimeGMT, tz = "GMT")
attributes(strt.stream.one.2020$DateTime)$tzone <- 'America/Anchorage'
strt.stream.two.2020$DateTime <- mdy_hms(strt.stream.two.2020$DateTimeGMT, tz = "GMT")
attributes(strt.stream.two.2020$DateTime)$tzone <- 'America/Anchorage'

vaul.stream.2020$DateTime <- mdy_hms(vaul.stream.2020$DateTimeGMT, tz = "GMT")
attributes(vaul.stream.2020$DateTime)$tzone <- 'America/Anchorage'

poke.stream.one.2020$DateTime <- mdy_hms(poke.stream.one.2020$DateTimeGMT, tz = "GMT")
attributes(poke.stream.one.2020$DateTime)$tzone <- 'America/Anchorage'
poke.stream.two.2020$DateTime <- mdy_hms(poke.stream.two.2020$DateTimeGMT, tz = "GMT")
attributes(poke.stream.two.2020$DateTime)$tzone <- 'America/Anchorage'


# Observed discharge
# Import data from google drive #

discharge.2020 <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPrFKu3yyEDEDkxPVJW2vIWznwmSUcwuNlHInDmrD4EjOQYAkHmtnWJXRT1toDa74ptmHj4O1My3xw/pub?output=csv"
QSummary.2020 <- read.csv(url(discharge.2020))
QSummary.2020 <-  subset(QSummary.2020, select = -c(X2019, Notes, Average, X, Observations, X.1, X2020, average.as.of.8.29., X.2, observations.as.of.8.29.)) # Cleaning columns that are not important to the dataset
QSummary.2020$date <- mdy(QSummary.2020$Date)
QSummary.2020$DateTime <- as.POSIXct(paste(QSummary.2020$date, QSummary.2020$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")

FRCH_RainGauge_2020 <- read.csv("~/Documents/DoD_2020/RainGauge/FRCH.RainGauge.2020.csv")
FRCH_RainGauge_2020$DateTime <-  ymd_hms(FRCH_RainGauge_2020$DateTime)
attributes(FRCH_RainGauge_2020$DateTime)$tzone <-'America/Anchorage'

POKE_RainGauge_2020 <- read.csv("~/Documents/DoD_2020/RainGauge/POKE.RainGauge.2020.csv")
POKE_RainGauge_2020$DateTime <-  ymd_hms(POKE_RainGauge_2020$DateTime)
attributes(POKE_RainGauge_2020$DateTime)$tzone <-'America/Anchorage'

STRT_RainGauge_2020 <- read.csv("~/Documents/DoD_2020/RainGauge/STRT.RainGauge.2020.csv")
STRT_RainGauge_2020$DateTime <-  ymd_hms(STRT_RainGauge_2020$DateTime)
attributes(STRT_RainGauge_2020$DateTime)$tzone <-'America/Anchorage'

VAUL_RainGauge_2020 <- read.csv("~/Documents/DoD_2020/RainGauge/VAUL.RainGauge.2020.csv")
VAUL_RainGauge_2020$DateTime <-  ymd_hms(VAUL_RainGauge_2020$DateTime)
attributes(VAUL_RainGauge_2020$DateTime)$tzone <-'America/Anchorage'

```

### comparing PTs

```{r, echo=FALSE, warning=FALSE}
# Combine the two PT into one #
moos.stream.two.2020 <- moos.stream.two.2020[1:nrow(moos.stream.one.2020),]
moos.stream.one.2020$Site <- "MOOS1" #add column identifier
moos.stream.two.2020$Site <- "MOOS2"
moos.pt.2020 <- bind_rows(moos.stream.one.2020, moos.stream.two.2020)

frch.stream.two.2020 <- frch.stream.two.2020[1:nrow(frch.stream.one.2020),]
frch.stream.one.2020$Site <- "FRCH1" #add column identifier
frch.stream.two.2020$Site <- "FRCH2"
frch.pt.2020 <- bind_rows(frch.stream.one.2020, frch.stream.two.2020)

strt.stream.two.2020 <- strt.stream.two.2020[1:nrow(strt.stream.one.2020),]
strt.stream.one.2020$Site <- "STRT1" #add column identifier
strt.stream.two.2020$Site <- "STRT2"
strt.pt.2020 <- bind_rows(strt.stream.one.2020, strt.stream.two.2020)

vaul.stream.2020$Site <- "VAUL" #add column identifier
vaul.pt.2020 <- vaul.stream.2020
names(vaul.pt.2020) <- c("Site", "DateTimeGMT", "AbsolutePressure", "MeanWL", "DateTime")

poke.stream.two.2020 <- poke.stream.two.2020[1:nrow(poke.stream.one.2020),]
poke.stream.one.2020$Site <- "POKE1" #add column identifier
poke.stream.two.2020$Site <- "POKE2"
poke.pt.2020 <- bind_rows(poke.stream.one.2020, poke.stream.two.2020)

# Checking closeness between two PT #
plot(x = moos.stream.one.2020$WaterLevel, y = moos.stream.two.2020$WaterLevel, main = "Moose PT comparison",
     xlab = "Moose1PT", 
     ylab = "Moose2PT")

```
Some erroneous points but not bad. a slight shift 

### comparing FRCH

```{r, echo=FALSE, warning=FALSE}
plot(x = frch.stream.one.2020$WaterLevel, y = frch.stream.two.2020$WaterLevel, main = "French PT comparison",
     xlab = "French1 PT", 
     ylab = "French2 PT")

```
Pretty good, have to clean some of those points 

### comparing FRCH

```{r, echo=FALSE, warning=FALSE}
plot(x = strt.stream.one.2020$WaterLevel, y = strt.stream.two.2020$WaterLevel, main = "Stuart PT comparison",
     xlab = "Stuart1 PT", 
     ylab = "Stuart2 PT")

```

Same as French, some erroneous points that will need to be cleaned 

```{r, echo=FALSE, warning=FALSE}
plot(x = poke.stream.one.2020$WaterLevel, y = poke.stream.two.2020$WaterLevel, main = "Poker PT comparison",
     xlab = "Poker1 PT", 
     ylab = "Poker2 PT")

```
One PT is definitely more noisy 


### Observed Discharge at all sites for 2020

Slugs and wading rods were used for 2020 observed Q

```{r, echo=FALSE, fig.width=6, fig.height=4, warning=FALSE}
# ALL Sites #
all <- ggplot(QSummary.2020) +
  geom_point(aes(x=DateTime, y=MeasuredQ_Ls, color=Site), size=3) +
  theme_classic() +
  scale_color_brewer(palette = "Set1") +
  ggtitle("ALL SITES")
all

a <- QSummary.2020 %>% filter(Site == "MOOS") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Moose")
a

b <- QSummary.2020 %>% filter(Site == "FRCH") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("French")
b

c <- QSummary.2020 %>% filter(Site == "POKE") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Poker")
c

d <- QSummary.2020 %>% filter(Site == "VAUL") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Vault")
d

e <- QSummary.2020 %>% filter(Site == "STRT") %>% 
  ggplot() +
  geom_point(aes(x=DateTime, y = MeasuredQ_Ls, color = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart")
e

plot_grid(all, NA,
          a, b,
          c,d,
          e,
          nrow = 4, ncol = 2)
```

## Raw Moose PT1
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-15 09:30:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.one.2020$DateTime, moos.stream.one.2020$WaterLevel, type = 'l')

```
Noisy on the falling limb of first storm, potentially some out of water points in August and at the end of the season...Let the cleaning commence!


```{r, echo=FALSE, warning=FALSE}
moos.stream.one.2020 <- moos.stream.one.2020 %>% subset(moos.stream.one.2020$DateTime < "2020-10-14") # cleaning data that is below 165.5 because those are errant and then before 10/14 because thats when we took the PTs out
moos.stream.one.2020[c(1115:1499, 6032:6038 ), 4] <- NA # Setting NA to noisy part of the data set from the 27th to 30th

plot(moos.stream.one.2020$DateTime, moos.stream.one.2020$WaterLevel, type = 'l')

# shifting the back end of the data up
moos.stream.one.2020[6031, 4] # Last measurement before cleaning on 8/17 @ 04:45
moos.stream.one.2020[6039, 4]# First measurement after cleaning on 8/17 @7:00
moos.stream.one.2020[6031, 4] - moos.stream.one.2020[6039, 4] #0.116


moos.stream.one.before <- moos.stream.one.2020[-c(6032:11578), ] # clipping off after cleaning
moos.stream.one.after <- moos.stream.one.2020[-c(1:6031),] # clipping off before cleaning
moos.stream.one.after$difference <- moos.stream.one.after[, 4] + 0.116
names(moos.stream.one.after) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WLB4", "DateTime", "WaterLevel")
moos.stream.one.2020.final <- full_join(moos.stream.one.before, moos.stream.one.after)


plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-15 09:30:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.one.2020.final$DateTime, moos.stream.one.2020.final$WaterLevel, type = 'l')




```
1) Clipped off data after 10/14 because thats when we took the PTs out
2) Set receding limb of first big storm in June to NA due to "noisy-ness"
3) clipped off errant points - vertical bars
4) After clipping off errant points the back half of the data after August 8/17 @ 07:00 needed to be shifted up so I took the difference of the not matched points of the data and added the difference to the data following the clip 

## Raw Moose PT2
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-15 09:30:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.two.2020$DateTime, moos.stream.two.2020$WaterLevel, type = 'l')

```
Need ot adjust middle of August on and clip off out of water points associated with install or decomission 

```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2020 <- moos.stream.two.2020 %>% subset(moos.stream.two.2020$DateTime < "2020-10-14") # cleaning data that is below 165.5 because those are errant and then before 10/14 because thats when we took the PTs out

# shifting the back end of the data up
moos.stream.two.2020[6030, 4] # Last measurement before cleaning
moos.stream.two.2020[6038, 4] # first measurement after cleaning
moos.stream.two.2020[6030, 4] - moos.stream.two.2020[6038, 4] #0.19 is the difference 

moos.stream.two.before <- moos.stream.two.2020[-c(6031:11578), ]
moos.stream.two.after <- moos.stream.two.2020[-c(1:6030), ]
moos.stream.two.after$difference <- moos.stream.two.after[, 4] + 0.19
names(moos.stream.two.after) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WLB4", "DateTime", "WaterLevel")
moos.stream.two.2020.final <- full_join(moos.stream.two.before, moos.stream.two.after)


plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-15 09:30:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.two.2020.final$DateTime, moos.stream.two.2020.final$WaterLevel, type = 'l')




```
1) Clipped off data after 10/14 because thats when we took the PTs out
2) clipped off errant points (vertical bars)
3) After clipping off errant points the back half of the data after August 8/17 @ 07:00 needed to be shifted up so I took the difference of the not matched points of the data and added the difference to the data following the clip 

### Raw Rating Curve with MOOS PT1 

```{r, echo=FALSE, warning=FALSE}

QSummary.MO.2020 <- QSummary.2020 %>% filter(Site =="MOOS")

moos.stream.one.2020.final$Site <- "MOOS"

Moose1comb.2020 <- full_join(moos.stream.one.2020.final, QSummary.MO.2020)
MOOS1.lm.2020 <- lm(Moose1comb.2020$MeasuredQ_Ls ~ Moose1comb.2020$WaterLevel)

moos.formula <- y ~ x
ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moose1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(165.75,166.5) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

```
# Rating curve MOOS PT1 2.0
```{r, echo=FALSE, warning=FALSE}

QSummary.MO.2020.1 <- QSummary.MO.2020[-c(1,9,13,18), ]


Moose2comb.2020 <- full_join(moos.stream.one.2020.final, QSummary.MO.2020.1)
MOOS2.lm.2020 <- lm(Moose2comb.2020$MeasuredQ_Ls ~ Moose2comb.2020$WaterLevel)

moos.formula <- y ~ x
ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moose2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(165.75,166.5) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

```
1) Removed the two highest YSI's, lowest YSI and one of high flowmeter that wasnt a very high waterlevel

### Raw Rating Curve with MOOS PT2

```{r, echo=FALSE, warning=FALSE}

moos.stream.two.2020.final$Site <- "MOOS"

Moose3comb.2020 <- full_join(moos.stream.two.2020.final, QSummary.MO.2020)
MOOS3.lm.2020 <- lm(Moose3comb.2020$MeasuredQ_Ls ~ Moose3comb.2020$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moose3comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(165.75,166.75) +
  theme_classic() +
  ggtitle("Moose2 all measured Q") 

```

# Rating curve MOOS PT1 2.0
```{r, echo=FALSE, warning=FALSE}

QSummary.MO.2020.2 <- QSummary.MO.2020[-c(13,18), ]


Moose4comb.2020 <- full_join(moos.stream.two.2020.final, QSummary.MO.2020.2)
MOOS4.lm.2020 <- lm(Moose4comb.2020$MeasuredQ_Ls ~ Moose4comb.2020$WaterLevel)

moos.formula <- y ~ x
ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moose4comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(165.75,166.5) +
  theme_classic() +
  ggtitle("Moose1 all measured Q") 

```
1) Removed the highest and lowest YSI
# Final Q for MOOS PT1
```{r, echo=FALSE, warning=FALSE}
Moose2comb.2020$pred.moos1.Q <- coef(MOOS2.lm.2020)[2] * Moose2comb.2020$WaterLevel+ coef(MOOS2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moose2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("Date") +
  ylab("Predicted Discharge") 

```
Looks pretty good 

# Final Q for MOOS PT2
```{r, echo=FALSE, warning=FALSE}
Moose4comb.2020$pred.moos2.Q <- coef(MOOS4.lm.2020)[2] * Moose4comb.2020$WaterLevel+ coef(MOOS4.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.moos2.Q), data = Moose4comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)")  

```
Not too shabby looking 

# Average of MOOS PT1 and PT2
```{r, echo=FALSE, warning=FALSE}

moos.final.discharge.2020 <- full_join(Moose2comb.2020, Moose4comb.2020, by = c("DateTime"))
moos.final.discharge.2020$MeanDischarge <- rowMeans(moos.final.discharge.2020[,c(14,27)], na.rm = TRUE)

moos.final.discharge.2020 <- moos.final.discharge.2020[,-c(2:4, 6:13, 15:26)]
moos.final.discharge.2020 <- moos.final.discharge.2020[,-(3:4)]

### Moose1 (light blue), Moose2 (dark blue), and mean (red) with observed Q.

ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moose1comb.2020) +
  geom_line(aes(x = DateTime, y = pred.moos1.Q), data = Moose2comb.2020, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.moos2.Q), data = Moose4comb.2020,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = moos.final.discharge.2020, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 5000) +
  ggtitle("Moose1(light) & Moose2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")


```
Red is the average that should be used and exported as csv.

## Raw French PT1
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-11 04:45:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.one.2020$DateTime, frch.stream.one.2020$WaterLevel, type = 'l')

```
Needs cleaning for out of water points that are associated with install and decommission. Noisy on the falling limb of these storms! Let the cleaning commence!

## French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.one.2020 <- frch.stream.one.2020  %>%  subset(frch.stream.one.2020$DateTime < "2020-10-14") #cleaning data that is before the 14th (Site was taken down the 15th)
frch.stream.one.2020[c(1,2,3,1039:3822,1699,1769), 4] <- NA # Setting NA to noisy part of the data set and errant points

plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-11 04:45:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.one.2020$DateTime, frch.stream.one.2020$WaterLevel, type = 'l')


```
1) Removed points after October 14th (when we took out PTs) and out of water points in the beginning of the dataset
2) Removed noisy points on receding limb of big storm events in the beginning of the dataframe 

## Raw French PT2
```{r, echo=FALSE, warning=FALSE}
plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-11 05:30:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2020$DateTime, frch.stream.two.2020$WaterLevel, type = 'l')

```
Receding limb of first initial storm is noisy on this one too 

## French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2020 <- frch.stream.two.2020  %>%  subset(frch.stream.two.2020$DateTime < "2020-10-14") #cleaning data that is before the 14th (Site was taken down the 15th)
plot(FRCH_RainGauge_2020$inst_rainfall_mm ~ FRCH_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-11 04:45:00","2020-10-15 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2020$DateTime, frch.stream.two.2020$WaterLevel, type = 'l')

```
1) removed out of water points from taking out on the 14th of October 

# Raw Rating curve FRCH PT1
```{r, echo=FALSE, warning=FALSE}

QSummary.FR.2020 <- QSummary.2020 %>% filter(Site =="FRCH")

### Rating curve for FRCH PT1 ###
frch.stream.one.2020$Site <- "FRCH"

French1comb.2020 <- full_join(frch.stream.one.2020, QSummary.FR.2020) # Join PT data with Discharge
French1.lm.2020 <- lm(French1comb.2020$MeasuredQ_Ls ~ French1comb.2020$WaterLevel) # linear model with discharge and water level


frch.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = French1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French1 all measured Q") 

```

# Raw Rating curve FRCH PT1
```{r, echo=FALSE, warning=FALSE}

QSummary.FR.2020.1 <- QSummary.FR.2020[-7, ]

### Rating curve for FRCH PT1 ###
frch.stream.one.2020$Site <- "FRCH"

French2comb.2020 <- full_join(frch.stream.one.2020, QSummary.FR.2020.1) # Join PT data with Discharge
French2.lm.2020 <- lm(French2comb.2020$MeasuredQ_Ls ~ French2comb.2020$WaterLevel) # linear model with discharge and water level


frch.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = French2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(184,185) +
  theme_classic() +
  ggtitle("French1 all measured Q") 

```
1) removed YSI with highest WL and it made R^2 worse, ill stick with the first one


# Raw Rating curve FRCH PT2
```{r, echo=FALSE, warning=FALSE}

frch.stream.two.2020$Site <- "FRCH"

French2comb.2020 <- full_join(frch.stream.two.2020, QSummary.FR.2020)
French2.lm.2020 <- lm(French2comb.2020$MeasuredQ_Ls ~ French2comb.2020$WaterLevel)


ggplot(aes(x= WaterLevel, y = MeasuredQ_Ls), data = French2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("French2 all measured Q") 

```
The highest YSI point could maybe go...?

# Final Q for FRCH PT1
```{r, echo=FALSE, warning=FALSE}
French1comb.2020$pred.french1.Q <- coef(French1.lm.2020)[2] * French1comb.2020$WaterLevel+ coef(French1.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.french1.Q), data=French1comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  ggtitle("French1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

```

# Final Q for FRCH PT2
```{r, echo=FALSE, warning=FALSE}
French2comb.2020$pred.french2.Q <- coef(French2.lm.2020)[2] * French2comb.2020$WaterLevel+ coef(French2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.french2.Q), data=French2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  ggtitle("French") +
  xlab("") +
  ylab("Discharge (L/s)") 

```
Looks pretty good 

# Average Q for FRCH PT1
```{r, echo=FALSE, warning=FALSE}

frch.final.discharge.2020 <- full_join(French1comb.2020, French2comb.2020, by = "DateTime")

frch.final.discharge.2020$MeanDischarge <- rowMeans(frch.final.discharge.2020[,c(13,25)], na.rm = TRUE)

frch.final.discharge.2020 <- frch.final.discharge.2020[,-c(2:4, 6:12, 14:24)]


names(frch.final.discharge.2020) <- c("Site", "DateTime", "PT1", "PT2", "MeanDischarge")
### French1 (light blue), French2 (dark blue), and mean (red) with observed Q.
ggplot(aes(x = DateTime, y = pred.french2.Q), data = French2comb.2020) +
  geom_line(aes(x = DateTime, y = pred.french1.Q), data = French1comb.2020, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.french2.Q), data = French2comb.2020,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = frch.final.discharge.2020, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ggtitle("French1(light) & French2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```
Red is the average and should be exported to a csv. 

## Raw Poker PT1
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2020$inst_rainfall_mm ~ POKE_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-04 05:30:00","2020-10-14 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.one.2020$DateTime, poke.stream.one.2020$WaterLevel, type = 'l')

```
It looks like I need to remove out of water points at the end of the year and potentially shift middle of september-on up....let the cleaning commence!

## Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.one.2020 <- poke.stream.one.2020 %>% subset(poke.stream.one.2020$DateTime < "2020-10-10") # Cleaning data that is before October 10th due to ice (Site was taken down Oct 14th)

poke.stream.one.2020[9799, 4] - poke.stream.one.2020[9800, 4] # 0.068
poke.stream.one.before <- poke.stream.one.2020[-c(9800:12256), ] # before
poke.stream.one.after <- poke.stream.one.2020[-c(1:9799), ] # after
poke.stream.one.after$WaterLevel <- poke.stream.one.after[, 4] + 0.068
poke.one.final <- full_join(poke.stream.one.before, poke.stream.one.after)

plot(POKE_RainGauge_2020$inst_rainfall_mm ~ POKE_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-04 05:30:00","2020-10-14 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.one.final$DateTime, poke.one.final$WaterLevel, type = 'l')

```
1) removed data after 10/10/20 due to decommission
2) shifted mid september-on up due to dip 


## Raw Poker PT2
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2020$inst_rainfall_mm ~ POKE_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-04 05:00:00","2020-10-14 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2020$DateTime, poke.stream.two.2020$WaterLevel, type = 'l')

```
PT2 seems a lot "noisier"....this is the PT that is located on the wetttetd edge left side tucked by the meander so it is more susecptible to shaking....It also needs to be filtered out at the end of the season due to out of water points....let the cleaning commence!

## Poker PT2 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2020 <- poke.stream.two.2020 %>% subset(poke.stream.two.2020$DateTime < "2020-10-10") # Cleaning data that is before October 10th due to ice (Site was taken down Oct 14th)

plot(POKE_RainGauge_2020$inst_rainfall_mm ~ POKE_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-04 05:00:00","2020-10-14 12:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2020$DateTime, poke.stream.two.2020$WaterLevel, type = 'l')

```

# Raw Rating curve POKE PT1
```{r, echo=FALSE, warning=FALSE}

QSummary.PO.2020 <- QSummary.2020 %>% filter(Site =="POKE")

### Rating curve for POKE PT1 ###
poke.stream.one.2020$Site <- "POKE"

Poke1comb.2020 <- full_join(poke.stream.one.2020, QSummary.PO.2020)
POKE1.lm.2020 <- lm(Poke1comb.2020$MeasuredQ_Ls ~ Poke1comb.2020$WaterLevel)

poke.formula <- y ~ x


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poke1 all measured Q") 


```
top YSI point has got to go 


# Rating curve POKE PT1 2.0
```{r, echo=FALSE, warning=FALSE}

QSummary.PO.2020.1 <- QSummary.PO.2020[-4, ]

### Rating curve for POKE PT1 ###
poke.one.final$Site <- "POKE"

Poke1comb.2020 <- full_join(poke.one.final, QSummary.PO.2020.1)
POKE1.lm.2020 <- lm(Poke1comb.2020$MeasuredQ_Ls ~ Poke1comb.2020$WaterLevel)

poke.formula <- y ~ x


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(216, 216.5) + 
  theme_classic() +
  ggtitle("Poke1 all measured Q") 


```
1) removed the top YSI point

# Raw Rating curve POKE PT2
```{r, echo=FALSE, warning=FALSE}

poke.stream.two.2020$Site <- "POKE"

Poke2comb.2020 <- full_join(poke.stream.two.2020, QSummary.PO.2020)
POKE2.lm.2020 <- lm(Poke2comb.2020$MeasuredQ_Ls ~ Poke2comb.2020$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poker2 all measured Q")  

```
Need to remove the YSI point 

# Raw Rating curve POKE PT2
```{r, echo=FALSE, warning=FALSE}
Poke2comb.2020 <- full_join(poke.stream.two.2020, QSummary.PO.2020.1)
POKE2.lm.2020 <- lm(Poke2comb.2020$MeasuredQ_Ls ~ Poke2comb.2020$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Poker2 all measured Q")  

```
1) removed the top YSI point 

# Final Q for POKE PT1
```{r, echo=FALSE, warning=FALSE}
Poke1comb.2020$pred.poke1.Q <- coef(POKE1.lm.2020)[2] * Poke1comb.2020$WaterLevel+ coef(POKE1.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker1 predicted all measured Q") +
  xlab("Date") +
  ylab("Predicted Discharge") 

```
Seems like the predicted overshoots our discrete measurements

# Final Q for POKE PT2
```{r, echo=FALSE, warning=FALSE}
Poke2comb.2020$pred.poke2.Q <- coef(POKE2.lm.2020)[2] * Poke2comb.2020$WaterLevel+ coef(POKE2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylim(0, 2500) +
  ylab("Discharge(L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-10")))

```
A lot noisier then PT1

# Final Q POKE average
```{r, echo=FALSE, warning=FALSE}

poke.final.discharge.2020 <- cbind(Poke1comb.2020, Poke2comb.2020)
poke.final.discharge.2020$MeanDischarge <- rowMeans(poke.final.discharge.2020[,c('pred.poke1.Q', 'pred.poke2.Q')], na.rm = TRUE) 

poke.final.discharge.2020 <- poke.final.discharge.2020[,-c(2,3,4,5,6,7,8,9,10,11,12,14,15,16,17,19,20,21,22,23,24,25)]


ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2020, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2020,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2020, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("Poker1(light) & Poker2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```
I think we should go with PT1

## Raw Vault PT1
There is only one Vault PT
```{r, echo=FALSE, warning=FALSE}
plot(VAUL_RainGauge_2020$inst_rainfall_mm~ VAUL_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-05 07:00:00","2020-10-14 12:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.2020$DateTime, vaul.stream.2020$WaterLevel, type = 'l')

```
Hard to see what else we need to clean besides the end of the year out of water points....let the cleaning commence!

## Vault PT1 2.0
```{r, echo=FALSE, warning=FALSE}
vaul.stream.2020 <- vaul.stream.2020 %>% subset(vaul.stream.2020$DateTime < "2020-10-05") # Cleaning data that is before October 5th due to ice in channel (Site was taken down Oct 14th)

plot(VAUL_RainGauge_2020$inst_rainfall_mm~ VAUL_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-05 07:00:00","2020-10-14 12:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.2020$DateTime, vaul.stream.2020$WaterLevel, type = 'l')

```
1) removed data after 10/5/20 due to out of water points 

## Raw rating curve for VAUL PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Vault ### 
QSummary.VA.2020 <- QSummary.2020 %>% filter(Site =="VAUL") %>% filter(MeasuredQ_Ls < 2000)

### Rating curve for VAUL PT2 ###
vaul.stream.2020$Site <- "VAUL"

Vaul2comb.2020 <- full_join(vaul.stream.2020, QSummary.VA.2020)
VAUL2.lm.2020 <- lm(Vaul2comb.2020$MeasuredQ_Ls ~ Vaul2comb.2020$WaterLevel)

vaul.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Vaul2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = vaul.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  xlim(197.5, 198.5) + 
  theme_classic() +
  ggtitle("Vault2 all measured Q")  

```
Looks pretty good...maybe that high YSI can get taken off but I would say in my experience, YSI is pretty accurate until 800 Ls so that might be good to keep 

## Predicted Q for VAUL
```{r, echo=FALSE, warning=FALSE}
Vaul2comb.2020$pred.vaul2.Q <- coef(VAUL2.lm.2020)[2] * Vaul2comb.2020$WaterLevel+ coef(VAUL2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.vaul2.Q), data = Vaul2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Vault") +
  scale_shape_discrete(name = "Mehtod", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-10")))


```
Not too shabby!

## Raw STRT PT1
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2020$inst_rainfall_mm~ STRT_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-17 08:30:00","2020-10-13 14:00:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.one.2020$DateTime, strt.stream.one.2020$WaterLevel, type = 'l')

```
Needs end of season out of water points to be removed....let the cleaning commence!


## STRT PT1 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.one.2020 <- strt.stream.one.2020 %>% subset(strt.stream.one.2020$DateTime < "2020-10-8") # cleaning data that is before October 8th due to ice in channel (Site was taken down Oct 13th)
strt.stream.one.2020[6452,4] <- NA

plot(STRT_RainGauge_2020$inst_rainfall_mm~ STRT_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-17 08:30:00","2020-10-13 14:00:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.one.2020$DateTime, strt.stream.one.2020$WaterLevel, type = 'l')

```
1) Removed data after 10/8/20 due to ice on the channel...PT was taken out on the 13th
2) removed vertical bar errant point in middle of August

## Raw STRT PT1
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2020$inst_rainfall_mm~ STRT_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-17 08:30:00","2020-10-13 14:00:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2020$DateTime, strt.stream.two.2020$WaterLevel, type = 'l')

```
Same procedure as previous PT....let the cleaning commence!

## STRT PT1 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2020 <- strt.stream.two.2020 %>% subset(strt.stream.two.2020$DateTime < "2020-10-08") # cleaning data that is before October 8th due to ice in channel (Site was taken down Oct 13th)
strt.stream.two.2020[674, 4] <- NA

plot(STRT_RainGauge_2020$inst_rainfall_mm~ STRT_RainGauge_2020$DateTime, type="h",
     xlim = as.POSIXct(c("2020-06-17 08:30:00","2020-10-13 14:00:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2020$DateTime, strt.stream.two.2020$WaterLevel, type = 'l')


```
1) Removed vertical errant point at the top of first big storm
2) Removed data after 10/8 due to ice on the channel...PT was taken out on the 13th

## Raw rating curve for STRT PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020 <- QSummary.2020 %>% filter(Site =="STRT")

### Rating curve for STRT PT1 ### 

strt.stream.one.2020$Site <- "STRT"

Strt1comb.2020 <- full_join(strt.stream.one.2020, QSummary.ST.2020)
STRT1.lm.2020 <- lm(Strt1comb.2020$MeasuredQ_Ls ~ Strt1comb.2020$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q")  # I think this worked

```
Does not look pretty

## rating curve for STRT PT1 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020.1 <- QSummary.ST.2020[-c(8,14,4), ]

Strt1comb.2020 <- full_join(strt.stream.one.2020, QSummary.ST.2020.1)
STRT1.lm.2020 <- lm(Strt1comb.2020$MeasuredQ_Ls ~ Strt1comb.2020$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q")  # I think this worked


``` 
1) removed the lowest YSI and YSI's over 1000Ls


## Raw rating curve for STRT PT2
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
strt.stream.two.2020$Site <- "STRT"

Strt2comb.2020 <- full_join(strt.stream.two.2020, QSummary.ST.2020)
STRT2.lm.2020 <- lm(Strt2comb.2020$MeasuredQ_Ls ~ Strt2comb.2020$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt2 all measured Q") 

```
Negative slope is definitely bad 

## rating curve for STRT PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
QSummary.ST.2020.2 <- QSummary.ST.2020[-c(1,8,14,4), ]

Strt2comb.2020 <- full_join(strt.stream.two.2020, QSummary.ST.2020.2)
STRT2.lm.2020 <- lm(Strt2comb.2020$MeasuredQ_Ls ~ Strt2comb.2020$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2020) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt2 all measured Q") 

``` 
1) removed lowest YSI and YSI's over 1000Ls
2) removed the highest Wading rod 

## Predicted Q for STRT PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter Stuart ###
Strt1comb.2020$pred.strt1.Q <- coef(STRT1.lm.2020)[2] * Strt1comb.2020$WaterLevel+ coef(STRT1.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge (L/s)") +
  scale_x_datetime(limits = as_datetime(c("2020-05-15", "2020-10-09")))

``` 
Not too shabby

## Predicted Q for STRT PT2
```{r, echo=FALSE, warning=FALSE}
Strt2comb.2020$pred.strt2.Q <- coef(STRT2.lm.2020)[2] * Strt2comb.2020$WaterLevel+ coef(STRT2.lm.2020)[1]
ggplot(aes(x = DateTime, y = pred.strt2.Q), data = Strt2comb.2020) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart2 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("Date") +
  ylab("Predicted Discharge") 

``` 
Not as good as PT1

## Average Predicted Q for STRT 
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2020 <- data.frame(Strt1comb.2020$Site, Strt1comb.2020$DateTime, Strt1comb.2020$pred.strt1.Q, Strt2comb.2020$pred.strt2.Q)

strt.final.discharge.2020 <- strt.final.discharge.2020 %>% subset(strt.stream.one.2020$DateTime > "2020-06-16")

strt.final.discharge.2020$MeanDischarge <- rowMeans(strt.final.discharge.2020[,c('Strt1comb.2020.pred.strt1.Q', 'Strt2comb.2020.pred.strt2.Q')], na.rm = TRUE) 


### Stuart1 (light blue), Stuart2 (dark blue), and Stuart1 (red) because STRT2 seems bad with observed Q.

ggplot(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2020) +
  geom_line(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2020, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.strt2.Q), data = Strt2comb.2020,color="#1F78B4", size=1.25, alpha = 0.75) +
   geom_line(aes(x = Strt1comb.2020.DateTime, y = MeanDischarge), data = strt.final.discharge.2020, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 6500) +
  ggtitle("Stuart1(light) & Stuart2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")


``` 

########################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################################

Vault, French, and Moose only have data from 6/29 on due to data not being uploaded to the drive before the computer had water damage and lost the data....reminder to ALWAYS BACK UP DATA.
We can try and run a model to apply data from Poker to extrapolate missing water level points at other sites. 

2021 data comes from DoD Project-> 2021 AK sensors -> Discharge->PT->'site'

2021 data was taken using a Wading rod and salt slug dilution and an ADCP at Stuart and Moose one time during the season. 


```{r, include=FALSE, warning=FALSE}
poke.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRuPTbgwOrFhhVETrN4HMpVoHrNVwLSecr0acVH7i8ePtxme0PxX1tR_SQ7Mqlg3iiCOHUFw80NFfA5/pub?output=csv"
poke.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTgmuOVxwxSfNzLsb76OmrUQhYzl6prnjP17ubO4XV7x0T0bMpUX7jX5itel6oPe3HDCORnoYD25IgU/pub?output=csv"
strt.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTBHVco3KO6uDX5ixIteIKLgnLUTe1GIGYK-8WBM2eXn1VWvthOjFIGvmXyVOq3l2vnxiBQQaDzbqE1/pub?output=csv"
strt.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vTqHls7RlLhnawrL43INl8xLeRLigkYcLhNaUtpHBCN91YmE0rCpNJqBiwvJKp9d0rDapG_UGid43fC/pub?output=csv"
vaul.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSUpdW2ARqdQmnNzpRIbIyGD24DhBSwL5CHFzAG8bwhOsttnyU2nehzfJ0gG8BZHX2VbSc3W1NikCIH/pub?output=csv"
frch.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi6_PAev36hNhtcXdBBQk3pyJqBoQEKpV8tSvtZgz_DPdqXSg93-d_FDomNSH_lkNhb7fJJVloxl1g/pub?output=csv"
frch.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vR0NaSrjYnUkQC42v448LFY0EZEr98R6a2gH0FpPlMBwpfEDY80rSzbDOP3OfpB-SI4QQBCOMgoQxd2/pub?output=csv"
moos.stream.2021.url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSVsPDDkXNKBU9Ux2qnvtWl-HS0hgXM2cww9_1l2Xz0Vc9C1_KA2Ss56FuS1fq8mESdgqq2Pl5Nvw6o/pub?output=csv"
moos.stream.2021.url.two <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vRCnhugeQ8EmP9P22kirbLQhPgDwFoPyMmZ4SR05jSHgleJBcUQYjNb3K2w6hGtdu4W-XJixdl8fk6-/pub?output=csv"

# Load Data#
poke.stream.one.2021 <- read.csv(url(poke.stream.2021.url), skip = 1) 
poke.stream.two.2021 <- read.csv(url(poke.stream.2021.url.two), skip = 1)
strt.stream.one.2021 <- read.csv(url(strt.stream.2021.url), skip = 1) # Deployed the 7th of May 
strt.stream.two.2021 <- read.csv(url(strt.stream.2021.url.two), skip = 1) # Deployed the 19th of May
vaul.stream.one.2021 <- read.csv(url(vaul.stream.2021.url), skip = 1)
frch.stream.one.2021 <- read.csv(url(frch.stream.2021.url), skip = 1) # Deployed the 7th of May 
frch.stream.two.2021 <- read.csv(url(frch.stream.2021.url.two), skip = 1) # Deployed the 19th of May
moos.stream.one.2021 <- read.csv(url(moos.stream.2021.url), skip = 1) # Deployed the 7th of May 
moos.stream.two.2021 <- read.csv(url(moos.stream.2021.url.two), skip = 1) # Deployed the 19th of May

# Erase columns that are unneeded
poke.stream.one.2021 <- poke.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
poke.stream.two.2021 <- poke.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

strt.stream.one.2021 <- strt.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
strt.stream.two.2021 <- strt.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

vaul.stream.one.2021 <- vaul.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

frch.stream.one.2021 <- frch.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
frch.stream.two.2021 <- frch.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

moos.stream.one.2021 <- moos.stream.one.2021[,-c(4,5)] # Dont need temperature and barometric pressure 
moos.stream.two.2021 <- moos.stream.two.2021[,-c(4,5)] # Dont need temperature and barometric pressure 

# Rename columns 
names(poke.stream.one.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(poke.stream.two.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

names(strt.stream.one.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(strt.stream.two.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

names(vaul.stream.one.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

names(frch.stream.one.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(frch.stream.two.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

names(moos.stream.one.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")
names(moos.stream.two.2021) <- c("Site", "DateTimeGMT", "AbsolutePressure", "WaterLevel")

# Input NAs for time 
poke.stream.one.2021$DateTimeGMT[poke.stream.one.2021$DateTimeGMT == ""] <- NA
poke.stream.two.2021$DateTimeGMT[poke.stream.two.2021$DateTimeGMT == ""] <- NA

strt.stream.one.2021$DateTimeGMT[strt.stream.one.2021$DateTimeGMT == ""] <- NA
strt.stream.two.2021$DateTimeGMT[strt.stream.two.2021$DateTimeGMT == ""] <- NA

vaul.stream.one.2021$DateTimeGMT[vaul.stream.one.2021$DateTimeGMT == ""] <- NA

frch.stream.one.2021$DateTimeGMT[frch.stream.one.2021$DateTimeGMT == ""] <- NA
frch.stream.two.2021$DateTimeGMT[frch.stream.two.2021$DateTimeGMT == ""] <- NA

moos.stream.one.2021$DateTimeGMT[moos.stream.one.2021$DateTimeGMT == ""] <- NA
moos.stream.two.2021$DateTimeGMT[moos.stream.two.2021$DateTimeGMT == ""] <- NA

# Convert to AK time 
poke.stream.one.2021$DateTime <- mdy_hms(poke.stream.one.2021$DateTimeGMT, tz = "GMT")
attributes(poke.stream.one.2021$DateTime)$tzone <- 'America/Anchorage'
poke.stream.two.2021$DateTime <- mdy_hms(poke.stream.two.2021$DateTimeGMT, tz = "GMT")
attributes(poke.stream.two.2021$DateTime)$tzone <- 'America/Anchorage'

strt.stream.one.2021$DateTime <- mdy_hms(strt.stream.one.2021$DateTimeGMT, tz = "GMT")
attributes(strt.stream.one.2021$DateTime)$tzone <- 'America/Anchorage'
strt.stream.two.2021$DateTime <- mdy_hms(strt.stream.two.2021$DateTimeGMT, tz = "GMT")
attributes(strt.stream.two.2021$DateTime)$tzone <- 'America/Anchorage'

vaul.stream.one.2021$DateTime <- mdy_hms(vaul.stream.one.2021$DateTimeGMT, tz = "GMT")
attributes(vaul.stream.one.2021$DateTime)$tzone <- 'America/Anchorage'

frch.stream.one.2021$DateTime <- mdy_hms(frch.stream.one.2021$DateTimeGMT, tz = "GMT")
attributes(frch.stream.one.2021$DateTime)$tzone <- 'America/Anchorage'
frch.stream.two.2021$DateTime <- mdy_hms(frch.stream.two.2021$DateTimeGMT, tz = "GMT")
attributes(frch.stream.two.2021$DateTime)$tzone <- 'America/Anchorage'

moos.stream.one.2021$DateTime <- mdy_hms(moos.stream.one.2021$DateTimeGMT, tz = "GMT")
attributes(moos.stream.one.2021$DateTime)$tzone <- 'America/Anchorage'
moos.stream.two.2021$DateTime <- mdy_hms(moos.stream.two.2021$DateTimeGMT, tz = "GMT")
attributes(moos.stream.two.2021$DateTime)$tzone <- 'America/Anchorage'


# Observed discharge
# Import data from google drive #

QSummary.2021 <- read_csv("~/Desktop/Q_Summary_2021.csv")

QSummary.2021$Time[QSummary.2021$Time == ""] <- NA
QSummary.2021$MeasuredQ_Ls[QSummary.2021$MeasuredQ_Ls == " "] <- NA
### Format Time ###
QSummary.2021$Date <- mdy(QSummary.2021$Date)
QSummary.2021$DateTime <- as.POSIXct(paste(QSummary.2021$Date, QSummary.2021$Time), format = "%Y-%m-%d %H:%M", tz = "America/Anchorage")
QSummary.2021$DateTime <- lubridate::round_date(QSummary.2021$DateTime, "15 minutes")


POKE_RainGauge_2021 <- read.csv("~/Documents/DoD_2021/RainGauge/POKE.RainGauge.2021.csv")
POKE_RainGauge_2021$DateTime <-  ymd_hms(POKE_RainGauge_2021$DateTime)
attributes(POKE_RainGauge_2021$DateTime)$tzone <-'America/Anchorage'

STRT_RainGauge_2021 <- read.csv("~/Documents/DoD_2021/RainGauge/STRT.RainGauge.2021.csv")
STRT_RainGauge_2021$DateTime <-  ymd_hms(STRT_RainGauge_2021$DateTime)
attributes(STRT_RainGauge_2021$DateTime)$tzone <-'America/Anchorage'

VAUL_RainGauge_2021 <- read.csv("~/Documents/DoD_2021/RainGauge/VAUL.RainGauge.2021.csv")
VAUL_RainGauge_2021$DateTime <-  ymd_hms(VAUL_RainGauge_2021$DateTime)
attributes(VAUL_RainGauge_2021$DateTime)$tzone <-'America/Anchorage'

```

### comparing PTs

```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2021 <- poke.stream.two.2021[1:nrow(poke.stream.one.2021),]
poke.stream.one.2021$Site <- "POKE1" #add column identifier
poke.stream.two.2021$Site <- "POKE2"
poke.pt.2021 <- bind_rows(poke.stream.one.2021, poke.stream.two.2021)

strt.stream.two.2021 <- strt.stream.two.2021[1:nrow(strt.stream.one.2021),]
strt.stream.one.2021$Site <- "STRT1" #add column identifier
strt.stream.two.2021$Site <- "STRT2"
strt.pt.2021 <- bind_rows(strt.stream.one.2021, strt.stream.two.2021)

frch.stream.two.2021 <- frch.stream.two.2021[1:nrow(frch.stream.one.2021),]
frch.stream.one.2021$Site <- "FRCH1" #add column identifier
frch.stream.two.2021$Site <- "FRCH2"
frch.pt.2021 <- bind_rows(frch.stream.one.2021, frch.stream.two.2021)

moos.stream.two.2021 <- moos.stream.two.2021[1:nrow(moos.stream.one.2021),]
moos.stream.one.2021$Site <- "MOOS1" #add column identifier
moos.stream.two.2021$Site <- "MOOS2"
moos.pt.2021 <- bind_rows(moos.stream.one.2021, moos.stream.two.2021)

# Checking closeness between two PT #
plot(x = poke.stream.one.2021$WaterLevel, y = poke.stream.two.2021$WaterLevel, main = "Poker PT comparison",
     xlab = "Poker1PT", 
     ylab = "Poker2PT")
```
### STRT Comp
```{r, echo=FALSE, warning=FALSE}
plot(x = strt.stream.one.2021$WaterLevel, y = strt.stream.two.2021$WaterLevel, main = "Stuart PT comparison",
     xlab = "Stuart1PT", 
     ylab = "Stuart2PT")
```
### FRCH COMP
```{r, echo=FALSE, warning=FALSE}
plot(x = frch.stream.one.2021$WaterLevel, y = frch.stream.two.2021$WaterLevel, main = "French PT comparison",
     xlab = "French1PT", 
     ylab = "French2PT")
```
### MOOS comp
```{r, echo=FALSE, warning=FALSE}
plot(x = moos.stream.one.2021$WaterLevel, y = moos.stream.two.2021$WaterLevel, main = "Moose PT comparison",
     xlab = "Moose1PT", 
     ylab = "Moose2PT")

```

### Raw Moose PT1 
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 06:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.one.2021$DateTime, moos.stream.one.2021$WaterLevel, type = 'l')

```
Need to clean out of water points at the end of the dataframe...let the cleaning commence!

### Moose PT1 2.0
```{r, echo=FALSE, warning=FALSE}
moos.stream.one.2021 <- moos.stream.one.2021 %>% subset(moos.stream.one.2021$DateTime < "2021-09-28") # cleaning data that is before September 28th due to decommission
moos.stream.one.2021[c(29908:30000), 4] <- NA


plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 06:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(moos.stream.one.2021$DateTime, moos.stream.one.2021$WaterLevel, type = 'l')

```
1) removed out of water points during decommission on 9/28/21
2) removed vertical errant points in middle of September

### Raw Moose PT2
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 06:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)

plot(moos.stream.two.2021$DateTime, moos.stream.two.2021$WaterLevel, type = 'l')

```
Need to remove out of water points associated with decommission...let the cleaning commence!

### Moose PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021 <- moos.stream.two.2021 %>% subset(moos.stream.two.2021$DateTime < "2021-09-28") # cleaning data that is before September 28th due to decommission

moos.stream.two.2021[c(29900:30000), 4] <- NA

plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 06:15:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)

plot(moos.stream.two.2021$DateTime, moos.stream.two.2021$WaterLevel, type = 'l')

```

## Raw rating curve for MOOS PT1
```{r, echo=FALSE, warning=FALSE}
### Filter MOOS ###
QSummary.MO.2021 <- QSummary.2021 %>% filter(Site =="MOOS")
### Filter Stuart ###
moos.stream.one.2021$Site <- "MOOS"

Moos1comb.2021 <- full_join(moos.stream.one.2021, QSummary.MO.2021)
MOOS1.lm.2021 <- lm(Moos1comb.2021$MeasuredQ_Ls ~ Moos1comb.2021$WaterLevel)

moos.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos1 all measured Q") 
``` 
High YSI pints will have to be removed 

### MOOS PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter MOOS ###
QSummary.MO.2021.1 <- QSummary.MO.2021[-c(2,3,4,6,11,13,15,17), ]

Moos1comb.2021 <- full_join(moos.stream.one.2021, QSummary.MO.2021.1)
MOOS1.lm.2021 <- lm(Moos1comb.2021$MeasuredQ_Ls ~ Moos1comb.2021$WaterLevel)

moos.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = moos.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos1 all measured Q") 

``` 
1) removed YSI points above 1000 Ls

## Raw rating curve for MOOS PT2
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021$Site <- "MOOS"

Moos2comb.2021 <- full_join(moos.stream.two.2021, QSummary.MO.2021)
MOOS2.lm.2021 <- lm(Moos2comb.2021$MeasuredQ_Ls ~ Moos2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos2 all measured Q")

``` 
Need to remove YSI's

### MOOS PT2
```{r, echo=FALSE, warning=FALSE}
moos.stream.two.2021$Site <- "MOOS"

Moos2comb.2021 <- full_join(moos.stream.two.2021, QSummary.MO.2021.1)
MOOS2.lm.2021 <- lm(Moos2comb.2021$MeasuredQ_Ls ~ Moos2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Moos2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = moos.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Moos2 all measured Q")

``` 
1) removed YSI points above 1000 Ls

### Predicted Q MOOS PT1
```{r, echo=FALSE, warning=FALSE}
Moos1comb.2021$pred.moos1.Q <- coef(MOOS1.lm.2021)[2] * Moos1comb.2021$WaterLevel+ coef(MOOS1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose1 predicted all measured Q") +
  scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("Date") +
  ylab("Discharge (L/s)") 

``` 
Not to shabby

### Predicted Q MOOS PT2
```{r, echo=FALSE, warning=FALSE}
Moos2comb.2021$pred.moos2.Q <- coef(MOOS2.lm.2021)[2] * Moos2comb.2021$WaterLevel+ coef(MOOS2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.moos2.Q), data = Moos2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Moose 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("") +
  ylab("Discharge(L/s)")

``` 
Nott too shabby

### Average predicted Q MOOS 
```{r, echo=FALSE, warning=FALSE}
moos.final.discharge.2021 <- full_join(Moos1comb.2021, Moos2comb.2021, by = "DateTime")
moos.final.discharge.2021$MeanDischarge <- rowMeans(moos.final.discharge.2021[,c("pred.moos1.Q", 'pred.moos2.Q')], na.rm = TRUE) # taking the average of the two PTs
moos.final.discharge.2021 <- moos.final.discharge.2021[,-c(1:4,6:13,15:26)] # remove unnecesary columns

# Moose1 (light blue) and Moose2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.moos1.Q), data = Moos1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.moos2.Q), data = Moos2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = moos.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 4000) +
  ggtitle("Moose1(light) & Moose2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

``` 
Looks good and red should be exported as a csv


### Raw French PT1
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 02:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.one.2021$DateTime, frch.stream.one.2021$WaterLevel, type = 'l')

```

It appears that I need to shift the July data up to what it looks like to the end of July and  take the out of water points associated with decommission out of data frame


### French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
frch.stream.one.2021 <- frch.stream.one.2021 %>% subset(frch.stream.one.2021$DateTime < "2021-09-27") #  removed on the 28th of september and it appears that there was some ice influence on the 28th 

frch.stream.one.2021[12958, 4] - frch.stream.one.2021[12957, 4] #0.568 is the difference 

frch.stream.one.2021.before <- frch.stream.one.2021[-c(12958:31008), ]
frch.stream.one.2021.after <- frch.stream.one.2021[-c(1:12957), ]
frch.stream.one.2021.before$WaterLevel <- frch.stream.one.2021.before[, 4] + 0.568

frch.stream.one.2021.final <- rbind(frch.stream.one.2021.before, frch.stream.one.2021.after)
plot(frch.stream.one.2021.final$DateTime, frch.stream.one.2021.final$WaterLevel, type = 'l')

frch.stream.one.2021 <- frch.stream.one.2021.final

plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 02:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.one.2021$DateTime, frch.stream.one.2021$WaterLevel, type = 'l')

```
1) removed out of water points associated with decommission 
2) shifted July data up to the rest of the data set due with cleaning 

### Raw French PT2
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 02:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2021$DateTime, frch.stream.two.2021$WaterLevel, type = 'l')

```

### French PT2 2.0 
```{r, echo=FALSE, warning=FALSE}
frch.stream.two.2021 <- frch.stream.two.2021 %>% subset(frch.stream.two.2021$DateTime < "2021-09-27") #  removed on the 28th of september and it appears that there was some ice influence on the 28th 

frch.stream.two.2021[c(12948, 17535,31360,31361), 4] <- NA


plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-28 02:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(frch.stream.two.2021$DateTime, frch.stream.two.2021$WaterLevel, type = 'l')

```
Not too shabby


### Raw Rating curveFrench PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
QSummary.FR.2021 <- QSummary.2021 %>% filter(Site =="FRCH")

### Rating curve for FRCH PT1 ###
frch.stream.one.2021$Site <- "FRCH"

Frch1comb.2021 <- full_join(frch.stream.one.2021, QSummary.FR.2021)
FRCH1.lm.2021 <- lm(Frch1comb.2021$MeasuredQ_Ls ~ Frch1comb.2021$WaterLevel)

frch.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch1 all measured Q") 

```
Maybe take out the top YSI point 

### Rating curve French PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
QSummary.FR.2021.1 <- QSummary.FR.2021[-c(1,16), ]


Frch1comb.2021 <- full_join(frch.stream.one.2021, QSummary.FR.2021.1)
FRCH1.lm.2021 <- lm(Frch1comb.2021$MeasuredQ_Ls ~ Frch1comb.2021$WaterLevel)

frch.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = frch.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch1 all measured Q") 

```
1) removed the top YSI points

### Raw Rating curve French PT2
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
frch.stream.two.2021$Site <- "FRCH"

Frch2comb.2021 <- full_join(frch.stream.two.2021, QSummary.FR.2021)
FRCH2.lm.2021 <- lm(Frch2comb.2021$MeasuredQ_Ls ~ Frch2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch2 all measured Q")


```

### Rating curve French PT2 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter FRCH ###
frch.stream.two.2021$Site <- "FRCH"

Frch2comb.2021 <- full_join(frch.stream.two.2021, QSummary.FR.2021.1)
FRCH2.lm.2021 <- lm(Frch2comb.2021$MeasuredQ_Ls ~ Frch2comb.2021$WaterLevel)

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Frch2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = frch.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Frch2 all measured Q")


```
1) removed the top YSI points


### Predicted Q FRCH PT1
```{r, echo=FALSE, warning=FALSE}
# PT1 #
Frch1comb.2021$pred.frch1.Q <- coef(FRCH1.lm.2021)[2] * Frch1comb.2021$WaterLevel+ coef(FRCH1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.frch1.Q), data = Frch1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("French1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 
```

### Predicted Q FRCH PT2
```{r, echo=FALSE, warning=FALSE}
Frch2comb.2021$pred.frch2.Q <- coef(FRCH2.lm.2021)[2] * Frch2comb.2021$WaterLevel+ coef(FRCH2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.frch2.Q), data = Frch2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("French 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylab("Discharge(L/s)")
```
Not too shabby

### Predicted Q FRCH PT2
```{r, echo=FALSE, warning=FALSE}
frch.final.discharge.2021 <- full_join(Frch1comb.2021, Frch2comb.2021, by = "DateTime")
frch.final.discharge.2021$MeanDischarge <- rowMeans(frch.final.discharge.2021[,c ("pred.frch1.Q", 'pred.frch2.Q')], na.rm = TRUE) # taking the average of the two PTs
frch.final.discharge.2021 <- frch.final.discharge.2021[,-c(1:4,6:13,15:26)] # remove unnecesary columns

# French1 (light blue) and French2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.frch1.Q), data = Frch1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.frch1.Q), data = Frch1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.frch2.Q), data = Frch2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = frch.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 1500) +
  ggtitle("French1(light) & French2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")
```
Red should be exported as a csv


### Raw Poker PT1
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2021$inst_rainfall_mm ~ POKE_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-06 09:00:00","2021-09-29 06:25:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.one.2021$DateTime, poke.stream.one.2021$WaterLevel, type = 'l')

```
2 beaver dams in July and one in the beginning of september....let the cleaning commence!


### Poker PT2 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.one.2021[c(5957:7397, 8261:9773,17247,23665:25616), 4] <- NA

plot(POKE_RainGauge_2021$inst_rainfall_mm ~ POKE_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-06 09:00:00","2021-09-29 06:25:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.one.2021$DateTime, poke.stream.one.2021$WaterLevel, type = 'l')

```
1) Removed beaver dam raise in water level in the beginning, middle of July and beginning of September
2) need to do NA_kalman
3) check the middle of August


### Raw Poker PT2
```{r, echo=FALSE, warning=FALSE}
plot(POKE_RainGauge_2021$inst_rainfall_mm ~ POKE_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-06 09:00:00","2021-09-29 06:20:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2021$DateTime, poke.stream.two.2021$WaterLevel, type = 'l')

```
Out of water point in June, beaver dams....let the cleaning commence!

### Poker PT2 2.0
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2021[c(3725, 5957:7175,7973:9145,17247,23733:25600), 4] <- NA

plot(POKE_RainGauge_2021$inst_rainfall_mm ~ POKE_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-06 09:00:00","2021-09-29 06:20:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(poke.stream.two.2021$DateTime, poke.stream.two.2021$WaterLevel, type = 'l')

```
1) Removed beaver dam raise in water level in the beginning, middle of July and beginning of September
2) need to do NA_kalman
3) check the middle of August


### Raw Rating curve Poker PT1
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
QSummary.PO.2021 <- QSummary.2021 %>% filter(Site =="POKE")

### Rating curve for POKE PT1 ###
poke.stream.one.2021$Site <- "POKE"

Poke1comb.2021 <- full_join(poke.stream.one.2021, QSummary.PO.2021)
POKE1.lm.2021 <- lm(Poke1comb.2021$MeasuredQ_Ls ~ Poke1comb.2021$WaterLevel)


poke.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poke1 all measured Q") 

```
Will remove high YSI


### Rating curve Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
QSummary.PO.2021.1 <- QSummary.PO.2021[-c(1,2,11,24), ]


Poke1comb.2021 <- full_join(poke.stream.one.2021, QSummary.PO.2021.1)
POKE1.lm.2021 <- lm(Poke1comb.2021$MeasuredQ_Ls ~ Poke1comb.2021$WaterLevel)


poke.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = poke.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poke1 all measured Q") 


```
1) Removed highest YSI and 
2) Removed lowest Wading rods 

### Raw Rating curve Poker PT2
```{r, echo=FALSE, warning=FALSE}
poke.stream.two.2021$Site <- "POKE"

Poke2comb.2021 <- full_join(poke.stream.two.2021, QSummary.PO.2021)
POKE2.lm.2021 <- lm(Poke2comb.2021$MeasuredQ_Ls ~ Poke2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poker2 all measured Q")
```
will remove highest YSI and lowest wading rods 

### Rating curve Poker PT1 2.0
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###

Poke2comb.2021 <- full_join(poke.stream.two.2021, QSummary.PO.2021.1)
POKE2.lm.2021 <- lm(Poke2comb.2021$MeasuredQ_Ls ~ Poke2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Poke2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_light() +
  ggtitle("Poker2 all measured Q")


```
1) Removed highest YSI and 
2) Removed lowest Wading rods 



### Predicted Q for POKE PT1 
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
Poke1comb.2021$pred.poke1.Q <- coef(POKE1.lm.2021)[2] * Poke1comb.2021$WaterLevel+ coef(POKE1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 

```
Not the prettiest thing I have ever seen 


### Predicted Q for POKE PT2
```{r, echo=FALSE, warning=FALSE}
### Filter Poker ###
Poke2comb.2021$pred.poke2.Q <- coef(POKE2.lm.2021)[2] * Poke2comb.2021$WaterLevel+ coef(POKE2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Poker") +
  scale_shape_discrete(name = "Method", labels = c("Wading Rod", "Salt Dilution", "")) +
  xlab("") +
  ylim(0, 1500) +
  ylab("Discharge(L/s)")

```
Looks better then PT1...snowmelt signature looks good 


### Average Q for POKE 
```{r, echo=FALSE, warning=FALSE}

poke.final.discharge.2021 <- full_join(Poke1comb.2021, Poke2comb.2021, by = "DateTime")
poke.final.discharge.2021$MeanDischarge <- rowMeans(poke.final.discharge.2021[,c ("pred.poke1.Q", 'pred.poke2.Q')], na.rm = TRUE) # taking the average of the two PTs
poke.final.discharge.2021 <- poke.final.discharge.2021[,-c(1:4,6:13,15:26)] # remove unnecesary columns
poke.final.discharge.2021 <- poke.final.discharge.2021[-c(30574:31598) , ] # Removing duplicate date values 

# Poker1 (light blue) and Poker2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.poke1.Q), data = Poke1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.poke2.Q), data = Poke2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = poke.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 1500) +
  ggtitle("Poker1(light) & Poker2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")

```
I think I should clip off the beginning of PT1 as the snowmelt signature makes more sense in PT2...what do you think?


### Raw Vault PT1
```{r, echo=FALSE, warning=FALSE}
plot(VAUL_RainGauge_2021$inst_rainfall_mm ~ VAUL_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-10 09:00:00","2021-09-27 08:10:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.one.2021$DateTime, vaul.stream.one.2021$WaterLevel, type = 'l')

```

Need to remove vertical bars associated with out of water points such as the beginning and the end of the dataframe 


### Vault PT1 2.0 
```{r, echo=FALSE, warning=FALSE}
vaul.stream.one.2021[c(4777:4994, 16861, 30756:30759), 4] <- NA
plot(VAUL_RainGauge_2021$inst_rainfall_mm ~ VAUL_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-10 09:00:00","2021-09-27 08:10:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(vaul.stream.one.2021$DateTime, vaul.stream.one.2021$WaterLevel, type = 'l')

```
1) Removed vertical bars errant points in the beginning of the dataframe as well the middle of the first big storm and the end of the dataframe 


### Raw VAUL rating curve 
```{r, echo=FALSE, warning=FALSE}
### Filter VAUL ###
QSummary.VA.2021 <- QSummary.2021 %>% filter(Site =="VAUL")

### Rating curve for VAUL PT1 ###
vaul.stream.one.2021$Site <- "VAUL"

Vaul1comb.2021 <- full_join(vaul.stream.one.2021, QSummary.VA.2021)
VAUL1.lm.2021 <- lm(Vaul1comb.2021$MeasuredQ_Ls ~ Vaul1comb.2021$WaterLevel)

vaul.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Vaul1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = vaul.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Vaul1 all measured Q") 

```
Best raw one yet!

### Predicted Q for VAUL
```{r, echo=FALSE, warning=FALSE}
Vaul1comb.2021$pred.vaul1.Q <- coef(VAUL1.lm.2021)[2] * Vaul1comb.2021$WaterLevel+ coef(VAUL1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.vaul1.Q), data = Vaul1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Vaul1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 

```
Not too shabby

### Raw STRT PT1
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-30 06:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.one.2021$DateTime, strt.stream.one.2021$WaterLevel, type = 'l')

```
Need to shift beginning of dataframe up and remove beaverr dam in July...remove errant vertical bars 


### STRT PT1 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.one.2021[5261, 4] - strt.stream.one.2021[5257, 4] # 0.543

strt.stream.one.2021.after <- strt.stream.one.2021[-c(1:5260), ]
strt.stream.one.2021.before <- strt.stream.one.2021[-c(5258:32362), ]
strt.stream.one.2021.before$WaterLevel <- strt.stream.one.2021.before[, 4] + 0.543

strt.stream.one.2021.final <- rbind(strt.stream.one.2021.before, strt.stream.one.2021.after)
plot(strt.stream.one.2021.final$DateTime, strt.stream.one.2021.final$WaterLevel, type = 'l')

strt.stream.one.2021 <- strt.stream.one.2021.final

strt.stream.one.2021[c(910:923, 5923:10458, 11837:13900, 17342, 31626:31634), 4] <- NA
strt.stream.one.2021[17339, 4] <- NA

plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-30 06:30:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.one.2021$DateTime, strt.stream.one.2021$WaterLevel, type = "l")

```
1) Removed errant vertical bar points
2)Removed beaver dam raises in Water level 
Quick snowmelt period and then not a lot of waterlevel change in June. 

### Raw STRT PT2
```{r, echo=FALSE, warning=FALSE}
plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-30 06:35:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2021$DateTime, strt.stream.two.2021$WaterLevel, type = 'l')

```

### STRT PT2 2.0
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2021[c(5257:10460, 12997:13911, 17349:17380), 4] <- NA
strt.stream.two.2021[c(10461:17381), 4] <- strt.stream.two.2021[c(10461:17381), 4] + 0.407

plot(STRT_RainGauge_2021$inst_rainfall_mm ~ STRT_RainGauge_2021$DateTime, type="h",
     xlim = as.POSIXct(c("2021-05-04 09:00:00","2021-09-30 06:35:00"), tz="America/Anchorage"),
     ylim = c(20,0), 
     axes=F, xlab="", ylab="")
par(new = T)
plot(strt.stream.two.2021$DateTime, strt.stream.two.2021$WaterLevel, type = "l")

```
1) removed beaver dams
2) removed errant vertical bars
3) shifted middle of july to middle of August 



### Raw STRT rating curve 
```{r, echo=FALSE, warning=FALSE}
### Filter STRT ###
QSummary.ST.2021 <- QSummary.2021 %>% filter(Site =="STRT")

### Rating curve for STRT PT1 ###
strt.stream.one.2021$Site <- "STRT"

Strt1comb.2021 <- full_join(strt.stream.one.2021, QSummary.ST.2021)
STRT1.lm.2021 <- lm(Strt1comb.2021$MeasuredQ_Ls ~ Strt1comb.2021$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q") 

```










### STRT rating curve 2.0 
```{r, echo=FALSE, warning=FALSE}
### Filter STRT ###
QSummary.ST.2021.1 <- QSummary.ST.2021[-c(1,2,3,14,17,22),]

Strt1comb.2021 <- full_join(strt.stream.one.2021, QSummary.ST.2021.1)
STRT1.lm.2021 <- lm(Strt1comb.2021$MeasuredQ_Ls ~ Strt1comb.2021$WaterLevel)

strt.formula <- y ~ x

ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt1comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE, formula = strt.formula) +
  stat_poly_eq(formula = poke.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Strt1 all measured Q") 

```
1) Removed highest and lowest YSIs


### Raw STRT rating curve PT2
```{r, echo=FALSE, warning=FALSE}
strt.stream.two.2021$Site <- "STRT"

Strt2comb.2021 <- full_join(strt.stream.two.2021, QSummary.ST.2021)
STRT2.lm.2021 <- lm(Strt2comb.2021$MeasuredQ_Ls ~ Strt2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```


### STRT rating curve PT2 2.0
```{r, echo=FALSE, warning=FALSE}

Strt2comb.2021 <- full_join(strt.stream.two.2021, QSummary.ST.2021.1)
STRT2.lm.2021 <- lm(Strt2comb.2021$MeasuredQ_Ls ~ Strt2comb.2021$WaterLevel)


ggplot(aes(x = WaterLevel, y = MeasuredQ_Ls), data = Strt2comb.2021) +
  geom_point(aes(color = Method), size = 3) +
  geom_smooth(method = "lm", se=FALSE) +
  stat_poly_eq(formula = strt.formula, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  theme_classic() +
  ggtitle("Stuart2 all measured Q")

```
1)Removed lowest and highest YSIs
Not as good as PT1


### Predicted Q STRT PT1
```{r, echo=FALSE, warning=FALSE}
Strt1comb.2021$pred.strt1.Q <- coef(STRT1.lm.2021)[2] * Strt1comb.2021$WaterLevel+ coef(STRT1.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart1 predicted all measured Q") +
  xlab("Date") +
  ylab("Discharge (L/s)") 
```
Icky

### Predicted Q STRT PT2
```{r, echo=FALSE, warning=FALSE}
Strt2comb.2021$pred.strt2.Q <- coef(STRT2.lm.2021)[2] * Strt2comb.2021$WaterLevel+ coef(STRT2.lm.2021)[1]
ggplot(aes(x = DateTime, y = pred.strt2.Q), data = Strt2comb.2021) +
  geom_line(color="#A6CEE3", size=1.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls, shape = Method), size=3) +
  theme_classic() +
  ggtitle("Stuart 2 Predicted Q") +
  scale_shape_discrete(name = "Method", labels = c("ADCP", "Wading Rod", "Salt Dilution")) +
  xlab("") +
  ylim(0, 2000) +
  ylab("Discharge(L/s)")
```
Icky

### Average Q for STRT
```{r, echo=FALSE, warning=FALSE}
strt.final.discharge.2021 <- full_join(Strt1comb.2021, Strt2comb.2021, by = "DateTime")
strt.final.discharge.2021$MeanDischarge <- rowMeans(strt.final.discharge.2021[,c ("pred.strt1.Q", 'pred.strt2.Q')], na.rm = TRUE) # taking the average of the two PTs
strt.final.discharge.2021 <- strt.final.discharge.2021[,-c(1:4,6:13,15:26)] # remove unnecesary columns


# Stuart1 (light blue) and Stuart2 (dark blue) with observed Q.
ggplot(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2021) +
  geom_line(aes(x = DateTime, y = pred.strt1.Q), data = Strt1comb.2021, color="#A6CEE3", size=1.25) +
  geom_line(aes(x = DateTime, y = pred.strt2.Q), data = Strt2comb.2021,color="#1F78B4", size=1.25, alpha = 0.75) +
  geom_line(aes(x = DateTime, y = MeanDischarge), data = strt.final.discharge.2021, color = "red", size = 1.25, alpha = 0.25) +
  geom_point(aes(x = DateTime, y = MeasuredQ_Ls), size=2) +
  theme_classic() +
  ylim(0, 3000) +
  ggtitle("STRT1(light) & STRT2(dark) predicted all measured Q") +
  ylab("Predicted discharge L/s") +
  xlab("Time")
```
ICKY


